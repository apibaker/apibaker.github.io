!function e(t,n,r){function i(a,s){if(!n[a]){if(!t[a]){var p="function"==typeof require&&require;if(!s&&p)return p(a,!0);if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){var n=t[a][1][e];return i(n||e)},l,l.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(e,t,n){!function(){"use strict";var e,n={name:"doT",version:"1.1.1",templateSettings:{evaluate:/\{\{([\s\S]+?(\}?)+)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,encode:/\{\{!([\s\S]+?)\}\}/g,use:/\{\{#([\s\S]+?)\}\}/g,useParams:/(^|[^\w$])def(?:\.|\[[\'\"])([\w$\.]+)(?:[\'\"]\])?\s*\:\s*([\w$\.]+|\"[^\"]+\"|\'[^\']+\'|\{[^\}]+\})/g,define:/\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,defineParams:/^\s*([\w$]+):([\s\S]+)/,conditional:/\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,iterate:/\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,varname:"it",strip:!0,append:!0,selfcontained:!1,doNotSkipEncoded:!1},template:void 0,compile:void 0,log:!0};n.encodeHTMLSource=function(e){var t={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},n=e?/[&<>"'\/]/g:/&(?!#?\w+;)|<|>|"|'|\//g;return function(e){return e?e.toString().replace(n,function(e){return t[e]||e}):""}},e=function(){return this||(0,eval)("this")}(),void 0!==t&&t.exports?t.exports=n:"function"==typeof define&&define.amd?define(function(){return n}):e.doT=n;var r={append:{start:"'+(",end:")+'",startencode:"'+encodeHTML("},split:{start:"';out+=(",end:");out+='",startencode:"';out+=encodeHTML("}},i=/$^/;function o(e){return e.replace(/\\('|\\)/g,"$1").replace(/[\r\t\n]/g," ")}n.template=function(t,a,s){var p,l,d=(a=a||n.templateSettings).append?r.append:r.split,u=0,f=a.use||a.define?function e(t,n,r){return("string"==typeof n?n:n.toString()).replace(t.define||i,function(e,n,i,o){return 0===n.indexOf("def.")&&(n=n.substring(4)),n in r||(":"===i?(t.defineParams&&o.replace(t.defineParams,function(e,t,i){r[n]={arg:t,text:i}}),n in r||(r[n]=o)):new Function("def","def['"+n+"']="+o)(r)),""}).replace(t.use||i,function(n,i){t.useParams&&(i=i.replace(t.useParams,function(e,t,n,i){if(r[n]&&r[n].arg&&i){var o=(n+":"+i).replace(/'|\\/g,"_");return r.__exp=r.__exp||{},r.__exp[o]=r[n].text.replace(new RegExp("(^|[^\\w$])"+r[n].arg+"([^\\w$])","g"),"$1"+i+"$2"),t+"def.__exp['"+o+"']"}}));var o=new Function("def","return "+i)(r);return o?e(t,o,r):o})}(a,t,s||{}):t;f=("var out='"+(a.strip?f.replace(/(^|\r|\n)\t* +| +\t*(\r|\n|$)/g," ").replace(/\r|\n|\t|\/\*[\s\S]*?\*\//g,""):f).replace(/'|\\/g,"\\$&").replace(a.interpolate||i,function(e,t){return d.start+o(t)+d.end}).replace(a.encode||i,function(e,t){return p=!0,d.startencode+o(t)+d.end}).replace(a.conditional||i,function(e,t,n){return t?n?"';}else if("+o(n)+"){out+='":"';}else{out+='":n?"';if("+o(n)+"){out+='":"';}out+='"}).replace(a.iterate||i,function(e,t,n,r){return t?(u+=1,l=r||"i"+u,t=o(t),"';var arr"+u+"="+t+";if(arr"+u+"){var "+n+","+l+"=-1,l"+u+"=arr"+u+".length-1;while("+l+"<l"+u+"){"+n+"=arr"+u+"["+l+"+=1];out+='"):"';} } out+='"}).replace(a.evaluate||i,function(e,t){return"';"+o(t)+"out+='"})+"';return out;").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/(\s|;|\}|^|\{)out\+='';/g,"$1").replace(/\+''/g,""),p&&(a.selfcontained||!e||e._encodeHTML||(e._encodeHTML=n.encodeHTMLSource(a.doNotSkipEncoded)),f="var encodeHTML = typeof _encodeHTML !== 'undefined' ? _encodeHTML : ("+n.encodeHTMLSource.toString()+"("+(a.doNotSkipEncoded||"")+"));"+f);try{return new Function(a.varname,f)}catch(e){throw"undefined"!=typeof console&&console.log("Could not create a template function: "+f),e}},n.compile=function(e,t){return n.template(e,null,t)}}()},{}],2:[function(require,module,exports){"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},REQ_TYPE_MAP={Create:"POST",AddReference:"POST",Delete:"POST",RemoveReference:"POST",Read:"GET",Count:"POST",Exist:"POST",Query:"POST",QueryRef:"POST",CountRef:"POST",ExistRef:"POST",QueryRefCandidate:"POST",CountRefCandidate:"POST",ExistRefCandidate:"POST",Update:"POST",QueryById:"GET"};function prepareInput(e,t,n,r){var i={};return i.obj=e.obj||{},e.from&&(i.from=e.from),e.size&&(i.size=e.size),"QueryRef"==t||"CountRef"==t||"ExistRef"==t||"QueryRefCandidate"==t||"CountRefCandidate"==t||"ExistRefCandidate"==t?i.obj[r+"Id"]=e.id||0:"Query"==t&&e.id?i.obj[n+"Id_1"]=e.id||0:i.obj[n+"Id"]=e.id||0,i}function CP_UTIL_Json2map(e,t,n){for(var r in t=t||{},e){var i=e[r];if(Array.isArray(i))for(var o=new Array,a=i.length,s=0;s<a;s++){var p={};CP_UTIL_Json2map(i[s],p,null),o.push(p),t[null!=n?n+r:r]=o}else"object"===(void 0===i?"undefined":_typeof(i))?CP_UTIL_Json2map(i,t,null!=n?n+r+",":r+","):t[null!=n?n+r:r]=e[r]}return t}var execAction=function execAction(input,DBCmd,succ,err,dbAdapter,conn,before,after){var ctx={input:input,cmd:DBCmd,conn:conn,adapter:dbAdapter};if(before)try{before(input.obj,ctx)}catch(e){err(e)}for(var inMap=CP_UTIL_Json2map(input.obj),out={},sqlArg=new Array,i=0;i<DBCmd.length;i++){var DBCmdObj=DBCmd[i],cmd=DBCmdObj.cmd;if(cmd){var results=DBCmdObj.outResult,params=DBCmdObj.inParam;if(DBCmdObj.inRefKeys&&DBCmdObj.inMultiple){var objs=inMap[DBCmdObj.inRefKeys];if(objs)for(var size=objs.length,j=0;j<size;j++){var sqlparamfunc=null;DBCmdObj.inParam&&(sqlparamfunc=function(e,t,n){return function(){for(var r=[],i=0;i<t.length;i++)-1==t[i]?r.push(null):n[i]?r.push(setSQLParam([t[i]],e)[i]):n[i]||r.push(setSQLParam([t[i]],inMap)[i]);return r}}(objs[j],params,DBCmdObj.inParamRefe));var resultfunc=null;DBCmdObj.outResult&&(resultfunc=function(e,t){}),sqlArg.push({sql:cmd,params:sqlparamfunc,result:resultfunc})}}else{if(DBCmdObj.checkExist&&!inMap[DBCmdObj.checkExist])continue;var sqlparamfunc=function(e){return function(){return setSQLParam(e,inMap)}}(params),resultfunc=function(){};if(DBCmdObj.outInsertId)resultfunc=function(e,t){return function(n,r){setSQLResult(n,r,-1,e,t,!0,inMap)}}(results,out);else if(DBCmdObj.outMultiple){if(DBCmdObj.inSize){var sizeVal=input.size?parseInt(input.size):DBCmdObj.inPageSize;isNaN(sizeVal)||(sizeVal=Math.min(sizeVal,DBCmdObj.inPageSize),cmd=cmd.replace(/%SIZE%/,sizeVal),sizeVal&&(out.size=sizeVal))}if(DBCmdObj.inFrom){var fromVal=input.from?parseInt(input.from):0;cmd=cmd.replace(/%FROM%/,fromVal),isNaN(fromVal)||void 0===fromVal||0==fromVal||(out.from=fromVal)}resultfunc=DBCmdObj.outRefName?function(e,t,n){return function(n,r){for(var i=new Array,o=0;o<r.rows.length;o++){var a={};i.push(a),setSQLResult(n,r,o,e,a)}t.refName=i}}(results,out,DBCmdObj.outRefName):DBCmdObj.outQuery?function(e,t){return function(n,r){for(var i=new Array,o=0;o<r.rows.length;o++){var a={};i.push(a),setSQLResult(n,r,o,e,a,!1,null,!0)}i.length>0&&(t.data=i)}}(results,out):function(e,t){return function(n,r){for(var i=0;i<r.rows.length;i++)setSQLResult(n,r,i,e,t)}}(results,out)}else DBCmdObj.outCount?resultfunc=function(results,out){return function(tx,result){var size=0;result.rows.length>0&&(size=eval(result.rows.item(0).CNT)),out.count=size,0==size&&(out.data=[])}}(results,out):DBCmdObj.outCheckInUse&&(resultfunc=function(e,t,n){return function(e,t){if(t.rows.length>0&&t.rows.item(0)[n])try{throw"Data is in use!"}catch(e){err(e)}}}(0,0,DBCmdObj.outCheckPropName));sqlArg.push({sql:cmd,params:sqlparamfunc,result:resultfunc})}}}var succcallback=function(e){try{after&&after(e,ctx),succ(e)}catch(e){errorLog(e),err(e)}};dbAdapter.execSql(conn,sqlArg,out,succcallback,err)};function setSQLParam(params,map){for(var sqlparam=new Array,i=0;i<params.length;i++){var idx=params[i][0]-1,type=params[i][1],key=params[i][2],opt=params[i][3],cndIdx=null;void 0!==params[i][4]&&null!=eval(params[i][4])&&-1!=params[i][4]&&(cndIdx=params[i][4],key=key+"_"+cndIdx,key=key.replace(/\,/g,"_"));var pval=map[key];null!=key||"Id"!=type&&"Long"!=type?-1!=["String","Text"].indexOf(type)||""!==pval?"Start-With"===opt?sqlparam[idx]=pval+"%":"End-With"===opt?sqlparam[idx]="%"+pval:"Contains"===opt?sqlparam[idx]="%"+pval+"%":(sqlparam[idx]=pval,void 0===sqlparam[idx]||""===sqlparam[idx]?sqlparam[idx]=null:-1!=["Integer","Long","Id"].indexOf(type)?sqlparam[idx]=parseInt(sqlparam[idx]):-1!=["Double","Float","Decimal"].indexOf(type)?sqlparam[idx]=parseFloat(sqlparam[idx]):-1!=["Boolean"].indexOf(type)&&("true"==String(sqlparam[idx])?sqlparam[idx]=1:sqlparam[idx]=0)):sqlparam[idx]=null:sqlparam[idx]=null}return sqlparam}function setSQLResult(e,t,n,r,i,o,a,s){for(var p=0;p<r.length;p++){r[p][0];var l=r[p][1],d=r[p][2],u=r[p][3],f=null;if(r[p][4])f=u.toUpperCase(),d=s?u:d;else if(f=u.toUpperCase(),-1!=d.indexOf(",")){var g=d.split(",");f=g[g.length-1].toUpperCase()}if(o)i[d]=t.insertIdFunc(),a[d]=t.insertIdFunc();else if("Boolean"===l){if(null!=t.rows.item(n)[f]&&void 0!==t.rows.item(n)[f]){var h="",c=t.rows.item(n)[f];h=1==c||"TRUE"==String(c).toUpperCase(),i[d]=h}}else-1!=["Integer","Long","Id","Short"].indexOf(l)?null!=t.rows.item(n)[f]&&void 0!==t.rows.item(n)[f]&&"NaN"!=t.rows.item(n)[f]&&(i[d]=parseInt(t.rows.item(n)[f])):-1!=["Double","Float","Decimal"].indexOf(l)?null!=t.rows.item(n)[f]&&void 0!==t.rows.item(n)[f]&&"NaN"!=t.rows.item(n)[f]&&(i[d]=parseFloat(t.rows.item(n)[f])):null!=t.rows.item(n)[f]&&void 0!==t.rows.item(n)[f]&&(i[d]=String(t.rows.item(n)[f]))}}function runTest(e,t,n,r,i){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{},p=t.ActDef[e[o].action],l=p.model,d=(l.Name,l.Type),u=l.Entity,f=p.refeDef?p.refeDef.entDef.name:null,g=prepareInput(e[o].in,d,u,f||null),h=(new Date).getTime();s.tests=s.tests||[],debuglog(t.Runtime[e[o].action]),execAction(g,t.Runtime[e[o].action],function(p){if(JSON.stringify(e[o].out)===JSON.stringify(p)){debuglog(JSON.stringify(p));var l=(new Date).getTime();a+=l-h,infolog(r.name+" "+t.raw.name+"/"+e[o].action+"/"+o+" done! "+(l-h)/1e3+" sec"),s.tests.push({test:t.raw.name,idx:o,action:e[o].action,elapse:l-h,succ:!0,expected:e[o].out,actual:p}),o+1<e.length?runTest(e,t,n,r,i,o+1,a,s):(infolog(r.name+" "+t.raw.name+" done! "+a/1e3+" sec"),s.all={test:t.raw.name,elapse:a,succ:!0},i&&i(s))}else errlog(t.raw.name+"["+o+"]. expected:"+JSON.stringify(e[o].out)+"\n but:"+JSON.stringify(p)),s.tests.push({test:t.raw.name,idx:o,action:e[o].action,elapse:l-h,succ:!1,expected:e[o].out,actual:p}),s.all={test:t.raw.name,elapse:a,succ:!1},i&&i(s)},function(e){errlog(e)},r,n)}var DEBUG=!1;function debuglog(e){DEBUG&&console.log(e)}function infolog(e){console.log(e)}function errlog(e){console.error(e)}void 0!==module&&void 0!==module.exports&&(module.exports={execAction:execAction,prepareInput:prepareInput,runTest:runTest})},{}],3:[function(e,t,n){"use strict";var r=e("./defs.js").AppDef,i=e("./stringbuffer.js"),o=e("./arrayiterator.js"),a=e("./hashmap.js"),s=e("./nodedef.js"),p=s.AbstractEntDefNodeListBuilder,l=s.AbstractRefDefNodeListBuilder,d=s.FieldNodeList,u=(s.RefeNode,s.PropNode),f=e("./appruntime_update.js"),g=e("./appruntime_query.js"),h=e("./sqlutil.js");function c(){p.call(this)}function m(){l.call(this)}function y(){p.call(this)}function N(){l.call(this)}function S(e,t){this.sqlMap=e,this.model=t,this.appDef=new r(this.model),this.updatesql=f(e,t),this.querysql=g(e,t)}c.prototype=new p,c.prototype.constructor=c,c.prototype.requiredProp=function(e,t,n){return t.isPK(n)},c.prototype.updatePropNode=function(e,t,n){n.toBeCondition=!0},m.prototype=new l,m.prototype.constructor=m,m.prototype.requiredProp=function(e,t,n,r){return e.isPK(t)},m.prototype.requiredRefe=function(e,t,n){if(n)if(t.isOne2()){if(t.is2One()){if(t.isFK()&&!t.isAnce())return!0;if(t.isInvFK()&&t.isBi())return!0;if(t.isDesc()&&!t.isDescDeletable()&&t.getForeignEnt().getName()!=e.getName())return!0}else if(t.is2Many()){if(t.isLT()&&!t.isBi())return!0;if(t.isInvFK()&&t.isBi())return!0;if(t.isDesc()&&!t.isDescDeletable()&&t.getForeignEnt().getName()!=e.getName())return!0}}else if(t.isMany2())if(t.is2One()){if(t.isFK()&&!t.isAnce())return!0}else if(t.is2Many()&&t.isLT()&&!t.isBi())return!0;return!1},m.prototype.updatePropNode=function(e,t,n,r){t.toBeCondition=!0},m.prototype.updateRefeNode=function(e,t,n){var r=t.getRefeDef();n&&(r.isOne2()?r.is2One()?r.isFK()?t.toBeJoined=!0:r.isInvFK()&&r.isBi()?(t.toBeRestricted=!0,t.toBeJoined=!0):r.isDesc()&&!r.isDescDeletable()&&r.getForeignEnt().getName()!=e.getName()&&(t.toBeJoined=!0):r.is2Many()&&(r.isLT()&&!r.isBi()?(t.toBeRestricted=!0,t.toBeJoined=!0):r.isInvFK()&&r.isBi()?t.toBeJoined=!0:r.isDesc()&&!r.isDescDeletable()&&r.getForeignEnt().getName()!=e.getName()&&(t.toBeJoined=!0)):r.isMany2()?r.is2One()?r.isFK()&&!r.isAnce()&&(t.toBeJoined=!0):r.is2Many()&&r.isLT()&&!r.isBi()&&(t.toBeRestricted=!0,t.toBeJoined=!0):r.isInherit()&&(t.toBeRestricted=!0,t.toBeJoined=!0));var i=null;n?(i=t.getRefeDef().getRefOwnerEnt(),t.setInverse(!0)):(i=t.getRefeDef().getForeignEnt(),t.setInverse(!1));var o=new d;t.setChildren(o),(new y).buildNodeList(o,i)},y.prototype=new p,y.prototype.constructor=y,y.prototype.requiredProp=function(e,t,n){return t.isPK(n)},y.prototype.updatePropNode=function(e,t,n){n.toBeSelected=!0},N.prototype=new l,N.prototype.constructor=N,N.prototype.requiredProp=function(e,t,n,r){return e.isPK(t)},N.prototype.requiredRefe=function(e,t,n){if(n){if(t.isOne2()){if(t.is2One()){if(t.isFK()&&t.isAnce())return!0;if(t.isLT())return!0;if(t.isInvFK()&&!t.isDesc())return!0}else if(t.is2Many()&&t.isLT()&&t.isBi())return!0}else if(t.isMany2())if(t.is2One()){if(t.isFK()){if(t.isBi()||t.isAnce())return!0}else if(t.isLT()&&t.isBi())return!0}else if(t.is2Many()&&t.isLT()&&t.isBi())return!0}else if(t.is2One()){if(t.isOne2()){if(t.isInvFK())return!0;if(t.isLT())return!0}else if(t.isMany2()&&t.isLT()&&t.isBi())return!0}else if(t.is2Many())if(t.isOne2()){if(t.isInvFK())return!0;if(t.isLT())return!0}else if(t.isMany2())return!0;return!1},N.prototype.updatePropNode=function(e,t,n,r){r?n.isOne2()?n.is2One()?n.isFK()&&n.isAnce()?t.toBeCondition=!0:n.isFK()&&n.isExtend()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isInvFK()||n.isLT()&&(t.toBeCondition=!0):n.is2Many()&&(n.isInvFK()||n.isLT()&&(t.toBeCondition=!0)):n.isMany2()&&(n.is2One()?n.isFK()?n.isBi()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isAnce()&&(t.toBeCondition=!0):n.isLT()&&n.isBi()&&(t.toBeCondition=!0):n.is2Many()&&(t.toBeCondition=!0)):n.is2One()?n.isOne2()?n.isInvFK()?n.isDesc()&&n.isDescDeletable()?t.toBeCondition=!0:(t.toBeUpdated=!0,t.toBeCondition=!0):n.isLT()&&(t.toBeCondition=!0):n.isMany2()&&n.isLT()&&n.isBi()&&(t.toBeCondition=!0):n.is2Many()&&(n.isOne2()?n.isInvFK()?n.isDesc()&&n.isDescDeletable()?t.toBeCondition=!0:(t.toBeUpdated=!0,t.toBeCondition=!0):n.isLT()&&(t.toBeCondition=!0):n.isMany2()&&(t.toBeCondition=!0))},N.prototype.updateRefeNode=function(e,t,n){var r=t.getRefeDef();n?r.isOne2()?r.is2One()?r.isFK()?t.toBeJoined=!0:r.isLT()?t.toBeJoined=!0:r.isInvFK()&&(t.toBeJoined=!0):r.is2Many()&&r.isLT()&&(t.toBeJoined=!0):r.isMany2()&&(r.is2One()?r.isFK()?(r.isBi()||r.isAnce())&&(t.toBeJoined=!0):r.isLT()&&r.isBi()&&(t.toBeJoined=!0):r.is2Many()&&r.isLT()&&r.isBi()&&(t.toBeJoined=!0)):r.is2One()?r.isOne2()?r.isDesc()&&!r.isDescDeletable()?t.toBeDeleted=!0:r.isInvFK()?t.toBeJoined=!0:r.isLT()&&(t.toBeJoined=!0):r.isMany2()&&r.is2One()&&r.isLT()&&r.isBi()&&(t.toBeJoined=!0):r.is2Many()&&(r.isDesc()&&!r.isDescDeletable()?t.toBeDeleted=!0:r.isInvFK()?t.toBeJoined=!0:r.isLT()&&(t.toBeJoined=!0))},S.prototype.generateDeleteObjSQL=function(e){o.enableIterator();var t=[],n=new d,r=e.entDef;(new c).buildNodeList(n,r);for(var i=(new m).buildNodeList(r).iterator();i.hasNext();){var a=i.next();if(null!=(p=a.getMainRefNode())&&p.toBeJoined){var s=this.processCheckIfRefInUse(a,e);t=t.concat(s)}}for(i=(new N).buildNodeList(r).iterator();i.hasNext();){var p,l=i.next();if(null!=(p=l.getMainRefNode())&&p.toBeJoined){var u=this.processDeleteRef(l,e);t=t.concat(u)}else if(null!=p&&p.toBeDeleted){var f=p.getRefeDef(),g=p.isInverse(),h=g?f.getInvName():f.getName(),y=new ActionDef({Type:"Read",Field:[h]},r,e.appDef);s=this.generateReadObjSQL(y);t=t.concat(t,s);var S=g?f.getRefOwnerEnt():f.getForeignEnt(),T=new ActionDef({Type:"Delete"},S,e.appDef),R=this.generateDeleteObjSQL(T);t=t.concat(R)}}return t.push(this.processDelete(n,e)),o.disableIterator(),t},S.prototype.processCheckIfRefInUse=function(e,t){var n=[],r=this.processReadRef(e.getMainRefNode(),e,t);return n.push({SQL:r.SQL,Param:r.Param,Res:r.Res,SQLType:"QUERY",FUNCType:"CHECKINUSE"}),n},S.prototype.processDeleteRef=function(e,t){return{SQL:this.updatesql.toUpdateSQL(e,t),Param:this.updatesql.setUpdateSQLParam(e,t),SQLType:"UPDATE",FUNCType:"UPDATEREFTONULL"}},S.prototype.processDelete=function(e,t){var n=this.toDeleteSQL(e,t),r=null;return t.conditions&&t.conditions.length>0?(r=[],this.setQuerySQLParam(t.conditions,r,null,0)):r=this.setDeleteSQLParam(e,t),{SQL:n,Param:r,SQLType:"UPDATE",FUNCType:"DELETE"}},S.prototype.toDeleteSQL=function(e,t){var n=new i,r=new i,o=t.entDef;r.append(o.getStorageName());var s=new i;if(0==t.conditions.length)for(var p=e.iterator();p.hasNext();){var l=p.next();if(l instanceof u){var d=l,f=d.getPropDef();d.toBeCondition&&(0!=s.length()&&s.append(this.sqlMap.getSQLAnd()),s.append(f.getStorageName()),s.append("=?"))}}else{var g=new i,h=new a,c=new a,m=new a,y=new i;this.querysql.toWhereSQL(g,s,y,t.conditions,h,c,m,!0)}return n.append(this.sqlMap.getSQLDelete()),n.append(r),n.append(this.sqlMap.getSQLWhere()),n.append(s),n.toString()},S.prototype.setDeleteSQLParam=function(e,t){for(var n=e.iterator(),r=0,i=[];n.hasNext();){if((f=n.next())instanceof u){var o=(c=f).getPropDef();c.toBeUpdated&&(r++,i.push(h.setSQLParam(o,null,!1,null,null,r,null)))}else if(f instanceof RefNode&&f.toBeJoined){var a=(g=f).getRefeDef();if(g.isInverse()&&!a.isInvFK()&&!a.isBi())continue;if(null==g.getChildren())continue;for(var s=g.getRefeDef(),p=g.isInverse(),l=g.getChildren().iterator();l.hasNext();){var d=l.next();if(g.isOne()){if(d instanceof u){o=(c=d).getPropDef();c.toBeUpdated&&(r++,i.push(h.setSQLParam(o,s,p,null,null,r,null)))}}else if(g.isMany()&&d instanceof u&&d.toBeInserted){o=(c=d).getPropDef();c.toBeUpdated&&(r++,i.push(h.setSQLParam(o,s,p,null,null,r,null)))}}}}for(n=e.iterator();n.hasNext();){var f;if((f=n.next())instanceof u){o=(c=f).getPropDef();c.toBeCondition&&(r++,i.push(h.setSQLParam(o,null,!1,null,null,r,null)))}else if(f instanceof RefNode&&f.toBeJoined){var g;s=(g=f).getRefeDef();if(g.isInverse()&&!s.isInvFK()&&!s.isBi())continue;if(null==g.getChildren())continue;for(l=g.getChildren().iterator(),s=g.getRefeDef(),p=g.isInverse();l.hasNext();){d=l.next();if(g.isOne()){if(d instanceof u){o=(c=d).getPropDef();c.toBeCondition&&(r++,i.push(h.setSQLParam(o,s,p,null,null,r,null)))}}else if(g.isMany()&&d instanceof u){var c;o=(c=d).getPropDef();c.toBeCondition&&(r++,i.push(h.setSQLParam(o,s,p,null,null,r,null)))}}}}return i},t.exports=function(e,t,n){return new S(e,t,n)}},{"./appruntime_query.js":5,"./appruntime_update.js":8,"./arrayiterator.js":9,"./defs.js":10,"./hashmap.js":11,"./nodedef.js":13,"./sqlutil.js":14,"./stringbuffer.js":15}],4:[function(e,t,n){"use strict";var r=e("./defs.js").AppDef,i=e("./stringbuffer.js"),o=e("./arrayiterator.js"),a=(e("./hashmap.js"),e("./nodedef.js")),s=(a.AbstractEntDefNodeListBuilder,a.AbstractRefDefNodeListBuilder,a.FieldNodeList),p=a.RefeNode,l=a.PropNode,d=a.InsertEntNodeListBuilder,u=(a.InsertEntJoinNodeListBuilder,a.InsertRefNodeListBuilder),f=(a.InsertRefJoinNodeListBuilder,e("./sqlutil.js"));function g(e,t){this.sqlMap=e,this.model=t,this.appDef=new r(this.model)}g.prototype.generateCreateObjSQL=function(e){o.enableIterator();var t=[],n=new s;(new d).buildNodeList(n,e.entDef),t.push(this.processInsert(n,e));for(var r=(new u).buildNodeList(e.entDef).iterator();r.hasNext();){var i=r.next(),a=i.getMainRefNode();if(null!=a){var p=a.getRefeDef();i.isReferenceBased()&&(!a.isInverse()&&-1!=e.field.indexOf(p.getName())||a.isInverse()&&-1!=e.field.indexOf(p.getInvName()))&&t.push(this.processInsertRef(a,i,p,e))}}return o.disableIterator(),t},g.prototype.processInsert=function(e,t){var n=this.toInsertSQL(e,t.entDef,t.field),r=this.setInsertSQLParam(e,t.field,!1),i=t.entDef.getId();return{SQL:n,Param:r,Res:[f.getSQLResult(i,null,!1,null,null,1)],SQLType:"INSERT",FUNCType:"INSERT"}},g.prototype.processInsertRef=function(e,t,n,r){return{SQL:this.toInsertSQL(t,r.entDef,null),Param:this.setInsertSQLParam(t,null,!0),SQLType:"INSERT",FUNCType:e.isMany()?"INSERTREFMANY":"INSERTREFONE"}},g.prototype.toInsertSQL=function(e,t,n){var r=!1,o=t.getStorageName(),a=new i,s=new i,d=new i,u=new i,f=new i,g=new i,h=null,c=null;e.isReferenceBased()&&(c=e.getMainRefNode(),e.getMainRefNode().getRefeDef().isLT()?(o=this.sqlMap.getLTTableName(c.getRefeDef()),h=c.isInverse()?c.getRefeDef().getForeignEnt():t,0!=s.length()&&(s.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getSelectColumnSep()))):e.getMainRefNode().getRefeDef().isFK()?(o=c.getRefeDef().getRefOwnerEnt().getStorageName(),r=!0):e.getMainRefNode().getRefeDef().isInvFK()&&(o=c.getRefeDef().getForeignEnt().getStorageName(),r=!0));for(var m=e.iterator();m.hasNext();){var y=m.next();if(y instanceof l&&y.toBeInserted&&(null==n||n.contains(y.getPropDef().getName())||void 0!==y.getPropDef().getDefaultValue())){var N=y.getPropDef();if(e.isReferenceBased())e.getMainRefNode().getRefeDef().isLT()?(s.append(this.sqlMap.getLTColumnName(h,N)),d.append(this.sqlMap.getCastValue(N.getPropType(),"?"))):e.getMainRefNode().getRefeDef().isFK()?c.isInverse()?(s.append(this.sqlMap.getFKColumnName(c.getRefeDef(),t,N,!1)),s.append("="+this.sqlMap.getFKValue("?",!1))):(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(N.getStorageName()),g.append("=?")):e.getMainRefNode().getRefeDef().isInvFK()&&(c.isInverse()?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(N.getStorageName()),g.append("=?")):(s.append(this.sqlMap.getFKColumnName(c.getRefeDef(),t,N,!1)),s.append("="+this.sqlMap.getFKValue("?",!1))));else if(null==n||n.contains(N.getName())||void 0!==y.getPropDef().getDefaultValue()){var S=N.getPropType();if("Text"==S?(0!=u.length()&&(u.append(this.sqlMap.getSelectColumnSep()),f.append(this.sqlMap.getSelectColumnSep())),u.append(N.getStorageName())):(0!=s.length()&&(s.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getSelectColumnSep())),s.append(N.getStorageName())),n.contains(N.getName()))"Text"==S?f.append(this.sqlMap.getCastValue(S,"?")):d.append(this.sqlMap.getCastValue(S,"?"));else{var T=this.sqlMap.getCastValue(S,N.getDefaultValue(),!0);"Text"==S?f.append(T):d.append(T)}}}else if(y instanceof p){var R=y,L=R.isInverse()?R.getRefeDef().getInvName():R.getRefeDef().getName();if(R.toBeJoined&&(null==n||n.contains(L))){var v=R.getRefeDef(),C=R.getChildren().iterator();for(e.isReferenceBased()||(v.isFK()?R.isInverse()?(r=!0,o=R.getRefeDef().getRefOwnerEnt().getStorageName()):o=t.getStorageName():v.isInvFK()?R.isInverse()?o=t.getStorageName():(r=!0,o=R.getRefeDef().getForeignEnt().getStorageName()):v.isLT()&&(o=this.sqlMap.getLTTableName(v)));C.hasNext();){var D=C.next();if(D instanceof l&&D.toBeInserted){N=D.getPropDef();v.isFK()?R.isInverse()?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(N.getStorageName()),g.append("=?")):(0!=s.length()&&(s.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getSelectColumnSep())),s.append(this.sqlMap.getFKColumnName2(R.getRefeDef(),N,R.isInverse(),!1)),d.append(this.sqlMap.getFKValue2("?",!1))):v.isInvFK()?R.isInverse()?(0!=s.length()&&(s.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getSelectColumnSep())),s.append(this.sqlMap.getFKColumnName2(R.getRefeDef(),N,R.isInverse(),!1)),d.append(this.sqlMap.getFKValue2("?",!1))):(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(N.getStorageName()),g.append("=?")):v.isLT()&&(R.isInverse()?(0!=s.length()&&(s.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getSelectColumnSep())),s.append(this.sqlMap.getLTColumnName(R.getRefeDef().getRefOwnerEnt(),N)),d.append("?")):(0!=s.length()&&(s.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getSelectColumnSep())),s.append(this.sqlMap.getLTColumnName(R.getRefeDef().getForeignEnt(),N)),d.append("?")))}}}}}if(r){if(M=this.sqlMap.getFunction("GenerateUpdateCommand")){var I=M(o,s.toString(),this.sqlMap.getSQLWhere()+g.toString());if(I)return a.append(I),a.toString()}a.append(this.sqlMap.getSQLUpdate()),a.append(o),a.append(this.sqlMap.getSQLSet()),a.append(s.toString()),a.append(this.sqlMap.getSQLWhere()),a.append(g.toString())}else{var M;if(a.append(this.sqlMap.getSQLInsert()),a.append(o),a.append(" ("),a.append(s.toString()),0!=s.length()&&0!=u.length()&&a.append(this.sqlMap.getSelectColumnSep()),0!=u.length()&&a.append(u.toString()),a.append(") "),a.append(this.sqlMap.getSQLValues()),a.append(" ("),a.append(d.toString()),0!=d.length()&&0!=f.length()&&a.append(this.sqlMap.getSelectColumnSep()),0!=f.length()&&a.append(f.toString()),a.append(") "),M=this.sqlMap.getFunction("GenerateInsertCommand")){var E=M(o,s.toString(),d.toString(),u.toString(),f.toString(),e.isReferenceBased(),a.toString());if(E)return E}}return a.toString()},g.prototype.setInsertSQLParam=function(e,t,n){for(var r=e.iterator(),i=0,o=[];r.hasNext();){if((N=r.next())instanceof l&&N.toBeInserted&&(null==t||t.contains(N.getPropDef().getName()))){if("Text"!=(y=N.getPropDef()).getPropType()){i++;var a=n?"toBeInserted":null,s=f.setSQLParam(y,null,!1,null,null,i,null,-1,a);o.push(s)}}else if(N instanceof p){var d=N,u=(h=d.isInverse())?d.getRefeDef().getInvName():d.getRefeDef().getName();if(d.toBeJoined&&(null==t||t.contains(u)))for(var g=d.getRefeDef(),h=d.isInverse(),c=(a=n?"toBeInserted":null,d.getChildren().iterator());c.hasNext();){var m=c.next();if(d.isOne()){if(m instanceof l&&m.toBeInserted){var y=m.getPropDef();i++;s=f.setSQLParam(y,g,h,null,null,i,null,-1,a);o.push(s)}}else if(d.isMany()&&m instanceof l&&m.toBeInserted){y=m.getPropDef();i++;s=f.setSQLParam(y,g,h,null,null,i,null,-1,a);o.push(s)}}}}for(r=e.iterator();r.hasNext();){var N;if((N=r.next())instanceof l&&N.toBeInserted&&(null==t||t.contains(N.getPropDef().getName())))if("Text"==(y=N.getPropDef()).getPropType()){i++;a=n?"toBeInserted":null,s=f.setSQLParam(y,null,!1,null,null,i,null,-1,a);o.push(s)}}return o},t.exports=function(e,t,n){return new g(e,t,n)}},{"./arrayiterator.js":9,"./defs.js":10,"./hashmap.js":11,"./nodedef.js":13,"./sqlutil.js":14,"./stringbuffer.js":15}],5:[function(e,t,n){"use strict";var r=e("./defs.js"),i=r.AppDef,o=e("./stringbuffer.js"),a=e("./arrayiterator.js"),s=e("./hashmap.js"),p=e("./nodedef.js"),l=(p.AbstractEntDefNodeListBuilder,p.AbstractRefDefNodeListBuilder,p.FieldNodeList,p.RefeNode,p.PropNode,r.QueryDef,r.QueryCondition,r.QueryRefeCondition),d=r.QueryPropCondition,u=r.QueryBiCondition,f=e("./appruntime_read.js"),g=e("./sqlutil.js");function h(e,t){this.sqlMap=e,this.model=t,this.appDef=new i(this.model),this.readsql=f(e,t)}h.prototype.generateQueryObjSQL=function(e){a.enableIterator();e.getEntityDef();var t=new o,n=new o;this.toQuerySQL(e,t,n);var r=!1,i=null;null!=e.getRefeDef()?(r=e.getInverse(),i=e.getRefeDef(),r?i.getInvName():i.getName(),(r?i.getForeignEnt():i.getRefOwnerEnt()).getName()):e.getEntityDef().getName();var s=[];this.setQuerySQLParam(e.getCondition(),s,e,0);var p=[];return this.getQuerySQLRes(e,null,!1,0,null,null,p),a.disableIterator(),e.noCount?[{SQL:t.toString(),Param:s,Res:p,SQLType:"QUERY",FUNCType:"QUERY"}]:[{SQL:n.toString(),Param:s,SQLType:"QUERY",FUNCType:"QUERYCOUNT"},{SQL:t.toString(),Param:s,Res:p,SQLType:"QUERY",FUNCType:"QUERY"}]},h.prototype.getPropRefOperator=function(e,t,n,r){return g.getPropRefOperator(e,t,n,r,this.sqlMap)},h.prototype.addLineBreak=function(e){this.format?e.append("\n"):e.append("")},h.prototype.toQuerySQL=function(e,t,n){var r=e.getEntityDef(),i=new s,a=new s,p=new s,l=new o,d=(new o,new o);d.append(this.sqlMap.getTableName2(r,this.sqlMap.toTableShortNameByCount(1)));var u=new o,f=new o,g=new o,h=new o,c=new s,m=[],y=[],N=this.toSQLRowLimitHeader(e,l),S=this.toSQLRowLimitTail(e),T={column:l,groupbyField:e.model.GroupByField,groupby:m,groupbyExist:y},R=this.toWhereSQL(T,g,u,e.getCondition(),i,a,p,!1);this.toColumnSQL(l,f,e,this.sqlMap.toTableShortNameByCount(1),R,c),this.toOrderSQL(h,e,this.sqlMap.toTableShortNameByCount(1),R,c),this.toGroupbySQL(m,e,y,c),t.append(N),t.append(this.sqlMap.getSQLSelect()),null!=e.getDistinct()&&e.getDistinct()&&t.append(this.sqlMap.getSQLDistinct()),t.append(l.toString()),this.addLineBreak(t),t.append(this.sqlMap.getSQLFrom()),t.append(d.toString()),t.append(u.toString()),t.append(f.toString()),this.addLineBreak(t),t.append(g.length()>0?this.sqlMap.getSQLWhere():""),t.append(g.toString());for(var L=0;L<y.length;L++)if(y[L]&&m.length>0){t.append(this.sqlMap.getSQLGroupby()),t.append(m.join(this.sqlMap.getSelectColumnSep()));break}h.length()>0&&(this.addLineBreak(t),t.append(this.sqlMap.getSQLOrderBy()),t.append(h)),this.addLineBreak(t),t.append(S),n.append(this.sqlMap.getSQLSelect()),n.append(this.sqlMap.getSQLCount()),n.append("(*"),n.append(")"),n.append(this.sqlMap.getSQLAs()),n.append(" CNT "),n.append(this.sqlMap.getSQLFrom()),n.append("("),n.append(this.sqlMap.getSQLSelect()),null!=e.getDistinct()&&e.getDistinct()&&n.append(this.sqlMap.getSQLDistinct()),n.append(l.toString()),this.addLineBreak(n),n.append(this.sqlMap.getSQLFrom()),n.append(d.toString()),n.append(u.toString()),n.append(f.toString()),this.addLineBreak(n),n.append(g.length()>0?this.sqlMap.getSQLWhere():""),n.append(g.toString());for(L=0;L<y.length;L++)if(y[L]&&m.length>0){n.append(this.sqlMap.getSQLGroupby()),n.append(m.join(this.sqlMap.getSelectColumnSep()));break}n.append(") "),n.append(this.sqlMap.getSQLAs()),n.append(" COUNTQRY ")},h.prototype.toWhereSQL=function(e,t,n,r,i,o,a,s){var p=1;if(null!=r)for(var l=r.iterator();l.hasNext();){var d=l.next();p=this.toQueryConditionSQL(e,t,n,d,p,!0,null,null,i,o,a,s)}return p},h.prototype.toQueryConditionSQL=function(e,t,n,r,i,a,s,p,f,g,h,c){if(r instanceof d)this.toQueryPropConditionSQL(t,r,a,i,null,null,f,g,h,c);else if(r instanceof l){var m=new String,y=r;m+="["+(y.getInverse()?y.getQueryReference().getInvName():y.getQueryReference().getName())+"].";var N=y.getSubCondition();if(null!=N)for(var S=N.iterator();S.hasNext();){if((R=S.next())instanceof l){var T=R;m+="["+(T.getInverse()?T.getQueryReference().getInvName():T.getQueryReference().getName())+"]."}}if(f.containsKey(m)?this.toQueryRefeConditionSQL(e,new o,t,y,1,h.get(m)-1,f,g,h,a):(f.put(m,y),g.put(m,i),i=this.toQueryRefeConditionSQL(e,n,t,y,1,i,f,g,h,a),h.put(m,i)),null!=(N=y.getSubCondition()))for(S=N.iterator();S.hasNext();){var R;(R=S.next())instanceof u&&(i=this.toQueryConditionSQL(e,t,n,R,i,a,s,p,f,g,h,c))}}else if(r instanceof u){var L=r.getLeftCondition(),v=r.getRightCondition();null!=v&&t.append("(");var C=r.getBinOpt();i=this.toQueryConditionSQL(e,t,n,L,i,"AND"==C,s,p,f,g,h,c),null!=v&&("AND"==C?(t.length()>1&&t.append(this.sqlMap.getSQLAnd()),i=this.toQueryConditionSQL(e,t,n,v,i,!0,s,p,f,g,h,c)):"OR"==C?(0!=t.length()&&t.append(this.sqlMap.getSQLOr()),i=this.toQueryConditionSQL(e,t,n,v,i,!1,s,p,f,g,h,c)):(t.length()>1&&t.append(this.sqlMap.getSQLAnd()),i=this.toQueryConditionSQL(e,t,n,v,i,!0,s,p,f,g,h,c))),null!=v&&t.append(")")}return i},h.prototype.toQueryRefeConditionSQL=function(e,t,n,r,i,o,a,s,p,u){var f=r.getQueryReference(),g=r.getInverse(),h=this.sqlMap.toTableShortNameByCount(i),c=this.sqlMap.toTableShortNameByCount(o),m=null==r.getOperator()||"="===r.getOperator(),y=0,N="",S=r;N+="["+(S.getInverse()?S.getQueryReference().getInvName():S.getQueryReference().getName())+"].",p.containsKey(N)&&(y=p.get(N));var T=S.getSubCondition();if(null!=T)for(var R=T.iterator();R.hasNext();){if((q=R.next())instanceof l)N+="["+((Q=q).getInverse()?Q.getQueryReference().getInvName():Q.getQueryReference().getName())+"].",p.containsKey(N)&&(y=p.get(N))}var L=null!=r.getNotEq()&&r.getNotEq();if(0==y&&(o+=1,null==r.getOperator()||"="==r.getOperator()?L||0==r.connectRef?(this.addLineBreak(t),t.append(this.sqlMap.getSQLLeftOuterJoin()),m=!1):(this.addLineBreak(t),t.append(this.sqlMap.getSQLInnerJoin()),m=!0):"<>"==r.getOperator()?(this.addLineBreak(t),t.append(this.sqlMap.getSQLLeftOuterJoin())):"Is-Null"==r.getOperator()&&(this.addLineBreak(t),t.append(this.sqlMap.getSQLLeftOuterJoin())),this.readsql.toReadJoinOnSQL(f,g,L,h,o,m,t),c=this.sqlMap.toTableShortNameByCount(o),y=o),null!=r.getOperator()){var v=(g?f.getRefOwnerEnt():f.getForeignEnt()).getPrimaryKey();if(null!=v)for(var C=v.iterator();C.hasNext();){var D=C.next(),I=this.getPropRefOperator(c,D,D.getStorageName());"="==r.getOperator()?L?n.append(I+this.sqlMap.getIsNull()):(t.append(this.sqlMap.getSQLAnd()),t.append(I+" = ?")):"<>"==r.getOperator()?(n.length()>1&&n.append(this.sqlMap.getSQLAnd()),n.append(I+" <> ? "),n.append(this.sqlMap.getSQLOr()),n.append(I+this.sqlMap.getIsNull())):"Is-Null"==r.getOperator()&&(n.length(),n.append(I+this.sqlMap.getIsNull()))}c=this.sqlMap.toTableShortNameByCount(o-1)}var M=o,E=0;if(null!=(T=r.getSubCondition())){var O="";for(R=T.iterator();R.hasNext();){var q;if(E>0&&n.length()>1&&n.append(u?this.sqlMap.getSQLAnd():this.sqlMap.getSQLOr()),E++,(q=R.next())instanceof l)O+="["+((Q=q).getInverse()?Q.getQueryReference().getInvName():Q.getQueryReference().getName())+"].",o=p.containsKey(O)?this.toQueryRefeConditionSQL(e,t,n,Q,o,o,a,s,p,u):this.toQueryRefeConditionSQL(e,t,n,Q,y,o,a,s,p,u);else if(q instanceof d){var Q=q;this.toQueryPropConditionSQL(n,Q,!0,o,N,O,a,s,p)}}}var P=r.getPropField();if(null!=P)for(var F=P.iterator();F.hasNext();){var A=F.next(),B=A.getProp();0!=e.column.length()&&e.column.append(this.sqlMap.getSelectColumnSep()),e.column.append(this.getPropRefOperator(c,B,B.getStorageName())),e.column.append(this.sqlMap.getSQLAs()),e.column.append(A.getName().toUpperCase()),e.groupbyField&&-1!=e.groupbyField.indexOf(A.getName().toUpperCase())&&(e.groupbyExist.push(!0),e.groupby.push(A.getName().toUpperCase()))}var b=r.getRefeField();if(null!=b)for(var x=b.iterator(),w=M;x.hasNext();){var K=x.next(),_=K.getReference(),U=K.getInverse(),k=K.getReferenceQuery();this.addLineBreak(t),t.append(this.sqlMap.getSQLLeftOuterJoin()),o+=1;var j=this.sqlMap.toTableShortNameByCount(w);this.readsql.toReadJoinOnSQL(_,U,!1,j,o,!1,t),o=this.toColumnSQL(e.column,t,k,this.sqlMap.toTableShortNameByCount(o),o)}return o},h.prototype.toQueryPropConditionSQL=function(e,t,n,r,i,o,a,s,p,l){var d=t.getQueryProp(),u=t.getOperator(),f=t.getTargetValue();l?e.append(this.getPropRefOperator(null,d,d.getStorageName(),!0)):null==i?e.append(this.getPropRefOperator(this.sqlMap.toTableShortNameByCount(1),d,d.getStorageName(),!0)):e.append(this.getPropRefOperator(this.sqlMap.toTableShortNameByCount(r),d,d.getStorageName(),!0)),"string"==d.getPropType().toLowerCase()?"="==u?e.append(" = "+f):"<>"==u?e.append(" <> "+f):"Start-With"==u?e.append(" LIKE "+f):"End-With"==u?e.append(" LIKE "+f):"Contains"==u?e.append(" LIKE "+f):"Is-Not-Null"==u?e.append(this.sqlMap.getIsNotNull()):"Is-Null"==u&&e.append(this.sqlMap.getIsNull()):"integer"==d.getPropType().toLowerCase()||"long"==d.getPropType().toLowerCase()||"short"==d.getPropType().toLowerCase()||"double"==d.getPropType().toLowerCase()||"float"==d.getPropType().toLowerCase()||"decimal"==d.getPropType().toLowerCase()||"id"==d.getPropType().toLowerCase()?"="==u?e.append(" = "+f):"<>"==u?e.append(" <> "+f):">"==u?e.append(" > "+f):"<="==u?e.append(" <= "+f):"<"==u?e.append(" < "+f):">="==u?e.append(" >= "+f):"Is-Not-Null"==u?e.append(this.sqlMap.getIsNotNull()):"Is-Null"==u&&e.append(this.sqlMap.getIsNull()):"date"==d.getPropType().toLowerCase()||"datetime"==d.getPropType().toLowerCase()||"time"==d.getPropType().toLowerCase()||"timestamp"==d.getPropType().toLowerCase()?"="==u?e.append(" = "+f):"<>"==u?e.append(" <> "+f):">"==u?e.append(" > "+f):"<="==u?e.append(" <= "+f):"<"==u?e.append(" < "+f):">="==u?e.append(" >= "+f):"Is-Not-Null"==u?e.append(this.sqlMap.getIsNotNull()):"Is-Null"==u&&e.append(this.sqlMap.getIsNull()):"boolean"==d.getPropType().toLowerCase()&&("true"==String(f)?e.append(" = 1"):"false"==String(f)?e.append(" = 0"):"Is-Not-Null"==u?e.append(this.sqlMap.getIsNotNull()):"Is-Null"==u?e.append(this.sqlMap.getIsNull()):e.append(" = "+f))},h.prototype.toColumnSQL=function(e,t,n,r,i,o){var a=n.getPropField();if(null!=a)for(var s=a.iterator();s.hasNext();){var p=s.next(),l=p.getProp(),d=p.getAggregation();if(0!=e.length()&&e.append(this.sqlMap.getSelectColumnSep()),null!=d)if(this.sqlMap.getCastForAggr()){var u=this.sqlMap.getCastForAggr(this.getPropRefOperator(r,l,l.getStorageName()),l.getPropType());e.append(d+"("+u+")")}else e.append(d+"("+this.getPropRefOperator(r,l,l.getStorageName())+")");else{var f=this.getPropRefOperator(r,l,l.getStorageName());e.append(f),o&&o.put(p.getName().toUpperCase(),f)}e.append(this.sqlMap.getSQLAs()),e.append(p.getName().toUpperCase())}var g=n.getRefeField();if(null!=g)for(var h=g.iterator(),c=i;h.hasNext();){var m=h.next(),y=m.getReference(),N=m.getInverse(),S=m.getReferenceQuery();this.addLineBreak(t),t.append(this.sqlMap.getSQLLeftOuterJoin()),i+=1;this.sqlMap.toTableShortNameByCount(c);this.readsql.toReadJoinOnSQL(y,N,!1,r,i,!1,t),i=this.toColumnSQL(e,t,S,this.sqlMap.toTableShortNameByCount(i),i,o)}return i},h.prototype.toGroupbySQL=function(e,t,n,r){var i=t.getPropField();if(null!=i)for(var o=i.iterator();o.hasNext();){var a=o.next();a.getProp();if(null!=a.getAggregation())n.push(!0);else{var s=a.getName().toUpperCase();t.model.GroupByField?-1!=t.model.GroupByField.indexOf(s)&&r.get(s)&&e.push(r.get(s)):r.get(s)&&e.push(r.get(s))}}var p=t.getRefeField();if(null!=p)for(var l=p.iterator();l.hasNext();){var d=l.next(),u=(d.getReference(),d.getInverse(),d.getReferenceQuery());u.model=t.model,this.toGroupbySQL(e,u,n,r)}},h.prototype.toOrderSQL=function(e,t,n,r,i){var o=t.getOrderField();if(o&&null!=o&&o.length>0){for(var a=o.iterator();a.hasNext();){var s=a.next();0!=e.length()&&e.append(this.sqlMap.getSelectColumnSep());var p=s.getName();i.get(p)?e.append(i.get(p)):e.append(p)}e.append(t.getOrderDesc()?this.sqlMap.getSQLOrderByDESC():this.sqlMap.getSQLOrderByASC())}else{var l=t.getEntityDef(),d=t.getPropField();if(null!=d)for(a=d.iterator();a.hasNext();){var u=(s=a.next()).getProp();if(l.getName()+"Id"==u.getName())return e.append(s.getName()),void e.append(this.sqlMap.getSQLOrderByASC())}}},h.prototype.toSQLRowLimitHeader=function(e,t){return e.getPageSize()>0?(this.sqlMap.getRowNumColumn()&&t.append(this.sqlMap.getRowNumColumn()),this.sqlMap.getPagingSQLHeader()):""},h.prototype.toSQLRowLimitTail=function(e){return e.getPageSize()>0?this.sqlMap.getPagingSQLTail():""},h.prototype.getQuerySQLRes=function(e,t,n,r,i,o,a){var s=e.getCondition(),p=e.getRefeDef(),l=e.getInverse();if(null!=s)for(var d=s.iterator();d.hasNext();){var u=d.next(),f=null==i?new Array:i,h=null==o?new Array:o;r=null!=p?this.getQueryConditionSQLRes(u,r,p,l,f,h,a):this.getQueryConditionSQLRes(u,r,null,!1,f,h,a)}var c=e.getPropField();if(null!=c)for(d=c.iterator();d.hasNext();){var m=d.next(),y=m.getProp(),N=m.getName(),S=m.getNameDefined();r++,a.push(g.getSQLResult(y,t,n,i,o,m.getIdx(),N,S,m.getAggregation()))}var T=e.getRefeField();if(null!=T)for(var R=T.iterator();R.hasNext();){var L=R.next(),v=L.getReference(),C=L.getInverse(),D=L.getReferenceQuery();f=null==i?new Array:i,h=null==o?new Array:o;t&&(f.push(n?t.getInvName():t.getName()),h.push(n));f=null==i?new Array:i,h=null==o?new Array:o;r=this.getQuerySQLRes(D,v,C,r,f,h,a)}return r},h.prototype.getQueryConditionSQLRes=function(e,t,n,r,i,o,a){if(e instanceof l)t=this.getQueryRefeConditionSQLRes(e,t,i,o,a);else if(e instanceof u){var s=e.getLeftCondition();t=this.getQueryConditionSQLRes(s,t,n,r,i,o,a);var p=e.getRightCondition();t=this.getQueryConditionSQLRes(p,t,n,r,i,o,a)}return t},h.prototype.getQueryRefeConditionSQLRes=function(e,t,n,r,i){var o=e.getPropField(),a=e.getRefeField(),s=e.getQueryReference(),p=e.getInverse();if(null!=o&&o.length>0||null!=a&&a.length>0){if(null!=o&&o.length>0)for(var d=o.iterator();d.hasNext();){var u=d.next(),f=u.getProp(),h=u.getName(),c=u.getNameDefined();t++,i.push(g.getSQLResult(f,s,p,n,r,u.getIdx(),h,c))}if(null!=a&&a.length>0){var m=a.iterator();for(n.push(p?s.getInvName():s.getName()),r.push(p);m.hasNext();){var y=m.next(),N=y.getReference(),S=y.getInverse(),T=y.getReferenceQuery();t=this.getQuerySQLRes(T,N,S,t,n,r,i)}}}var R=e.getSubCondition();if(null!=R)for(d=R.iterator();d.hasNext();){var L=d.next();L instanceof l?(n.push(p?s.getInvName():s.getName()),r.push(p),this.getQueryRefeConditionSQLRes(L,t,n,r,i)):this.getQueryConditionSQLRes(L,t,s,p,n,r,i)}return t},h.prototype.setQuerySQLParam=function(e,t,n,r){if(null!=e)for(var i=e.iterator();i.hasNext();){var o=i.next(),a=[],s=[],p=null!=n?n.getRefeDef():null,l=null!=n&&n.getInverse();r=null!=p?this.setQuerySQLParam2(p,l,a,s,o,r,!1,t):this.setQuerySQLParam2(null,!1,a,s,o,r,!0,t)}},h.prototype.setQuerySQLParam2=function(e,t,n,r,i,o,a,s){if(i instanceof d){var p=i.getQueryProp(),f=i.getTargetValue(),h=i.getOperator();"?"==f&&(o++,s.push(g.setSQLParam(p,e,t,n,r,o,h.toString(),i.getIndex())))}else if(i instanceof l){e&&(n.push(t?e.getInvName():e.getName()),r.push(t));var c=i.getQueryReference(),m=i.getInverse(),y=(h=i.getOperator(),i.connectRef);if(a){if(null!=h)if(null!=(v=(m?c.getForeignEnt():c.getRefOwnerEnt()).getPrimaryKey()))for(var N=v.iterator();N.hasNext();){var S=N.next();"="==h?(o++,s.push(g.setSQLParam(S,c,m,n,r,o,h.toString(),i.getIndex()))):"<>"==h&&(o++,s.push(g.setSQLParam(S,c,m,n,r,o,h.toString(),i.getIndex())))}if(null!=(C=i.getSubCondition()))for(var T=c,R=m,L=C.iterator();L.hasNext();){(D=L.next())instanceof d?o=this.setQuerySQLParam2(T,R,n.clone(),r.clone(),D,o,a,s):D instanceof l?(T=D.getQueryReference(),R=D.getInverse(),n.push(m?c.getInvName():c.getName()),r.push(m),o=this.setQuerySQLParam2(T,R,n.clone(),r.clone(),D,o,a,s)):(n.push(m?c.getInvName():c.getName()),r.push(m),o=this.setQuerySQLParam2(c,m,n.clone(),r.clone(),D,o,a,s))}}else{var v,C;if(null!=h)if(null!=(v=(m?c.getRefOwnerEnt():c.getForeignEnt()).getPrimaryKey()))for(N=v.iterator();N.hasNext();){S=N.next();"="==h?(o++,y?s.push(g.setSQLParam(S,null,null,null,null,o,h.toString(),null)):s.push(g.setSQLParam(S,c,m,n,r,o,h.toString(),i.getIndex()))):"<>"==h&&(o++,s.push(g.setSQLParam(S,c,m,n,r,o,h.toString(),i.getIndex())))}if(null!=(C=i.getSubCondition()))for(T=c,R=m,L=C.iterator();L.hasNext();){var D;(D=L.next())instanceof d?o=this.setQuerySQLParam2(c,m,n,r,D,o,a,s):D instanceof l?(T=D.getQueryReference(),R=D.getInverse(),n.push(m?c.getInvName():c.getName()),r.push(m),o=this.setQuerySQLParam2(T,R,n,r,D,o,a,s)):(n.push(m?c.getName():c.getInvName()),r.push(!m),o=this.setQuerySQLParam2(c,m,n,r,D,o,a,s))}}}else if(i instanceof u){var I=i.getLeftCondition();o=this.setQuerySQLParam2(e,t,[],[],I,o,a,s);var M=i.getRightCondition();null!=M&&(o=this.setQuerySQLParam2(e,t,[],[],M,o,a,s))}return o},t.exports=function(e,t,n){return new h(e,t,n)}},{"./appruntime_read.js":6,"./arrayiterator.js":9,"./defs.js":10,"./hashmap.js":11,"./nodedef.js":13,"./sqlutil.js":14,"./stringbuffer.js":15}],6:[function(require,module,exports){"use strict";var defs=require("./defs.js"),AppDef=defs.AppDef,StringBuffer=require("./stringbuffer.js"),arrayiterator=require("./arrayiterator.js"),HashMap=require("./hashmap.js"),nodedef=require("./nodedef.js"),AbstractEntDefNodeListBuilder=nodedef.AbstractEntDefNodeListBuilder,AbstractRefDefNodeListBuilder=nodedef.AbstractRefDefNodeListBuilder,FieldNodeList=nodedef.FieldNodeList,RefeNode=nodedef.RefeNode,PropNode=nodedef.PropNode,SQLUtil=require("./sqlutil.js");function ReadEntNodeListBuilder(){AbstractEntDefNodeListBuilder.call(this)}function ReadEntJoinNodeListBuilder(e,t){AbstractEntDefNodeListBuilder.call(this),this.readJoinRefeDef=e,this.readJoinNotinverse=t}function ReadRefNodeListBuilder(){AbstractRefDefNodeListBuilder.call(this)}function ReadRefJoinNodeListBuilder(e,t){AbstractEntDefNodeListBuilder.call(this),this.readJoinRefeDef=e,this.readJoinNotinverse=t}function AppRuntime_Read(e,t){this.sqlMap=e,this.model=t,this.appDef=new AppDef(this.model)}ReadEntNodeListBuilder.prototype=new AbstractEntDefNodeListBuilder,ReadEntNodeListBuilder.prototype.constructor=ReadEntNodeListBuilder,ReadEntNodeListBuilder.prototype.requiredProp=function(e,t,n,r){return!0},ReadEntNodeListBuilder.prototype.requiredRefe=function(e,t,n,r,i){return r?!!n.isOne2()&&(n.is2One()?n.isInvFK()||n.isLT()||n.isAnce():!!n.is2Many()&&(n.isBi()||n.isDesc())):n.is2One()},ReadEntNodeListBuilder.prototype.updatePropNode=function(e,t,n,r){t.isPK(n.getPropDef())&&(n.toBeCondition=!0),n.toBeSelected=!0},ReadEntNodeListBuilder.prototype.updateRefeNode=function(e,t,n,r,i){n.toBeJoined=!0;var o=null;r?(o=n.getRefeDef().getRefOwnerEnt(),n.setInverse(!0)):(o=n.getRefeDef().getForeignEnt(),n.setInverse(!1));var a=new FieldNodeList;n.setChildren(a),new ReadEntJoinNodeListBuilder(n.getRefeDef(),n.isInverse()).buildNodeList(a,o,i)},ReadEntJoinNodeListBuilder.prototype=new AbstractEntDefNodeListBuilder,ReadEntJoinNodeListBuilder.prototype.constructor=ReadEntJoinNodeListBuilder,ReadEntJoinNodeListBuilder.prototype.requiredProp=function(e,t,n,r){return t.isPK(n)||(this.hasRefProp(n,this.readJoinRefeDef,this.readJoinNotinverse,r)?this.checkRefProp(n,this.readJoinRefeDef,this.readJoinNotinverse,r):t.isPropTitle(n))},ReadEntJoinNodeListBuilder.prototype.requiredRefe=function(e,t,n,r,i){return!r&&(n.isAnce()||t.isRefeTitle(n))},ReadEntJoinNodeListBuilder.prototype.updatePropNode=function(e,t,n,r){n.toBeSelected=!0},ReadEntJoinNodeListBuilder.prototype.updateNode=function(e,t,n,r,i){var o=null;r?(o=n.getRefeDef().getRefOwnerEnt(),n.setInverse(!0)):(o=n.getRefeDef().getForeignEnt(),n.setInverse(!1)),n.toBeJoined=!0;var a=new FieldNodeList;n.setChildren(a),new ReadEntJoinNodeListBuilder(n.getRefeDef(),n.isInverse()).buildNodeList(a,o,i)},ReadEntJoinNodeListBuilder.prototype.checkRefProp=function(propDef,refeDef,notinverse,actionDef){if(actionDef.model.RefeField)if(notinverse){var refeField=eval("actionDef.model.RefeField."+refeDef.getInvName());if(-1!=refeField.indexOf(propDef.getName()))return!0}else{var refeField=eval("actionDef.model.RefeField."+refeDef.getName());if(-1!=refeField.indexOf(propDef.getName()))return!0}return!1},ReadEntJoinNodeListBuilder.prototype.hasRefProp=function(propDef,refeDef,notinverse,actionDef){if(actionDef.model.RefeField)if(notinverse){var refeField=eval("actionDef.model.RefeField."+refeDef.getInvName());if(refeField&&refeField.length>0)return!0}else{var refeField=eval("actionDef.model.RefeField."+refeDef.getName());if(refeField&&refeField.length>0)return!0}return!1},ReadRefNodeListBuilder.prototype=new AbstractRefDefNodeListBuilder,ReadRefNodeListBuilder.prototype.constructor=ReadRefNodeListBuilder,ReadRefNodeListBuilder.prototype.requiredProp=function(e,t,n,r,i){return!!this.checkRef(n,r)&&e.isPK(t)},ReadRefNodeListBuilder.prototype.requiredRefe=function(e,t,n,r){return this.checkRef(t,n)},ReadRefNodeListBuilder.prototype.updatePropNode=function(e,t,n,r,i){t.toBeCondition=!0},ReadRefNodeListBuilder.prototype.updateRefeNode=function(e,t,n,r){t.toBeJoined=!0;var i=null;n?(i=t.getRefeDef().getRefOwnerEnt(),t.setInverse(!0)):(i=t.getRefeDef().getForeignEnt(),t.setInverse(!1));var o=new FieldNodeList;t.setChildren(o),new ReadRefJoinNodeListBuilder(t.getRefeDef(),t.isInverse()).buildNodeList(o,i,r)},ReadRefNodeListBuilder.prototype.checkRef=function(e,t){if(t){if(e.isBi()){if(e.isOne2())return!1;if(e.isMany2())return!0}}else{if(e.is2One())return!1;if(e.is2Many())return!0}return!1},ReadRefJoinNodeListBuilder.prototype=new AbstractEntDefNodeListBuilder,ReadRefJoinNodeListBuilder.prototype.constructor=ReadRefJoinNodeListBuilder,ReadRefJoinNodeListBuilder.prototype.requiredProp=function(e,t,n,r){return t.isPK(n)||(this.hasRefProp(n,this.readJoinRefeDef,this.readJoinNotinverse,r)?this.checkRefProp(n,this.readJoinRefeDef,this.readJoinNotinverse,r):t.isPropTitle(n))},ReadRefJoinNodeListBuilder.prototype.requiredRefe=function(e,t,n,r,i){return t.isRefeTitle(n)},ReadRefJoinNodeListBuilder.prototype.updatePropNode=function(e,t,n,r){n.toBeSelected=!0},ReadRefJoinNodeListBuilder.prototype.updateNode=function(e,t,n,r,i){n.toBeJoined=!0;var o=null;r?(o=n.getRefeDef().getRefOwnerEnt(),n.setInverse(!0)):(o=n.getRefeDef().getForeignEnt(),n.setInverse(!1));var a=new FieldNodeList;n.setChildren(a),(new ReadRefJoinNodeListBuilder).buildNodeList(a,o)},ReadRefJoinNodeListBuilder.prototype.checkRefProp=function(propDef,refeDef,notinverse,actionDef){if(actionDef.model.RefeField)if(notinverse){var refeField=eval("actionDef.model.RefeField."+refeDef.getInvName());if(-1!=refeField.indexOf(propDef.getName()))return!0}else{var refeField=eval("actionDef.model.RefeField."+refeDef.getName());if(-1!=refeField.indexOf(propDef.getName()))return!0}return!1},ReadRefJoinNodeListBuilder.prototype.hasRefProp=function(propDef,refeDef,notinverse,actionDef){if(actionDef.model.RefeField)if(notinverse){var refeField=eval("actionDef.model.RefeField."+refeDef.getInvName());if(refeField&&refeField.length>0)return!0}else{var refeField=eval("actionDef.model.RefeField."+refeDef.getName());if(refeField&&refeField.length>0)return!0}return!1},AppRuntime_Read.prototype.getPropRefOperator=function(e,t,n,r){return SQLUtil.getPropRefOperator(e,t,n,r,this.sqlMap)},AppRuntime_Read.prototype.generateReadObjSQL=function(e){arrayiterator.enableIterator();var t=[],n=new FieldNodeList,r=new ReadEntNodeListBuilder,i=e.entDef;r.buildNodeList(n,i,e);var o=(new ReadRefNodeListBuilder).buildNodeList(e.entDef,e),a=e.field;t.push(this.processRead(n,e));for(var s=o.iterator();s.hasNext();){var p=s.next(),l=p.getMainRefNode();if(null!=l){var d=l.getRefeDef(),u=null;u=l.isInverse()?d.getInvName():d.getName(),null!=a&&-1==a.indexOf(u)||t.push(this.processReadRef(l,p,e))}}return arrayiterator.disableIterator(),t},AppRuntime_Read.prototype.processRead=function(e,t){var n=this.toReadSQL(e,t),r=this.setReadSQLParam(e,t,0),i=[];return this.getReadSQLRes(e,t.field,0,i,null,null,t),{SQL:n,Param:r,Res:i,SQLType:"QUERY",FUNCType:"QUERY"}},AppRuntime_Read.prototype.processReadRef=function(e,t,n){var r=this.toReadSQL(t,n),i=e.isInverse(),o=e.getRefeDef(),a=(e.isInverse()?o.getRefOwnerEnt().getName():o.getForeignEnt().getName(),i?e.getRefeDef().getInvName():e.getRefeDef().getName(),this.setReadSQLParam(t,n,0)),s=[];return this.getReadSQLRes(t,null,0,s,null,null,n),{SQL:r,Param:a,Res:s,SQLType:"QUERY",FUNCType:"READREF"}},AppRuntime_Read.prototype.toReadSQL=function(e,t){var n=t.entDef,r=new StringBuffer,i=new StringBuffer,o=new StringBuffer,a=new StringBuffer,s=new StringBuffer,p=new StringBuffer;return o.append(this.sqlMap.getTableName2(n,this.sqlMap.toTableShortNameByCount(1))),this.toReadSQL2(i,a,s,t.field,e,1,null,t),this.toReadOrderSQL(p,e,n),r.append(this.sqlMap.getSQLSelect()),r.append(i),r.append(this.sqlMap.getSQLFrom()),r.append(o),r.append(a),r.append(this.sqlMap.getSQLWhere()),r.append(s),p.length()>0&&(this.addLineBreak(r),r.append(this.sqlMap.getSQLOrderBy()),r.append(p),r.append(this.sqlMap.getSQLOrderByASC())),r.toString()},AppRuntime_Read.prototype.addLineBreak=function(e){this.format?e.append("\n"):e.append("")},AppRuntime_Read.prototype.toReadOrderSQL=function(e,t,n){if(t.isReferenceBased()){var r=t.getMainRefNode(),i=(r.isInverse(),r.getRefeDef()),o=r.isInverse()?i.getRefOwnerEnt().getName():i.getForeignEnt().getName();e.append(o+"Id")}},AppRuntime_Read.prototype.toReadSQL2=function(e,t,n,r,i,o,a,s){for(var p=i.iterator(),l=this.sqlMap.toTableShortNameByCount(o);p.hasNext();){var d=p.next();if(d instanceof PropNode){var u=d,f=u.getPropDef();!u.toBeSelected||r&&!r.contains(f.getName())||(0!=e.length()&&e.append(this.sqlMap.getSelectColumnSep()),e.append(this.getPropRefOperator(l,f,f.getStorageName())),e.append(this.sqlMap.getSQLAs()),s.model.FieldAs||(s.model.FieldAs={}),a?s.model.FieldAs[a]?s.model.FieldAs[a][f.getName()]==f.getName()?e.append(f.getStorageName().toUpperCase()):e.append(s.model.FieldAs[a][f.getName()].toUpperCase()):e.append(f.getStorageName().toUpperCase()):s.model.FieldAs[f.getName()]?s.model.FieldAs[f.getName()]==f.getName()?e.append(f.getStorageName().toUpperCase()):e.append(s.model.FieldAs[f.getName()].toUpperCase()):e.append(f.getStorageName().toUpperCase())),u.toBeCondition&&(0!=n.length()&&n.append(this.sqlMap.getSQLAnd()),n.append(this.getPropRefOperator(l,f,f.getStorageName())+"=?"))}else if(d instanceof RefeNode){var g=d,h=g.getChildren(),c=g.getRefeDef();if(null!=h){g.isInverse()?c.getRefOwnerEnt():c.getForeignEnt(),(null==r||0==r.length||null!=r&&r.contains(g.isInverse()?c.getInvName():c.getName()))&&(o++,t.append(this.toReadJoinSQL(g,l,o,g.isInverse())),o=this.toReadSQL2(e,t,t,null,h,o,g.isInverse()?c.getInvName():c.getName(),s))}}}return o},AppRuntime_Read.prototype.toReadJoinSQL=function(e,t,n,r){var i=new StringBuffer;if(e.toBeJoined||e.toBeRestricted){this.addLineBreak(i),e.toBeRestricted?i.append(this.sqlMap.getSQLInnerJoin()):i.append(this.sqlMap.getSQLLeftOuterJoin());var o=e.getRefeDef();this.toReadJoinOnSQL(o,r,!1,t,n,e.toBeRestricted,i)}return i.toString()},AppRuntime_Read.prototype.toReadJoinOnSQL=function(e,t,n,r,i,o,a){var s=!1;if(e.isInvFK())if(t){p=e.getRefOwnerEnt(),l=this.sqlMap.getTableName2(p,this.sqlMap.toTableShortNameByCount(i)),d=this.sqlMap.toTableShortNameByCount(i);a.append(l),a.append(this.sqlMap.getSQLOn());for(u=(m=e.getRefOwnerEnt()).getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(r,f,this.sqlMap.getFKColumnName(e,m,f))),a.append("="),a.append(this.getPropRefOperator(d,f,f.getStorageName())),s=!0}if(n)for(u=p.getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(r,f,f.getStorageName())),a.append("=?"),s=!0}}else{var p=e.getForeignEnt(),l=this.sqlMap.getTableName2(p,this.sqlMap.toTableShortNameByCount(i)),d=this.sqlMap.toTableShortNameByCount(i);a.append(l),a.append(this.sqlMap.getSQLOn());for(var u=(m=e.getRefOwnerEnt()).getPrimaryKey().iterator();u.hasNext();){var f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(r,f,f.getStorageName())),a.append("="),a.append(this.getPropRefOperator(d,f,this.sqlMap.getFKColumnName(e,m,f))),s=!0}if(n)for(u=p.getPrimaryKey().iterator();u.hasNext();){var f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(d,f,f.getStorageName())),a.append("=?"),s=!0}}else if(e.isFK())if(t){p=e.getRefOwnerEnt(),l=this.sqlMap.getTableName2(p,this.sqlMap.toTableShortNameByCount(i)),d=this.sqlMap.toTableShortNameByCount(i);a.append(l),a.append(this.sqlMap.getSQLOn());for(u=(c=e.getForeignEnt()).getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(r,f,f.getStorageName())),a.append("="),a.append(this.getPropRefOperator(d,f,this.sqlMap.getFKColumnName(e,c,f))),s=!0}if(n)for(u=p.getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(d,f,f.getStorageName())),a.append("=?"),s=!0}}else{var p=e.getForeignEnt(),l=this.sqlMap.getTableName2(p,this.sqlMap.toTableShortNameByCount(i)),d=this.sqlMap.toTableShortNameByCount(i);a.append(l),a.append(this.sqlMap.getSQLOn());for(var u=(c=e.getForeignEnt()).getPrimaryKey().iterator();u.hasNext();){var f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(r,f,this.sqlMap.getFKColumnName(e,c,f))),a.append("="),a.append(this.getPropRefOperator(d,f,f.getStorageName())),s=!0}if(n)for(u=p.getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(r,f,f.getStorageName())),a.append("=?"),s=!0}}else if(e.isLT()){var g=this.sqlMap.toRefTableShortNameByCount(i),h=this.sqlMap.getLTTableName(e,i);if(t){a.append(h),a.append(this.sqlMap.getSQLAs()),a.append(g),a.append(this.sqlMap.getSQLOn());var c;for(u=(c=e.getForeignEnt()).getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(r,f,f.getStorageName())),a.append("="),a.append(this.getPropRefOperator(g,f,this.sqlMap.getLTColumnName(c,f))),s=!0}p=e.getRefOwnerEnt();if(n)for(u=p.getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(g,f,this.sqlMap.getLTColumnName(p,f))),a.append("=?"),s=!0}this.addLineBreak(a),a.append(o?this.sqlMap.getSQLInnerJoin():this.sqlMap.getSQLLeftOuterJoin());l=this.sqlMap.getTableName2(p,this.sqlMap.toTableShortNameByCount(i));a.append(l),a.append(this.sqlMap.getSQLOn());d=this.sqlMap.toTableShortNameByCount(i);for(s=!1,u=p.getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(g,f,this.sqlMap.getLTColumnName(p,f))),a.append("="),a.append(this.getPropRefOperator(d,f,f.getStorageName())),s=!0}}else{a.append(h),a.append(this.sqlMap.getSQLAs()),a.append(g),a.append(this.sqlMap.getSQLOn());var m;for(u=(m=e.getRefOwnerEnt()).getPrimaryKey().iterator();u.hasNext();){var f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(r,f,f.getStorageName())),a.append("="),a.append(this.getPropRefOperator(g,f,this.sqlMap.getLTColumnName(m,f))),s=!0}p=e.getForeignEnt();if(n)for(u=p.getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(g,f,this.sqlMap.getLTColumnName(p,f))),a.append("=?"),s=!0}this.addLineBreak(a),a.append(o?this.sqlMap.getSQLInnerJoin():this.sqlMap.getSQLLeftOuterJoin());l=this.sqlMap.getTableName2(p,this.sqlMap.toTableShortNameByCount(i));a.append(l),a.append(this.sqlMap.getSQLOn());d=this.sqlMap.toTableShortNameByCount(i);for(s=!1,u=p.getPrimaryKey().iterator();u.hasNext();){f=u.next();s&&a.append(this.sqlMap.getSQLAnd()),a.append(this.getPropRefOperator(g,f,this.sqlMap.getLTColumnName(p,f))),a.append("="),a.append(this.getPropRefOperator(d,f,f.getStorageName())),s=!0}}}},AppRuntime_Read.prototype.getReadSQLRes=function(e,t,n,r,i,o,a){for(var s=e.iterator();s.hasNext();){var p=s.next();if(p instanceof PropNode){var l=p,d=l.getPropDef();if(l.toBeSelected&&(null==t||t.contains(d.getName()))){n++;var u=null;if(i){var f=o?i.getInvName():i.getName();u=a.model.FieldAs[f]?a.model.FieldAs[f][d.getName()]==d.getName()?d.getStorageName().toUpperCase():a.model.FieldAs[f][d.getName()].toUpperCase():d.getStorageName().toUpperCase()}else u=a.model.FieldAs[d.getName()]?a.model.FieldAs[d.getName()]==d.getName()?d.getStorageName().toUpperCase():a.model.FieldAs[d.getName()].toUpperCase():d.getStorageName().toUpperCase();var g=SQLUtil.getSQLResult(d,i,o,null,null,n,u,!0);r.push(g)}}else if(p instanceof RefeNode){var h=p,c=h.getChildren(),m=h.getRefeDef(),y=h.isInverse();e.isReferenceBased();if(null!=c){h.isInverse()?m.getRefOwnerEnt():m.getForeignEnt(),(null==t||t.contains(h.isInverse()?m.getInvName():m.getName()))&&(n=this.getReadSQLRes(c,null,n,r,m,y,a))}}}return n},AppRuntime_Read.prototype.setReadSQLParam=function(e,t,n){for(var r=e.iterator(),i=[];r.hasNext();){var o=r.next();if(o instanceof PropNode){var a=o,s=a.getPropDef();if(a.toBeCondition){n++;var p=SQLUtil.setSQLParam(s,null,!1,null,null,n,null);i.push(p)}}}return i},module.exports=exports=function(e,t,n){return new AppRuntime_Read(e,t,n)}},{"./arrayiterator.js":9,"./defs.js":10,"./hashmap.js":11,"./nodedef.js":13,"./sqlutil.js":14,"./stringbuffer.js":15}],7:[function(require,module,exports){"use strict";var defs=require("./defs.js"),AppDef=defs.AppDef,PropDef=defs.PropDef,StringBuffer=require("./stringbuffer.js"),arrayiterator=require("./arrayiterator.js"),HashMap=require("./hashmap.js");function AppRuntime_Schema(e,t,n){arrayiterator.enableIterator(),this.sqlMap=e,this.model=t,this.appDef=new AppDef(this.model),this.format=void 0===n||n,arrayiterator.disableIterator()}AppRuntime_Schema.prototype.addLineBreak=function(e){this.format?e.append("\n"):e.append("")},AppRuntime_Schema.prototype.stringify=function(e){return JSON.stringify(e)},AppRuntime_Schema.prototype.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},AppRuntime_Schema.prototype.escapeJSON=function(e){return e&&(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/[\\]/g,"\\\\")).replace(/[\"]/g,'\\"')).replace(/[\/]/g,"\\/")).replace(/[\b]/g,"\\b")).replace(/[\f]/g,"\\f")).replace(/[\n]/g,"\\n")).replace(/[\r]/g,"\\r")).replace(/[\t]/g,"\\t")),e},AppRuntime_Schema.prototype.getPropRefOperator=function(e,t,n,r){var i=" "+(e?e+".":"")+n,o=this.sqlMap.getFunction("GetRefOperator");return o&&(i=o(e,t,n,r)),i},AppRuntime_Schema.prototype.getTables=function(){for(var e=[],t=this.appDef.getEntities(),n=0;n<t.length;n++){try{e.push(t[n].getStorageName())}catch(e){alert("error:"+n+" "+t[n])}var r=t[n].getReference();if(r)for(var i=r.iterator();i.hasNext();){var o=i.next();o.isLT()&&e.push(this.sqlMap.getLTTableName(o))}}return e},AppRuntime_Schema.prototype.generateDataSchemaSQL=function(){arrayiterator.enableIterator();var e=new StringBuffer,t=this.appDef.getEntities();if(this.sqlMap.getKeyWord("NeedSchema")&&(e.append(this.sqlMap.getSQLCreateSchema()),e.append(this.appDef.name),e.append(";"),e.append("\n"),e.append(this.sqlMap.getSQLChooseSchema()),e.append(this.appDef.name),e.append(this.sqlMap.getSQLChooseSchemaEnd()),e.append(";"),e.append("\n")),this.sqlMap.getKeyWord("DatabaeInit"))for(var n=this.sqlMap.getKeyWord("DatabaeInit"),r=0;r<n.length;r++)e.append(n[r]),e.append("\n");this.sqlMap.getKeyWord("FK_Check")&&(e.append(this.sqlMap.getKeyWord("Disable_FK_Check")),e.append(";"),e.append("\n"));for(r=0;r<t.length;r++)e.append(this.dropRelationalTable(t[r])),e.append(";"),e.append("\n"),e.append(this.createRelationalTable(t[r])),e.append(";"),e.append("\n");for(var i=t.iterator();i.hasNext();)for(var o=i.next(),a=this.createLKTable(o).iterator();a.hasNext();)e.append(a.next()),e.append(";"),e.append("\n");return this.sqlMap.getKeyWord("FK_Check")&&(e.append(this.sqlMap.getKeyWord("Enable_FK_Check")),e.append(";"),e.append("\n")),arrayiterator.disableIterator(),e.toString()},AppRuntime_Schema.prototype.dropRelationalTable=function(e){var t=new StringBuffer;return t.append(this.sqlMap.getSQLDropTable()),t.append(this.sqlMap.getSQLIfExists()),t.append(e.getStorageName()),t.append(this.sqlMap.getKeyWord("DROP_CASCADE")),t.toString()},AppRuntime_Schema.prototype.createRelationalTable=function(entityDef){var sb=new StringBuffer;sb.append(this.sqlMap.getSQLCreateTable()),sb.append(entityDef.getStorageName()),sb.append(this.sqlMap.getSQLCreateTableColumnsBlockStart());var count=0,propertyList=entityDef.getProperty(),propIterator=propertyList.iterator();if(this.sqlMap.getKeyWord("NoSQL")&&eval(this.sqlMap.getKeyWord("NoSQL"))){for(var hasText=!1,hasColumn=!1;propIterator.hasNext();){var propDef=propIterator.next();"Id"==propDef.getPropType()?(sb.append(propDef.getStorageName().toUpperCase()),sb.append(this.getSQLType(propDef)),propDef.getNullable()&&!entityDef.isPK(propDef)||sb.append(this.sqlMap.getSQLNotNull()),sb.append(this.sqlMap.getIdentityColumnIncrement(propDef)),sb.append(this.sqlMap.getSelectColumnSep()),this.addLineBreak(sb)):"Text"==propDef.getPropType()?hasText=!0:hasColumn=!0}hasText&&(sb.append(this.sqlMap.getKeyWord("NoSQL_TextColumnName")+" "),sb.append(this.sqlMap.getKeyWord("NoSQL_DataType")),sb.append(this.sqlMap.getSelectColumnSep())),hasColumn?(sb.append(this.sqlMap.getKeyWord("NoSQL_ColumnName")+" "),sb.append(this.sqlMap.getKeyWord("NoSQL_DataType")),sb.append(this.sqlMap.getSQLNotNull())):(sb.append(this.sqlMap.getKeyWord("NoSQL_ColumnName")+" "),sb.append(this.sqlMap.getKeyWord("NoSQL_DataType")))}else{for(;propIterator.hasNext();){var propDef=propIterator.next();count>0&&(sb.append(this.sqlMap.getSelectColumnSep()),this.addLineBreak(sb)),count++,sb.append(propDef.getStorageName()),sb.append(this.getSQLType(propDef)),propDef.getNullable()&&!entityDef.isPK(propDef)||sb.append(this.sqlMap.getSQLNotNull()),sb.append(this.getDefault(propDef)),"Id"==propDef.getPropType()&&sb.append(this.sqlMap.getIdentityColumnIncrement(propDef))}var referenceList=entityDef.getReference();if(null!=referenceList)for(var refIterator=referenceList.iterator();refIterator.hasNext();){var refDef=refIterator.next();if(refDef.isFK())for(var foreignEnt=refDef.getForeignEnt(),primaryKeyList=foreignEnt.getPrimaryKey(),foreignKeyIterator=primaryKeyList.iterator();foreignKeyIterator.hasNext();){sb.append(this.sqlMap.getSelectColumnSep()),this.addLineBreak(sb);var foreignKey=foreignKeyIterator.next();sb.append(this.sqlMap.getFKColumnName(refDef,foreignEnt,foreignKey).toUpperCase()),sb.append(this.getSQLFKId(foreignKey)),refDef.isAnce()&&!refDef.isWeak()?sb.append(" NOT NULL "):sb.append(" DEFAULT NULL")}}var foreignReferenceList=entityDef.getForeignReference();if(null!=foreignReferenceList)for(var foreignRefIterator=foreignReferenceList.iterator();foreignRefIterator.hasNext();){var refDef=foreignRefIterator.next();if(refDef.isInvFK())for(var refOwnerEnt=refDef.getRefOwnerEnt(),primaryKeyList=refOwnerEnt.getPrimaryKey(),foreignKeyIterator=primaryKeyList.iterator();foreignKeyIterator.hasNext();){sb.append(this.sqlMap.getSelectColumnSep());var foreignKey=foreignKeyIterator.next();sb.append(this.sqlMap.getFKColumnName(refDef,refOwnerEnt,foreignKey).toUpperCase()),sb.append(this.getSQLFKId(foreignKey)),refDef.isDesc()&&!refDef.isWeak()?sb.append(" NOT NULL "):sb.append(" DEFAULT NULL")}}var uniqueProfList=entityDef.getUniqueProf(),uniqueCount=1;if(null!=uniqueProfList)for(var uniqueProfIterator=uniqueProfList.iterator();uniqueProfIterator.hasNext();){sb.append(this.sqlMap.getSelectColumnSep());var uniqueProfile=uniqueProfIterator.next();sb.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&sb.append("Unique"+uniqueCount++),sb.append(this.sqlMap.getSQLUnique()),sb.append("("),count=0;for(var uniqueProfPropertyList=uniqueProfile,uniqueProfproIterator=uniqueProfPropertyList.iterator();uniqueProfproIterator.hasNext();){var propDef=uniqueProfproIterator.next();count>0&&sb.append(this.sqlMap.getSelectColumnSep()),count++,sb.append(propDef.getStorageName().toUpperCase())}sb.append(")")}}var primaryKeyList=entityDef.getPrimaryKey();if(null==primaryKeyList)throw"No Primaty Key.";if(""!=this.sqlMap.getSQLPrimaryKey()){sb.append(this.sqlMap.getSelectColumnSep()),this.addLineBreak(sb),sb.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&sb.append(this.sqlMap.getSQLPK()+"_"+entityDef.getStorageName()+" "),sb.append(this.sqlMap.getSQLPrimaryKey()),sb.append("(");var pkIterator=primaryKeyList.iterator();for(count=0;pkIterator.hasNext();){var pk=pkIterator.next();count>0&&sb.append(this.sqlMap.getSelectColumnSep()),count++,sb.append(pk.getStorageName().toUpperCase())}sb.append(")")}return sb.append(this.sqlMap.getSQLCreateTableColumnsBlockEnd()),sb.toString()},AppRuntime_Schema.prototype.dropRelationLinkTable=function(e,t){var n=new StringBuffer;return n.append(this.sqlMap.getSQLDropTable()),n.append(this.sqlMap.getSQLIfExists()),n.append(this.sqlMap.getLTTableName(t)),n.toString()},AppRuntime_Schema.prototype.createRelationLinkTable=function(e,t){var n=new StringBuffer;return n.append(this.sqlMap.getSQLCreateTable()),n.append(this.sqlMap.getLTTableName(t)),n.append(this.sqlMap.getSQLCreateTableColumnsBlockStart()),this.createPrimaryKeyColumn(e,n),this.createForeignKeyColumn(t,n),""!=this.sqlMap.getSQLPrimaryKey()&&this.createPrimaryKey(t,n),this.sqlMap.getSupportForeignKey()&&(this.createForeignKey(t,n),this.createUniqueColumns(t,n)),n.append(this.sqlMap.getSQLCreateTableColumnsBlockEnd()),n.toString()},AppRuntime_Schema.prototype.createPrimaryKeyColumn=function(e,t){var n=new PropDef({Name:"SID",Type:"Id",Nullable:!1});t.append("SID"),t.append(this.getSQLType(n)),t.append(this.sqlMap.getNullableConstraint(e,n)),t.append(this.sqlMap.getIdentityColumnIncrement(n))},AppRuntime_Schema.prototype.createForeignKeyColumn=function(e,t){for(var n=e.getRefOwnerEnt(),r=n.getPrimaryKey().iterator();r.hasNext();){t.append(", "),this.addLineBreak(t);var i=r.next();t.append(this.sqlMap.getLTColumnName(n,i).toUpperCase()),t.append(this.getSQLFKId(i)),t.append(this.sqlMap.getSQLNotNull())}var o=e.getForeignEnt();for(r=o.getPrimaryKey().iterator();r.hasNext();){t.append(", "),this.addLineBreak(t);i=r.next();t.append(this.sqlMap.getLTColumnName(o,i).toUpperCase()),t.append(this.getSQLFKId(i)),t.append(this.sqlMap.getSQLNotNull())}},AppRuntime_Schema.prototype.createPrimaryKey=function(e,t){t.append(", "),this.addLineBreak(t),t.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&t.append(this.sqlMap.getSQLPK()+"_"+this.sqlMap.getLTTableName(e).toUpperCase()),t.append(" "),t.append(this.sqlMap.getSQLPrimaryKey()),t.append("("),t.append("SID"),t.append(")")},AppRuntime_Schema.prototype.createForeignKey=function(e,t){var n=e.getRefOwnerEnt(),r=e.getForeignEnt();t.append(", "),this.addLineBreak(t),t.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&t.append(this.sqlMap.getFKName(n,e).toUpperCase()),t.append(" "),t.append(this.sqlMap.getSQLForeignKey()),t.append("(");for(var i=0,o=n.getPrimaryKey().iterator();o.hasNext();){i>0&&t.append(", "),i++;var a=o.next();t.append(this.sqlMap.getLTColumnName(n,a))}for(t.append(") "),t.append(this.sqlMap.getSQLReferences()),t.append(n.getStorageName()),t.append("("),i=0,o=n.getPrimaryKey().iterator();o.hasNext();){i>0&&t.append(", "),i++;a=o.next();t.append(a.getStorageName().toUpperCase())}t.append(")"),t.append(this.sqlMap.getSQLOnDelete()),t.append(this.sqlMap.getSQLCascade()),t.append(this.sqlMap.getSQLOnUpdate()),t.append(this.sqlMap.getSQLRestrict()),t.append(","),this.addLineBreak(t),t.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&t.append(this.sqlMap.getFKName(r,n,e).toUpperCase()),t.append(" "),t.append(this.sqlMap.getSQLForeignKey()),t.append("("),i=0;for(var s=r.getPrimaryKey().iterator();s.hasNext();){i>0&&t.append(", "),i++;a=s.next();t.append(this.sqlMap.getLTColumnName(r,a).toUpperCase())}for(t.append(") "),t.append(this.sqlMap.getSQLReferences()),t.append(r.getStorageName()),t.append("("),i=0,s=r.getPrimaryKey().iterator();s.hasNext();){i>0&&t.append(", "),i++;a=s.next();t.append(a.getStorageName().toUpperCase())}t.append(") "),t.append(this.sqlMap.getSQLOnDelete()),t.append(this.sqlMap.getSQLCascade()),t.append(this.sqlMap.getSQLOnUpdate()),t.append(this.sqlMap.getSQLRestrict())},AppRuntime_Schema.prototype.createLKTable=function(e){var t=[],n=e.getReference();if(n)for(var r=n.iterator();r.hasNext();){var i=r.next();i.isLT()?(t.push(this.dropRelationLinkTable(e,i)),t.push(this.createRelationLinkTable(e,i))):t=t.concat(this.createForeignKeys(i))}return t=(t=t.concat(this.dropIndex(e))).concat(this.createIndex(e))},AppRuntime_Schema.prototype.createUniqueColumns=function(e,t){var n=e.getRefOwnerEnt(),r=e.getForeignEnt();if(e.is2One()){t.append(", "),this.addLineBreak(t),t.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&t.append(this.sqlMap.getSQLUnique()+"_"+n.getStorageName().toUpperCase()+"_"+e.getStorageName().toUpperCase()),t.append(this.sqlMap.getSQLUnique()),t.append("(");for(var i=0,o=n.getPrimaryKey().iterator();o.hasNext();){i>0&&t.append(", "),i++;var a=o.next();t.append(this.sqlMap.getLTColumnName(n,a))}t.append(") ")}if(e.isOne2()){t.append(", "),this.addLineBreak(t),t.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&t.append(this.sqlMap.getSQLUnique()+"_"+r.getStorageName().toUpperCase()+"_"+e.getStorageName().toUpperCase()),t.append(this.sqlMap.getSQLUnique()),t.append("(");i=0;for(var s=r.getPrimaryKey().iterator();s.hasNext();){i>0&&t.append(", "),i++;a=s.next();t.append(this.sqlMap.getLTColumnName(r,a))}t.append(") ")}if(!e.is2One()&&!e.isOne2()){t.append(", "),this.addLineBreak(t),t.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&t.append(this.sqlMap.getSQLUnique()+"_"+r.getStorageName().toUpperCase()+"_"+e.getStorageName().toUpperCase()),t.append(this.sqlMap.getSQLUnique()),t.append("(");for(i=0,o=n.getPrimaryKey().iterator();o.hasNext();){i>0&&t.append(", "),i++;a=o.next();t.append(this.sqlMap.getLTColumnName(n,a))}for(s=r.getPrimaryKey().iterator();s.hasNext();){i>0&&t.append(", "),i++;a=s.next();t.append(this.sqlMap.getLTColumnName(r,a))}t.append(") ")}},AppRuntime_Schema.prototype.createForeignKeys=function(e){if(this.sqlMap.getSupportForeignKey()){if(e.isFK())return this.createForeignKeysCode(e,e.getRefOwnerEnt(),e.getForeignEnt());if(e.isInvFK())return this.createForeignKeysCode(e,e.getForeignEnt(),e.getRefOwnerEnt())}return[]},AppRuntime_Schema.prototype.createForeignKeysCode=function(e,t,n){var r=[],i=new StringBuffer;i.append(this.sqlMap.getSQLAlterTable()),i.append(t.getStorageName().toUpperCase()),i.append(this.sqlMap.getSQLAdd()),i.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&i.append(this.sqlMap.getSQLFK()+"_"+e.getStorageName().toUpperCase()+"_"+t.getStorageName().toUpperCase()+"_"+n.getStorageName().toUpperCase()),i.append(" "),i.append(this.sqlMap.getSQLForeignKey()),i.append("(");for(var o=0,a=n.getPrimaryKey().iterator();a.hasNext();){o>0&&i.append(", "),o++;var s=a.next();i.append(this.sqlMap.getFKColumnName(e,n,s).toUpperCase())}for(i.append(") "),i.append(this.sqlMap.getSQLReferences()),i.append(n.getStorageName()),i.append("( "),o=0,a=n.getPrimaryKey().iterator();a.hasNext();){o>0&&i.append(", "),o++;s=a.next();i.append(s.getStorageName().toUpperCase())}if(i.append(") "),e.isDesc()||e.isAnce()?(i.append(this.sqlMap.getSQLOnDelete()),i.append(this.sqlMap.getSQLCascade()),i.append(this.sqlMap.getSQLOnUpdate()),i.append(this.sqlMap.getSQLRestrict())):(i.append(this.sqlMap.getSQLOnDelete()),i.append(this.sqlMap.getSQLRestrict()),i.append(this.sqlMap.getSQLOnUpdate()),i.append(this.sqlMap.getSQLRestrict())),r.push(i.toString()),e.is2One()&&e.isOne2()){for((i=new StringBuffer).append(this.sqlMap.getSQLAlterTable()),i.append(t.getStorageName().toUpperCase()),i.append(this.sqlMap.getSQLAdd()),i.append(this.sqlMap.getSQLConstraint()),this.sqlMap.getSupportConstraintName()&&i.append(this.sqlMap.getSQLUnique()+"_"+t.getStorageName().toUpperCase()+"_"+e.getStorageName().toUpperCase()),i.append(this.sqlMap.getSQLUnique()),i.append("("),o=0,a=n.getPrimaryKey().iterator();a.hasNext();){o>0&&i.append(", "),o++;s=a.next();i.append(this.sqlMap.getFKColumnName(e,n,s).toUpperCase())}i.append(") "),r.push(i.toString())}return r},AppRuntime_Schema.prototype.dropIndex=function(entityDef){var sql=[];if(this.sqlMap.getKeyWord("NoSQL")&&eval(this.sqlMap.getKeyWord("NoSQL")))return sql;var name=entityDef.getName();if(null!=entityDef.getIndexProf())for(var iterator=entityDef.getIndexProf().iterator(),count=1;iterator.hasNext();){var sb=new StringBuffer;sb.append(this.sqlMap.getSQLDropIndex()),sb.append(this.sqlMap.getSQLIfExists());var indexProf=iterator.next();sb.append(name+"_idx"+count++),sql.push(sb.toString())}return sql},AppRuntime_Schema.prototype.createIndex=function(entityDef){var sql=[];if(this.sqlMap.getKeyWord("NoSQL")&&eval(this.sqlMap.getKeyWord("NoSQL"))){if(this.sqlMap.getKeyWord("CreateNoSQLIndex")){var f=this.sqlMap.getKeyWord("CreateNoSQLIndex");sql=f(entityDef.getStorageName(),entityDef)}return sql}var name=entityDef.getName();if(null!=entityDef.getIndexProf())for(var iterator=entityDef.getIndexProf().iterator(),count=1;iterator.hasNext();){var sb=new StringBuffer;sb.append(this.sqlMap.getSQLCreateIndex());var indexProf=iterator.next();sb.append(name+"_idx"+count++),sb.append(this.sqlMap.getSQLOn()),sb.append(entityDef.getStorageName()),sb.append("(");for(var propertyList=indexProf,propertyIterator=propertyList.iterator(),count=0;propertyIterator.hasNext();){count>0&&sb.append(", "),count++;var propDef=propertyIterator.next();sb.append(propDef.getStorageName())}sb.append(") "),sql.push(sb.toString())}return sql},AppRuntime_Schema.prototype.getSQLFKId=function(e){if("id"===e.getPropType().toLowerCase())return this.sqlMap.getKeyWord("Type_FKId")},AppRuntime_Schema.prototype.getSQLType=function(e){if("boolean"===e.getPropType().toLowerCase())return this.sqlMap.getTypeBoolean();if("date"===e.getPropType().toLowerCase())return this.sqlMap.getTypeDate();if("datetime"===e.getPropType().toLowerCase())return this.sqlMap.getTypeDateTime();if("double"===e.getPropType().toLowerCase())return this.sqlMap.getTypeDouble();if("float"===e.getPropType().toLowerCase())return this.sqlMap.getTypeFloat();if("decimal"===e.getPropType().toLowerCase()){var t=e.getScale(),n=e.getPrecision();return n?t?this.sqlMap.getTypeDecimal()+"("+n+","+t+")":this.sqlMap.getTypeDecimal()+"("+n+")":this.sqlMap.getTypeDecimal()}if("integer"===e.getPropType().toLowerCase())return this.sqlMap.getTypeInteger();if("id"===e.getPropType().toLowerCase())return this.sqlMap.getTypeId();if("long"===e.getPropType().toLowerCase())return this.sqlMap.getTypeLong();if("short"===e.getPropType().toLowerCase())return this.sqlMap.getTypeShort();if("string"===e.getPropType().toLowerCase())return null!=e.getMaxLen()?this.sqlMap.getTypeString()+"("+e.getMaxLen()+")":this.sqlMap.getTypeString()+"(64)";if("text"===e.getPropType().toLowerCase())return this.sqlMap.getTypeText();if("time"===e.getPropType().toLowerCase())return this.sqlMap.getTypeTime();if("timestamp"===e.getPropType().toLowerCase())return this.sqlMap.getTypeTimeStamp();throw"Unsupported Column Type: "+e.getPropType()},AppRuntime_Schema.prototype.getDefault=function(e){if("boolean"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+(e.getDefaultValue()?this.sqlMap.getTrueValue():this.sqlMap.getFalseValue())}else if("date"===e.getPropType().toLowerCase()){if(this.sqlMap.getKeyWord("NotAllowDateDefaultValue"))return"";if(e.getCurrent())return this.sqlMap.getSQLDefault()+this.sqlMap.getCurrentDate();if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+"'"+e.getDefaultValue()+"'"}else if("datetime"===e.getPropType().toLowerCase()){if(e.getCurrent())return this.sqlMap.getSQLDefault()+this.sqlMap.getCurrentTimeStamp();if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+"'"+e.getDefaultValue()+"'"}else if("double"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+e.getDefaultValue()}else if("float"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+e.getDefaultValue()}else if("decimal"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+e.getDefaultValue()}else if("integer"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+e.getDefaultValue()}else if("id"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+e.getDefaultValue()}else if("long"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+e.getDefaultValue()}else if("short"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+e.getDefaultValue()}else if("string"===e.getPropType().toLowerCase()){if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+"'"+e.getDefaultValue()+"'"}else if("text"===e.getPropType().toLowerCase()){if(this.sqlMap.getKeyWord("NotAllowTextDefaultValue"))return"";if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+"'"+e.getDefaultValue()+"'"}else if("time"===e.getPropType().toLowerCase()){if(this.sqlMap.getKeyWord("NotAllowTimeDefaultValue"))return"";if(e.getCurrent())return this.sqlMap.getSQLDefault()+this.sqlMap.getCurrentTime();if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+"'"+e.getDefaultValue()+"'"}else{if("timestamp"!==e.getPropType().toLowerCase())throw"Unsupported Column Type: "+e.getPropType();if(e.getCurrent())return this.sqlMap.getSQLDefault()+this.sqlMap.getCurrentTimeStamp();if(null!=e.getDefaultValue())return this.sqlMap.getSQLDefault()+"'"+e.getDefaultValue()+"'"}},module.exports=exports=function(e,t,n){return new AppRuntime_Schema(e,t,n)}},{"./arrayiterator.js":9,"./defs.js":10,"./hashmap.js":11,"./stringbuffer.js":15}],8:[function(e,t,n){"use strict";var r=e("./defs.js").AppDef,i=e("./stringbuffer.js"),o=e("./arrayiterator.js"),a=e("./hashmap.js"),s=e("./nodedef.js"),p=s.AbstractEntDefNodeListBuilder,l=s.AbstractRefDefNodeListBuilder,d=s.FieldNodeList,u=s.RefeNode,f=s.PropNode,g=(s.InsertEntNodeListBuilder,s.InsertEntJoinNodeListBuilder,s.InsertRefNodeListBuilder),h=(s.InsertRefJoinNodeListBuilder,e("./appruntime_insert.js")),c=e("./appruntime_query.js"),m=e("./sqlutil.js");function y(){p.call(this)}function N(){p.call(this)}function S(){l.call(this)}function T(){l.call(this)}function R(){p.call(this)}function L(e,t){this.sqlMap=e,this.model=t,this.appDef=new r(this.model),this.insertsql=h(e,t),this.querysql=c(e,t)}y.prototype=new p,y.prototype.constructor=y,y.prototype.requiredProp=function(e,t,n){return!0},y.prototype.requiredRefe=function(e,t,n,r){return r?n.isOne2()&&n.isInvFK():n.is2One()&&n.isFK()||n.isAnce()&&n.isWeak()},y.prototype.updatePropNode=function(e,t,n){t.isPK(n.getPropDef())?n.toBeCondition=!0:n.toBeUpdated=!0},y.prototype.updateRefeNode=function(e,t,n,r){n.toBeJoined=!0;var i=null;r?(i=n.getRefeDef().getRefOwnerEnt(),n.inverse=!0):(i=n.getRefeDef().getForeignEnt(),n.inverse=!1);var o=new d;(new N).buildNodeList(o,i),n.children=o},N.prototype=new p,N.prototype.constructor=N,N.prototype.requiredProp=function(e,t,n){return t.isPK(n)},N.prototype.updatePropNode=function(e,t,n){n.toBeUpdated=!0},S.prototype=new l,S.prototype.constructor=S,S.prototype.requiredProp=function(e,t,n,r){return e.isPK(t)},S.prototype.requiredRefe=function(e,t,n){if(n){if(t.isOne2()){if(t.is2One()){if(t.isFK()&&t.isAnce())return!0;if(t.isLT())return!0;if(t.isInvFK()&&!t.isDesc())return!0}else if(t.is2Many()&&t.isLT()&&t.isBi())return!0}else if(t.isMany2())if(t.is2One()){if(t.isFK()){if(t.isBi()||t.isAnce())return!0}else if(t.isLT()&&t.isBi())return!0}else if(t.is2Many()&&t.isLT()&&t.isBi())return!0}else if(t.is2One()){if(t.isOne2()){if(t.isInvFK())return!0;if(t.isLT())return!0;if(t.isDesc()&&t.isWeak())return!0}else if(t.isMany2()&&t.isLT()&&t.isBi())return!0}else if(t.is2Many())if(t.isOne2()){if(t.isInvFK())return!0;if(t.isLT())return!0}else if(t.isMany2())return!0;return!1},S.prototype.updatePropNode=function(e,t,n,r){r?n.isOne2()?n.is2One()?n.isFK()&&n.isAnce()&&!n.isWeak()?t.toBeCondition=!0:n.isFK()&&n.isWeak()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isInvFK()||n.isLT()&&(t.toBeCondition=!0):n.is2Many()&&(n.isInvFK()||n.isLT()&&(t.toBeCondition=!0)):n.isMany2()&&(n.is2One()?n.isFK()?n.isBi()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isAnce()&&n.isWeak()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isAnce()&&(t.toBeCondition=!0):n.isLT()&&n.isBi()&&(t.toBeCondition=!0):n.is2Many()&&(t.toBeCondition=!0)):n.is2One()?n.isOne2()?n.isInvFK()?n.isDesc()&&n.isWeak()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isDesc()&&n.isDescDeletable()?t.toBeCondition=!0:(t.toBeUpdated=!0,t.toBeCondition=!0):n.isLT()&&(t.toBeCondition=!0):n.isMany2()&&n.isLT()&&n.isBi()&&(t.toBeCondition=!0):n.is2Many()&&(n.isOne2()?n.isInvFK()?n.isDesc()&&n.isWeak()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isDesc()&&n.isDescDeletable()?t.toBeCondition=!0:(t.toBeUpdated=!0,t.toBeCondition=!0):n.isLT()&&(t.toBeCondition=!0):n.isMany2()&&(t.toBeCondition=!0))},S.prototype.updateRefeNode=function(e,t,n){var r=t.getRefeDef();n?r.isOne2()?r.is2One()?r.isFK()?t.toBeJoined=!0:r.isLT()?t.toBeJoined=!0:r.isInvFK()&&(t.toBeJoined=!0):r.is2Many()&&r.isLT()&&(t.toBeJoined=!0):r.isMany2()&&(r.is2One()?r.isFK()?(r.isBi()||r.isAnce())&&(t.toBeJoined=!0):r.isLT()&&r.isBi()&&(t.toBeJoined=!0):r.is2Many()&&r.isLT()&&r.isBi()&&(t.toBeJoined=!0)):r.is2One()?r.isOne2()?r.isDesc()&&!r.isDescDeletable()?t.toBeDeleted=!0:r.isInvFK()?t.toBeJoined=!0:r.isLT()&&(t.toBeJoined=!0):r.isMany2()&&r.is2One()&&r.isLT()&&r.isBi()&&(t.toBeJoined=!0):r.is2Many()&&(r.isDesc()&&!r.isDescDeletable()?t.toBeDeleted=!0:r.isInvFK()?t.toBeJoined=!0:r.isLT()&&(t.toBeJoined=!0))},T.prototype=new l,T.prototype.constructor=T,T.prototype.requiredProp=function(e,t,n,r){return e.isPK(t)},T.prototype.requiredRefe=function(e,t,n){if(n){if(t.isOne2()){if(t.is2One()){if(t.isFK()&&t.isAnce())return!0;if(t.isLT())return!0}else if(t.is2Many()&&t.isLT()&&t.isBi())return!0}else if(t.isMany2())if(t.is2One()){if(t.isFK()){if(t.isBi()||t.isAnce())return!0}else if(t.isLT()&&t.isBi())return!0}else if(t.is2Many()&&t.isLT()&&t.isBi())return!0}else if(t.is2One()){if(t.isOne2()){if(t.isInvFK())return!0;if(t.isLT())return!0}else if(t.isMany2()&&t.isLT()&&t.isBi())return!0}else if(t.is2Many())if(t.isOne2()){if(t.isInvFK())return!0;if(t.isLT())return!0}else if(t.isMany2())return!0;return!1},T.prototype.updatePropNode=function(e,t,n,r){r?n.isOne2()?n.is2One()?n.isFK()&&n.isAnce()?t.toBeCondition=!0:n.isInvFK()||n.isLT()&&(t.toBeCondition=!0):n.is2Many()&&(n.isInvFK()||n.isLT()&&(t.toBeCondition=!0)):n.isMany2()&&(n.is2One()?n.isFK()?n.isBi()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isAnce()&&n.isWeak()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isAnce()&&(t.toBeCondition=!0):n.isLT()&&n.isBi()&&(t.toBeCondition=!0):n.is2Many()&&(t.toBeCondition=!0)):n.is2One()?n.isOne2()?n.isInvFK()?n.isDesc()&&n.isDescDeletable()?t.toBeCondition=!0:(t.toBeUpdated=!0,t.toBeCondition=!0):n.isLT()&&(t.toBeCondition=!0):n.isMany2()&&n.isLT()&&n.isBi()&&(t.toBeCondition=!0):n.is2Many()&&(n.isOne2()?n.isInvFK()?n.isDesc()&&n.isWeak()?(t.toBeUpdated=!0,t.toBeCondition=!0):n.isDesc()&&n.isDescDeletable()?t.toBeCondition=!0:(t.toBeUpdated=!0,t.toBeCondition=!0):n.isLT()&&(t.toBeCondition=!0):n.isMany2()&&(t.toBeCondition=!0))},T.prototype.updateRefeNode=function(e,t,n){var r=t.getRefeDef();if(n?r.isOne2()?r.is2One()?r.isFK()?t.toBeJoined=!0:r.isLT()&&(t.toBeJoined=!0):r.is2Many()&&r.isLT()&&(t.toBeJoined=!0):r.isMany2()&&(r.is2One()?r.isFK()?(r.isBi()||r.isAnce())&&(t.toBeJoined=!0):r.isLT()&&r.isBi()&&(t.toBeJoined=!0):r.is2Many()&&r.isLT()&&r.isBi()&&(t.toBeJoined=!0)):r.is2One()?r.isOne2()?r.isDesc()&&!r.isDescDeletable()?t.toBeDeleted=!0:r.isInvFK()?t.toBeJoined=!0:r.isLT()&&(t.toBeJoined=!0):r.isMany2()&&r.is2One()&&r.isLT()&&r.isBi()&&(t.toBeJoined=!0):r.is2Many()&&(r.isDesc()&&!r.isDescDeletable()?t.toBeDeleted=!0:r.isInvFK()?t.toBeJoined=!0:r.isLT()&&(t.toBeJoined=!0)),t.toBeJoined){var i=null;n?(i=t.getRefeDef().getRefOwnerEnt(),t.setInverse(!0)):(i=t.getRefeDef().getForeignEnt(),t.setInverse(!1));var o=new d;t.setChildren(o),(new R).buildNodeList(o,i)}},R.prototype=new p,R.prototype.constructor=R,R.prototype.requiredProp=function(e,t,n){return t.isPK(n)},R.prototype.updatePropNode=function(e,t,n){n.toBeCondition=!0},L.prototype.generateUpdateObjSQL=function(e){o.enableIterator();var t=[],n=new d,r=new y,i=e.entDef;r.buildNodeList(n,i);for(var a=(new S).buildNodeList(i),s=(new g).buildNodeList(i),p=e.field,l=a.iterator();l.hasNext();){var u=(m=l.next()).getMainRefNode(),f=u.isInverse(),h=u.getRefeDef(),c=f?h.getInvName():h.getName();p.contains(c)&&(null!=u&&u.toBeJoined&&t.push(this.processRemoveRef(u,m,e)))}for(l=s.iterator();l.hasNext();){var m,N=(m=l.next()).getMainRefNode();f=N.isInverse(),h=N.getRefeDef(),c=f?h.getInvName():h.getName();p.contains(c)&&(N.isDesc()&&!N.isWeak()||t.push(this.insertsql.processInsertRef(N,m,h,e)))}return t.push(this.processUpdate(n,e)),o.disableIterator(),t},L.prototype.generateRemoveRefeSQL=function(e){o.enableIterator();for(var t=[],n=(e.field,e.entDef),r=(new T).buildNodeList(n).iterator();r.hasNext();){var i=r.next(),a=i.getMainRefNode(),s=a.isInverse(),p=a.getRefeDef(),l=s?p.getInvName():p.getName();if(!(e.inverse&&e.refeDef.getInvName()!=l||!e.inverse&&e.refeDef.getName()!=l)){var d=this.toUpdateSQL(i,e),u=this.setUpdateSQLParam(i,e);t.push({SQL:d,Param:u,SQLType:"UPDATE",FUNCType:"DELETEREF"})}}return o.disableIterator(),t},L.prototype.generateAddRefeSQL=function(e){o.enableIterator();for(var t=[],n=(e.field,e.entDef),r=(new g).buildNodeList(n).iterator();r.hasNext();){var i=r.next(),a=i.getMainRefNode(),s=a.isInverse(),p=a.getRefeDef(),l=s?p.getInvName():p.getName();if(!(e.inverse&&e.refeDef.getInvName()!=l||!e.inverse&&e.refeDef.getName()!=l)){var d=this.insertsql.processInsertRef(a,i,p,e);t.push({SQL:d.SQL,Param:d.Param,SQLType:"UPDATE",FUNCType:a.isMany()?"INSERTREFMANY":"INSERTREFONE"})}}return o.disableIterator(),t},L.prototype.processUpdate=function(e,t){var n=this.toUpdateSQL(e,t),r=null,i=t.conditions.length>0;return r=this.setUpdateSQLParam(e,t,!1,i),i&&(null==r&&(r=[]),this.querysql.setQuerySQLParam(t.conditions,r,null,r.length)),{SQL:n,Param:r,SQLType:"UPDATE",FUNCType:"UPDATE"}},L.prototype.processRemoveRef=function(e,t,n){return{SQL:this.toUpdateSQL(t,n),Param:this.setUpdateSQLParam(t,n,!0,!1),SQLType:"UPDATE",FUNCType:"REMOVEREF"}},L.prototype.toUpdateSQL=function(e,t){var n=t.field,r=t.model.Value,o=t.entDef,s=!1,p=o.getStorageName(),l=new i,d=new i,g=new i,h=new i,c=new i,m=null,y=null,N=null,S=!1,T=!1,R=!1,L=!1;e.isReferenceBased()&&(S=(N=(y=e.getMainRefNode()).getRefeDef()).isAnce(),T=N.isDesc(),R=N.isBi(),L=N.isWeak(),N.isLT()?(p=this.sqlMap.getLTTableName(N),s=!0,m=y.isInverse()?N.getForeignEnt():o,0!=d.length()&&d.append(this.sqlMap.getSelectColumnSep())):N.isFK()?(p=N.getRefOwnerEnt().getStorageName(),R||L&&"Delete"!=t.type||(s=!0)):N.isInvFK()&&(!T||L&&"Delete"!=t.type||(s=!0),p=N.getForeignEnt().getStorageName()));for(var v=e.iterator();v.hasNext();){var C=v.next();if(C instanceof f){var D=(P=C).getPropDef();if(e.isReferenceBased())N.isLT()?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getLTColumnName(m,D)),g.append("=?")):N.isFK()?y.isInverse()?R?(P.toBeCondition&&(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getFKColumnName(N,o,D,!0)),g.append("="+this.sqlMap.getFKValue("?",!0))),P.toBeUpdated&&(d.length()>0&&d.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getFKColumnName(N,o,D,!1)),d.append("="+this.sqlMap.getFKValue("?",!1)))):S&&L?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getFKColumnName(N,o,D,!0)),g.append("="+this.sqlMap.getFKValue("?",!0)),d.length()>0&&d.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getFKColumnName(N,o,D,!1)),d.append("="+this.sqlMap.getFKValue("?",!1))):S?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getFKColumnName(N,o,D,!0)),g.append("="+this.sqlMap.getFKValue("?",!0))):(d.length()>0&&d.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getFKColumnName(N,o,D,!1)),d.append("="+this.sqlMap.getFKValue("?",!1))):(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(D.getStorageName()),g.append("=?")):N.isInvFK()&&(y.isInverse()?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(D.getStorageName()),g.append("=?")):T&&L?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getFKColumnName(N,o,D,!0)),g.append("="+this.sqlMap.getFKValue("?",!0)),d.length()>0&&d.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getFKColumnName(N,o,D,!1)),d.append("="+this.sqlMap.getFKValue("?",!1))):T?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getFKColumnName(N,o,D,!0)),g.append("="+this.sqlMap.getFKValue("?",!0))):(P.toBeCondition&&(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getFKColumnName(N,o,D,!0)),g.append("="+this.sqlMap.getFKValue("?",!0))),P.toBeUpdated&&(d.length()>0&&d.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getFKColumnName(N,o,D,!1)),d.append("="+this.sqlMap.getFKValue("?",!1)))));else if(P.toBeCondition)"Text"==D.getPropType()?(c.length()>0&&c.append(this.sqlMap.getSQLAnd()),c.append(D.getStorageName()),c.append("=?")):(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(D.getStorageName()),g.append("=?"));else if(P.toBeUpdated&&n.contains(D.getName())){var I=n.indexOf(D.getName());"Text"==D.getPropType()?(h.length()>0&&h.append(this.sqlMap.getSelectColumnSep()),h.append(D.getStorageName()),r&&r.length>I&&null!=r[I]?h.append("="+this.formatPropValue(r[I],D)):h.append("=?")):(d.length()>0&&d.append(this.sqlMap.getSelectColumnSep()),d.append(D.getStorageName()),r&&r.length>I&&null!=r[I]?d.append("="+this.formatPropValue(r[I],D)):d.append("=?"))}}else if(C instanceof u&&C.toBeJoined){var M=C,E=M.getRefeDef(),O=M.isInverse();if(null==M.getChildren())continue;if(!e.isReferenceBased()){if(!n.contains(O?E.getInvName():E.getName()))continue;E.isFK()?M.isInverse()?(s=!0,p=M.getRefeDef().getRefOwnerEnt().getStorageName()):p=o.getStorageName():E.isInvFK()?M.isInverse()?p=o.getStorageName():(s=!0,p=M.getRefeDef().getForeignEnt().getStorageName()):E.isLT()&&(p=this.sqlMap.getLTTableName())}for(var q=M.getChildren().iterator();q.hasNext();){var Q=q.next();if(Q instanceof f){var P;D=(P=Q).getPropDef();E.isFK()?M.isInverse()?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(D.getStorageName()),g.append("=?")):(0!=d.length()&&d.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getFKColumnName2(M.getRefeDef(),D,M.isInverse(),!1)),d.append("="+this.sqlMap.getFKValue2("?",!1))):E.isInvFK()?M.isInverse()?P.toBeUpdated&&(0!=d.length()&&d.append(this.sqlMap.getSelectColumnSep()),d.append(this.sqlMap.getFKColumnName2(M.getRefeDef(),D,M.isInverse(),!1)),d.append("="+this.sqlMap.getFKValue("?",!1))):P.toBeCondition&&(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(D.getStorageName()),g.append("=?")):E.isLT()&&(M.isInverse()?(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getLTColumnName(M.getRefeDef().getRefOwnerEnt(),D)),g.append("=?")):(g.length()>0&&g.append(this.sqlMap.getSQLAnd()),g.append(this.sqlMap.getLTColumnName(M.getRefeDef().getForeignEnt(),D)),g.append("=?")))}}}}if(s)l.append(this.sqlMap.getSQLDelete()),l.append(p),l.append(this.sqlMap.getSQLWhere()),l.append(g.toString());else if(d.length()>0||h.length()>0){var F=this.sqlMap.getFunction("GenerateUpdateCommand");if(F){var A=new i;if(0==t.conditions.length)A.append(this.sqlMap.getSQLWhere()),A.append(g.toString());else{var B=new i,b=new i,x=new a,w=new a,K=new a,_=new i;this.querysql.toWhereSQL(B,b,_,t.conditions,x,w,K,!0),A.append(b.length()>0?this.sqlMap.getSQLWhere():""),A.append(b.toString())}l.append(F(p,d.toString(),A.toString(),h.toString()))}else if(l.append(this.sqlMap.getSQLUpdate()),l.append(p),l.append(this.sqlMap.getSQLSet()),l.append(d.toString()),0!=d.length()&&0!=h.length()&&l.append(this.sqlMap.getSelectColumnSep()),0!=h.length()&&l.append(h.toString()),l.append(this.sqlMap.getSQLWhere()),0==t.conditions.length)l.append(g.toString()),0!=g.length()&&0!=c.length()&&l.append(this.sqlMap.getSelectColumnSep()),0!=c.length()&&l.append(c.toString());else{B=new i,b=new i,x=new a,w=new a,K=new a,_=new i;this.querysql.toWhereSQL(B,b,_,t.conditions,x,w,K,!0),l.append(b.toString())}}return l.toString()},L.prototype.setUpdateSQLParam=function(e,t,n,r){for(var i=t.field,o=t.model.Value,a=e.iterator(),s=0,p=[],l=[];a.hasNext();){if((T=a.next())instanceof f){if(-1!=(g=i.indexOf(T.getPropDef().getName()))&&o&&o.length>g&&null!=o[g])continue;if(T.toBeUpdated&&(n||0==i.length||i.contains(T.getPropDef().getName()))&&"Text"!=(S=T.getPropDef()).getPropType()){s++;var d=m.setSQLParam(S,null,!1,null,null,s,null,-1);p.push(d)}}}for(a=e.iterator();a.hasNext();){if((T=a.next())instanceof f){var g;if(-1!=(g=i.indexOf(T.getPropDef().getName()))&&o&&o.length>g&&null!=o[g])continue;if(T.toBeUpdated&&(n||0==i.length||i.contains(T.getPropDef().getName()))&&"Text"==(S=T.getPropDef()).getPropType()){s++;d=m.setSQLParam(S,null,!1,null,null,s,null,-1);l.push(d)}}}for(a=e.iterator();a.hasNext();){if((T=a.next())instanceof u)for(var h=(L=T).getChildren().iterator();h.hasNext();){var c=h.next(),y=L.isInverse(),N=T.getRefeDef();if(i.contains(y?N.getInvName():N.getName()))if(L.isOne()){if(c instanceof f&&c.toBeUpdated){var S=c.getPropDef();s++;d=m.setSQLParam(S,N,y,null,null,s,null,-1);p.push(d)}}else if(L.isMany()&&c instanceof f&&c.toBeUpdated){S=c.getPropDef();s++;d=m.setSQLParam(S,N,y,null,null,s,null,-1);p.push(d)}}}if(p=p.concat(l),r)return p;for(a=e.iterator();a.hasNext();){var T;if((T=a.next())instanceof f){if(T.toBeCondition){S=T.getPropDef();s++;var R="Prop";if(e.isReferenceBased()){N=(L=e.mainRefNode).getRefeDef(),y=L.isInverse();N.isFK()?R="FK":N.isInvFK()?R="InvFK":N.isLT()&&(R="LT")}d=m.setSQLParam(S,null,!1,null,null,s,null,-1,R);p.push(d)}}else if(T instanceof u&&null!=T.getChildren()){var L;for(h=(L=T).getChildren().iterator();h.hasNext();){c=h.next(),y=L.isInverse(),R="";if((N=T.getRefeDef()).isFK()?R="FK":N.isInvFK()?R="InvFK":N.isLT()&&(R="LT"),i.contains(y?N.getInvName():N.getName()))if(L.isOne()){if(c instanceof f&&c.toBeCondition){S=c.getPropDef();s++;d=m.setSQLParam(S,N,y,null,null,s,null,-1,R);p.push(d)}}else if(L.isMany()&&c instanceof f&&c.toBeCondition){S=c.getPropDef();s++;d=m.setSQLParam(S,N,y,null,null,s,null,-1,R);p.push(d)}}}}return p},t.exports=function(e,t,n){return new L(e,t,n)}},{"./appruntime_insert.js":4,"./appruntime_query.js":5,"./arrayiterator.js":9,"./defs.js":10,"./hashmap.js":11,"./nodedef.js":13,"./sqlutil.js":14,"./stringbuffer.js":15}],9:[function(e,t,n){"use strict";function r(e){this.index=0,this.items=e}r.prototype={first:function(){return this.reset(),this.next()},next:function(){return this.items[this.index++]},hasNext:function(){return this.index<this.items.length},reset:function(){this.index=0},each:function(e){for(var t=this.first();this.hasNext();t=this.next())e(t)}},t.exports={enableIterator:function(){Array.prototype.iterator=function(){return new r(this)},Array.prototype.contains=function(e){return-1!=this.indexOf(e)},Array.prototype.clone=function(e){for(var t=[],n=0;n<this.length;n++)t[n]=this[n];return t}},disableIterator:function(){delete Array.prototype.iterator,delete Array.prototype.contains,delete Array.prototype.clone}}},{}],10:[function(e,t,n){"use strict";var r=e("./hashmap.js");function i(e){this.model=e,this.entities=new Array,this.actions=new Array,this.pages=new Array,this.entMap=new r,this.actMap=new r,this.pageMap=new r,this.name=this.model.Name;for(var t=0;t<e.Entity.length;t++){var n=e.Entity[t],i=new o(n,this);this.entities.push(i),this.entMap.put(n.Name,i)}for(var a=0;a<this.entities.length;a++)this.entities[a].buildFgRefe();if(e.Action)for(t=0;t<e.Action.length;t++){var s=e.Action[t];if(i=this.entMap.get(s.Entity))if("Query"===s.Type||"QueryRef"===s.Type||"QueryRefCandidate"===s.Type){var d=new l(s,i,this);this.actions.push(d),this.actMap.put(s.Name,d)}else{var u=new p(s,i,this);this.actions.push(u),this.actMap.put(s.Name,u)}}if(e.Page)for(t=0;t<e.Page.length;t++){var f=e.Page[t];this.pages.push(f),this.pageMap.put(f.Name,f)}}function o(e,t){this.model=e,this.name=this.model.Name,this.appDef=t,this.model.Property||(this.model.Property=[]),this.props=new Array,this.props.push(new a({Name:this.model.Name+"Id",Type:"Id",PrimaryKey:!0},this));for(var n=this.model.Property,r=0;r<n.length;r++){var i=n[r];this.props.push(new a(i,this))}this.refes=new Array;var o=this.model.Reference;if(o)for(r=0;r<o.length;r++){var p=o[r];this.refes.push(new s(p,this))}this.fgrefes=new Array}function a(e,t){this.model=e,this.entDef=t,this.name=this.model.Name,this.type=this.model.Type}function s(e,t){this.model=e,this.entDef=t,this.model.OwnerEntity=t.name,"One2One"==this.model.RefeType?(this.model.Type="One2One",this.model.ForeignKey=!1,this.model.LinkTable=!0,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!0):"One2One-S"==this.model.RefeType?(this.model.Type="One2One",this.model.ForeignKey=!0,this.model.LinkTable=!1,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!1):"One2One-I"==this.model.RefeType?(this.model.Type="One2One",this.model.ForeignKey=!1,this.model.LinkTable=!1,this.model.InverseForeignKey=!0,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!0):"One2One-A"==this.model.RefeType?(this.model.Type="One2One",this.model.ForeignKey=!0,this.model.LinkTable=!1,this.model.InverseForeignKey=!1,this.model.Ancestry=!0,this.model.Descendant=!1,this.model.Bidirectional=!1):"One2One-AW"==this.model.RefeType?(this.model.Type="One2One",this.model.ForeignKey=!0,this.model.LinkTable=!1,this.model.InverseForeignKey=!1,this.model.Ancestry=!0,this.model.Descendant=!1,this.model.Bidirectional=!1,this.model.Weak=!0):"One2One-D"==this.model.RefeType?(this.model.Type="One2One",this.model.ForeignKey=!1,this.model.LinkTable=!1,this.model.InverseForeignKey=!0,this.model.Ancestry=!1,this.model.Descendant=!0,this.model.Bidirectional=!1):"One2One-DW"==this.model.RefeType?(this.model.Type="One2One",this.model.ForeignKey=!1,this.model.LinkTable=!1,this.model.InverseForeignKey=!0,this.model.Ancestry=!1,this.model.Descendant=!0,this.model.Bidirectional=!1,this.model.Weak=!0):"One2Many"==this.model.RefeType?(this.model.Type="One2Many",this.model.ForeignKey=!1,this.model.LinkTable=!0,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!0):"One2Many-S"==this.model.RefeType?(this.model.Type="One2Many",this.model.ForeignKey=!1,this.model.LinkTable=!0,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!1):"One2Many-I"==this.model.RefeType?(this.model.Type="One2Many",this.model.ForeignKey=!1,this.model.LinkTable=!1,this.model.InverseForeignKey=!0,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!0):"One2Many-D"==this.model.RefeType?(this.model.Type="One2Many",this.model.ForeignKey=!1,this.model.LinkTable=!1,this.model.InverseForeignKey=!0,this.model.Ancestry=!1,this.model.Descendant=!0,this.model.Bidirectional=!1):"One2Many-DW"==this.model.RefeType?(this.model.Type="One2Many",this.model.ForeignKey=!1,this.model.LinkTable=!1,this.model.InverseForeignKey=!0,this.model.Ancestry=!1,this.model.Descendant=!0,this.model.Bidirectional=!1,this.model.Weak=!0):"Many2One"==this.model.RefeType?(this.model.Type="Many2One",this.model.ForeignKey=!1,this.model.LinkTable=!0,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!0):"Many2One-S"==this.model.RefeType?(this.model.Type="Many2One",this.model.ForeignKey=!0,this.model.LinkTable=!1,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!1):"Many2One-B"==this.model.RefeType?(this.model.Type="Many2One",this.model.ForeignKey=!0,this.model.LinkTable=!1,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!0):"Many2One-A"==this.model.RefeType?(this.model.Type="Many2One",this.model.ForeignKey=!0,this.model.LinkTable=!1,this.model.InverseForeignKey=!1,this.model.Ancestry=!0,this.model.Descendant=!1,this.model.Bidirectional=!1):"Many2One-AW"==this.model.RefeType?(this.model.Type="Many2One",this.model.ForeignKey=!0,this.model.LinkTable=!1,this.model.InverseForeignKey=!1,this.model.Ancestry=!0,this.model.Descendant=!1,this.model.Bidirectional=!1,this.model.Weak=!0):"Many2Many"==this.model.RefeType?(this.model.Type="Many2Many",this.model.ForeignKey=!1,this.model.LinkTable=!0,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!0):"Many2Many-S"==this.model.RefeType&&(this.model.Type="Many2Many",this.model.ForeignKey=!1,this.model.LinkTable=!0,this.model.InverseForeignKey=!1,this.model.Ancestry=!1,this.model.Descendant=!1,this.model.Bidirectional=!1),this.name=this.model.Name,this.type=this.model.Type}function p(e,t,n){if(this.model=e,this.entDef=t,this.appDef=n,this.field=new Array,this.conditionMap=new r,this.conditions=[],this.model.Field)for(var i=0;i<this.model.Field.length;i++)this.field.push(this.model.Field[i]);if(this.type=this.model.Type,"Read"==this.type&&(this.type="QueryById",this.model.IncludeId)){var o=t.getId();this.field.push(o.getName())}if(this.name=this.model.Name,this.dispName=this.model.DispName,this.refeDef=this.model.Reference,"Delete"!=this.type&&(!this.field||0==this.field.length)){this.field=new Array;var a=t.getProperty();for(i=0;i<a.length;i++)this.field.push(a[i].getName());var s=t.getReference();for(i=0;i<s.length;i++)this.field.push(s[i].getName());var p=t.getForeignReference();for(i=0;i<p.length;i++)(p[i].isBi()||p[i].isAnce()||p[i].isDesc())&&this.field.push(p[i].getInvName())}if(this.refeDef){var l=t.getRefeByName(this.refeDef);l?(this.inverse=!1,this.refeDef=l):(l=t.getFgRefeByName(this.refeDef))&&(this.inverse=!0,this.refeDef=l)}if(this.model.Condition){var u=this.model.Condition,f=new m;d(u,f,this.conditionMap,this.entDef),null==f.getRightCondition()?this.conditions.push(f.getLeftCondition()):this.conditions.push(f)}this.getDispName=function(){return this.dispName?this.dispName:this.name},this.getFolderName=function(){return this.model.Folder?this.model.Folder:"Default"},this.getMainAction=function(){return this.model.MainAction},this.getInverse=function(){return this.inverse},this.getRefeDef=function(){return this.refeDef},this.toJSON=function(){return this.appDef.stringify(this,["appDef"])}}function l(e,t,n){this.model=e,this.entDef=t,this.appDef=n,this.refeDef=null,this.pageSize=0,this.type=this.model?this.model.Type:"Query",this.refeFields=[],this.propFields=[],this.conditions=[],this.conditionMap=new r;var i=null,o=new r,a=new r,s=null,p=null,g=1;if(this.model){if(this.name=this.model.Name,this.ordrDesc=this.model.OrderDesc,this.noCount=this.model.NoCount,this.distinct=this.model.Distinct,this.dispAs=this.model.DisplayAs,this.pageSize=this.model.PageSize,this.includeId=this.model.IncludeId,"QueryRef"===this.model.Type){var h=this.model.Reference;if(this.refeDef=t.getRefeByName(h),this.includeId=!1,this.refeDef){var y=this.refeDef.getForeignEnt();this.entDef=y,this.inverse=!1,(i=new c).setQueryReference(this.refeDef),i.setInverse(!0),i.setOperator("="),i.connectRef=!0;var N=y.getId();if(this.model.Field&&-1==this.model.Field.indexOf(N.getName()))(S=new f).setProp(N),S.setName(N.getName()),S.setIdx(g++),this.addPropField(S),this.distinct=!0,o.put("["+this.refeDef.getName()+"]",i)}else{if(this.refeDef=t.getFgRefeByName(h),!this.refeDef)throw"Cannot found reference "+h+".";y=this.refeDef.getRefOwnerEnt();this.entDef=y,this.inverse=!0,(i=new c).setQueryReference(this.refeDef),i.setInverse(!1),i.setOperator("="),i.connectRef=!0;var S=new f;N=y.getId();this.model.Field&&-1==this.model.Field.indexOf(N.getName())&&(S.setProp(N),S.setName(N.getName()),S.setIdx(g++),this.addPropField(S)),this.distinct=!0,o.put("["+this.refeDef.getInvName()+"]",i)}}else if("QueryRefCandidate"===this.model.Type){h=this.model.Reference;if(this.refeDef=t.getRefeByName(h),this.includeId=!1,this.refeDef){y=this.refeDef.getForeignEnt();this.entDef=y,this.inverse=!1,(i=new c).setQueryReference(this.refeDef),i.connectRef=!0,i.setInverse(!0),this.refeDef.isOne2()?i.setOperator("Is-Null"):this.refeDef.isMany2()&&(i.setOperator("="),i.setNotEq(!0)),this.distinct=!0;N=y.getId();if(this.model.Field&&-1==this.model.Field.indexOf(N.getName()))(S=new f).setProp(N),S.setName(N.getName()),S.setIdx(g++),this.addPropField(S);o.put("["+this.refeDef.getName()+"]",i)}else if(this.refeDef=t.getFgRefeByName(h),this.refeDef){y=this.refeDef.getRefOwnerEnt();this.entDef=y,this.inverse=!0,(i=new c).setQueryReference(this.refeDef),i.connectRef=!0,i.setInverse(!1),this.refeDef.is2One()?i.setOperator("Is-Null"):this.refeDef.is2Many()&&(i.setOperator("="),i.setNotEq(!0)),this.distinct=!0;N=y.getId();if(this.model.Field&&-1==this.model.Field.indexOf(N.getName()))(S=new f).setProp(N),S.setName(N.getName()),S.setIdx(g++),this.addPropField(S);o.put("["+this.refeDef.getInvName()+"]",i)}}else if(this.includeId){S=t.getId();(U=new f).setProp(S),U.setName(S.getName()),U.setIdx(g++),this.addPropField(U)}if(this.model.Condition){var T=this.model.Condition,R=new m;if(d(T,R,this.conditionMap,this.entDef,null,o),null==R.getRightCondition())null!=i?(R.setRightCondition(R.getLeftCondition()),R.setLeftCondition(i),R.setBinOpt("AND"),this.conditions.push(R)):this.conditions.push(R.getLeftCondition());else if(null!=i){var L=new m;L.setRightCondition(R),L.setBinOpt("AND"),L.setLeftCondition(i),this.conditions.push(L)}else this.conditions.push(R)}else null!=i&&this.conditions.push(i);if(!this.model.Field||0==this.model.Field.length){this.model.Field=new Array;var v=null;if("QueryRef"===this.model.Type||"QueryRefCandidate"===this.model.Type)v=(v=(y=this.inverse?this.refeDef.getRefOwnerEnt():this.refeDef.getForeignEnt()).getProperty()).slice(1,v.length);else v=t.getProperty();for(var C=0;C<v.length;C++)this.model.Field.push(v[C].getName())}for(C=0;C<this.model.Field.length;C++){var D=this.model.Field[C].trim().split(" "),I=null,M=null,E=null,O=!0;1==D.length?(E=I=D[0],O=!1):2==D.length?"MAX"==(M=D[0].toUpperCase())||"MIN"==M||"SUM"==M||"TOTAL"==M||"AVG"==M||"COUNT"==M?(E=I=D[1],O=!1):(M=null,I=D[0],E=D[1]):3==D.length&&("MAX"!=(M=D[0].toUpperCase())&&"MIN"!=M&&"SUM"!=M&&"TOTAL"!=M&&"AVG"!=M&&"COUNT"!=M&&(M="COUNT"),I=D[1],E=D[2]),s=null,p=null;var q=I;if(-1!=I.indexOf(".")){var Q=I.split(".");q=Q[Q.length-1];var P="",F=null,A=t;"QueryRef"!==this.model.Type&&"QueryRefCandidate"!==this.model.Type||(A=this.inverse?this.refeDef.getRefOwnerEnt():this.refeDef.getForeignEnt());for(var B=0;B<Q.length-1;B++){for(var b=A.getReference(),x=!1,w=!1,K=0;K<b.length;K++)if(b[K].model.Name===Q[B]){A=b[K].getForeignEnt(),F=b[K],x=!0;break}if(!x){b=A.getForeignReference();for(K=0;K<b.length;K++)if(b[K].model.InvName===Q[B]){A=b[K].getRefOwnerEnt(),F=b[K],x=!0,w=!0;break}}if(!x)throw"Cannot find reference "+Q[B];if(""!=P&&(P+="_"),P+="["+(w?F.getInvName():F.getName())+"]",o.containsKey(P))s=o.get(P);else if(a.containsKey(P))p=a.get(P);else{var _=new u;if(_.setReference(F),_.setInverse(w),s)s.addRefeField(_);else if(p){if(null==p.getReferenceQuery())if((j=new l).setName("Qry"),j.setEntityDef(A),p.setReferenceQuery(j),this.includeId){S=A.getId();(U=new f).setProp(S),U.setName(S.getName()),U.setIdx(g++),j.addPropField(U)}p.getReferenceQuery().addRefeField(_)}else if(this.addRefeField(_),this.includeId&&null==_.getReferenceQuery()){(j=new l).setName("Qry"),j.setEntityDef(A),_.setReferenceQuery(j);var U;S=A.getId();(U=new f).setProp(S),U.setName(S.getName()),U.setIdx(g++),j.addPropField(U)}a.put(P,_),p=_}}var k=A.getPropByName(q);if((J=new f).setProp(k),J.setAggregation(M),O?(J.setName(E),J.setNameDefined(!0),J.setAggregation(M)):(J.setName(k.model.Name),J.setNameDefined(!1)),J.setIdx(g++),p){var j;if(null==p.getReferenceQuery())(j=new l).setName("Qry"),j.setEntityDef(A),p.setReferenceQuery(j);p.getReferenceQuery().addPropField(J)}else null!=s&&s.addPropField(J)}else{var J;k=null;if("QueryRef"===this.model.Type||"QueryRefCandidate"===this.model.Type)k=(y=this.inverse?this.refeDef.getRefOwnerEnt():this.refeDef.getForeignEnt()).getPropByName(q);else k=t.getPropByName(q);(J=new f).setProp(k),J.setAggregation(M),O?(J.setName(E),J.setNameDefined(!0)):(J.setName(q),J.setNameDefined(!1)),J.setIdx(g++),this.addPropField(J)}}}}function d(e,t,n,i,o,a){var s=null,p=null,l=a||new r;o||(o={count:1});for(var u=o,f=0;f<e.Items.length;f++){var g=e.Items[f];if(g.Items.length>0){var y=new m;if(d(g,y,n,i,u,l),0==f)t.setBinOpt(e.ItemRelation),t.setLeftCondition(y),p=t;else if(e.Items.length>1&&f<e.Items.length-1){var N=p;p=new m,N.setRightCondition(p),p.setLeftCondition(y),p.setBinOpt(e.ItemRelation)}else e.Items.length>1&&f==e.Items.length-1&&p.setRightCondition(y)}else{var S=g.Field,T=S;if(-1!=S.indexOf(".")){var R=S.split(".");T=R[R.length-1];for(var L="",v=i,C=null,D=0;D<R.length-1;D++){for(var I=v.getReference(),M=!1,E=!1,O=0;O<I.length;O++)if(I[O].model.Name===R[D]){v=I[O].getForeignEnt(),C=I[O],M=!0;break}if(!M){I=v.getForeignReference();for(O=0;O<I.length;O++)if(I[O].model.InvName===R[D]){v=I[O].getRefOwnerEnt(),C=I[O],M=!0,E=!0;break}}if(!M)throw"Cannot find reference "+R[D];if(""!=L&&(L+="_"),L+="["+(E?C.getInvName():C.getName())+"]",l.containsKey(L))s=l.get(L);else{var q=new c;if(q.setName("RefeCnd"),q.setQueryReference(C),q.setInverse(E),null!=s)s.addSubCondition(q);else if(0==f)t.setBinOpt(e.ItemRelation),t.setLeftCondition(q),p=t;else if(e.Items.length>1&&f<e.Items.length-1){N=p;p=new m,N.setRightCondition(p),p.setLeftCondition(q),p.setBinOpt(e.ItemRelation)}else e.Items.length>1&&f==e.Items.length-1&&p.setRightCondition(q);l.put(L,q),s=q}}var Q=v.getPropByName(T);(P=new h).setQueryProp(Q),P.setOperator(g.Opt),P.setTargetValue(g.Val),P.setName(T),P.setIndex(u.count++),P.setElement(g.Param),s.addSubCondition(P),n.put(S+"."+P.getIndex(),P)}else{var P;Q=i.getPropByName(T);if((P=new h).setQueryProp(Q),P.setOperator(g.Opt),P.setTargetValue(g.Val),P.setName(T),P.setElement(g.Param),P.setIndex(u.count++),0==f)t.setBinOpt(e.ItemRelation),t.setLeftCondition(P),p=t;else if(e.Items.length>1&&f<e.Items.length-1){N=p;p=new m,N.setRightCondition(p),p.setLeftCondition(P),p.setBinOpt(e.ItemRelation)}else e.Items.length>1&&f==e.Items.length-1&&p.setRightCondition(P);n.put(S+"."+P.getIndex(),P)}}}return l}function u(){this.name=null,this.inverse=!1,this.reference=null,this.referenceQuery=null,this.setName=function(e){this.name=e},this.setInverse=function(e){this.inverse=e},this.setReferenceQuery=function(e){this.referenceQuery=e},this.setReference=function(e){this.reference=e},this.getName=function(e){return this.name},this.getInverse=function(e){return this.inverse},this.getReferenceQuery=function(e){return this.referenceQuery},this.getReference=function(e){return this.reference}}function f(){this.name=null,this.prop=null,this.idx=null,this.nameDefined=!1,this.aggregation=null,this.setNameDefined=function(e){this.nameDefined=e},this.setName=function(e){this.name=e},this.setProp=function(e){this.prop=e},this.setIdx=function(e){this.idx=e},this.getName=function(){return this.name},this.getProp=function(){return this.prop},this.getIdx=function(){return this.idx},this.getNameDefined=function(){return this.nameDefined},this.setAggregation=function(e){this.aggregation=e},this.getAggregation=function(){return this.aggregation}}function g(){this.name=null,this.query=null,this.biConditionLeft=null,this.biConditionRight=null,this.mainCondition=null,this.index=null,this.setName=function(e){this.name=e},this.setQuery=function(e){this.query=e},this.setBiConditionLeft=function(e){this.biConditionLeft=e},this.setBiConditionRight=function(e){this.biConditionRight=e},this.setMainCondition=function(e){this.mainCondition=e},this.setIndex=function(e){this.index=e},this.getIndex=function(){return this.index}}function h(){g.call(this),this.name=null,this.targetValue=null,this.queryProp=null,this.operator=null,this.element=null,this.setName=function(e){this.name=e},this.setTargetValue=function(e){this.targetValue=e},this.setQueryProp=function(e){this.queryProp=e},this.setOperator=function(e){this.operator=e},this.getTargetValue=function(){return void 0!==this.targetValue?this.targetValue:"?"},this.getQueryProp=function(){return this.queryProp},this.getOperator=function(){return this.operator},this.setElement=function(e){this.element=e},this.getElement=function(){return this.element}}function c(){g.call(this),this.name=null,this.inverse=!1,this.notEq=!1,this.queryReference=null,this.operator=null,this.connectRef=!1,this.subCondition=[],this.propField=[],this.refeField=[],this.setName=function(e){this.name=e},this.setInverse=function(e){this.inverse=e},this.setNotEq=function(e){this.notEq=e},this.setQueryReference=function(e){this.queryReference=e},this.addSubCondition=function(e){this.subCondition.push(e)},this.setOperator=function(e){this.opertaor=e},this.addPropField=function(e){this.propField.push(e)},this.addRefeField=function(e){this.refeField.push(e)},this.getName=function(){return this.name},this.getInverse=function(){return this.inverse},this.getQueryReference=function(){return this.queryReference},this.getOperator=function(){return this.opertaor},this.getSubCondition=function(){return this.subCondition},this.getNotEq=function(){return this.notEq},this.getRefeField=function(){return this.refeField},this.getPropField=function(){return this.propField}}function m(){g.call(this),this.binOpt=null,this.leftCondition=null,this.rightCondition=null,this.setBinOpt=function(e){this.binOpt=e},this.setLeftCondition=function(e){this.leftCondition=e},this.setRightCondition=function(e){this.rightCondition=e},this.getBinOpt=function(){return this.binOpt},this.getLeftCondition=function(){return this.leftCondition},this.getRightCondition=function(){return this.rightCondition}}i.prototype={getEntities:function(){return this.entities},getActions:function(){return this.actions},getPages:function(){return this.pages},getEntityByName:function(e){return this.entMap.get(e)},getActionByName:function(e){return this.actMap.get(e)},getPageByName:function(e){return this.pageMap.get(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},stringify:function(e){JSON.stringify(e)},escapeJSON:function(e){return e&&(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/[\\]/g,"\\\\")).replace(/[\"]/g,'\\"')).replace(/[\/]/g,"\\/")).replace(/[\b]/g,"\\b")).replace(/[\f]/g,"\\f")).replace(/[\n]/g,"\\n")).replace(/[\r]/g,"\\r")).replace(/[\t]/g,"\\t")),e}},o.prototype={buildFgRefe:function(){this.fgrefes=new Array;for(var e=this.appDef.getEntities(),t=0;t<e.length;t++){var n=e[t].model.Reference;if(n)for(var r=0;r<n.length;r++){var i=n[r];i.Entity===this.model.Name&&this.fgrefes.push(new s(i,e[t]))}}},getStorageName:function(){return this.model.StorageName?this.model.StorageName:this.model.Name},getName:function(){return this.model.Name},getProperty:function(){return this.props},getReference:function(){return this.refes},getForeignReference:function(){return this.fgrefes},getPrimaryKey:function(){for(var e=[],t=0;t<this.props.length;t++){var n=this.props[t].model;n.PrimaryKey&&e.push(new a(n,this))}return e},getUniqueProf:function(){var e=[];if(this.model.Unique)for(var t=0;t<this.model.Unique.length;t++){for(var n=[],r=0;r<this.model.Unique[t].length;r++)for(var i=0;i<this.props.length;i++)this.props[i].model.Name===this.model.Unique[t][r]&&n.push(this.props[i]);e.push(n)}return e},getIndexProf:function(){var e=[];if(this.model.Index)for(var t=0;t<this.model.Index.length;t++){for(var n=[],r=0;r<this.model.Index[t].length;r++)for(var i=0;i<this.props.length;i++)this.props[i].model.Name===this.model.Index[t][r]&&n.push(this.props[i]);e.push(n)}return e},isPK:function(e){for(var t=0;t<this.props.length;t++){var n=this.props[t].model;if(n.PrimaryKey&&n.Name===e.model.Name)return!0}return!1},isPropTitle:function(e,t){return!1},isRefeTitle:function(e,t){return!1},getId:function(){for(var e=0;e<this.props.length;e++)if(this.props[e].model.Name===this.model.Name+"Id")return this.props[e]},getPropByName:function(e){for(var t=0;t<this.props.length;t++)if(this.props[t].model.Name===e)return this.props[t]},getRefeByName:function(e){for(var t=0;t<this.refes.length;t++)if(this.refes[t].model.Name===e)return this.refes[t]},getFgRefeByName:function(e){for(var t=0;t<this.fgrefes.length;t++)if(this.fgrefes[t].model.InvName===e)return this.fgrefes[t]},toJSON:function(){return this.appDef.stringify(this,["appDef"])}},a.prototype={getStorageName:function(){return this.model.StorageName?this.model.StorageName:this.model.Name},getPropType:function(){return this.model.Type},getMaxLen:function(){return this.model.MaxLen},getMinLen:function(){return this.model.MinLen},getMax:function(){return this.model.Max},getMin:function(){return this.model.Min},getRegExpr:function(){return this.model.RegExpr},getNullable:function(){return void 0===this.model.Nullable||1==this.model.Nullable},getDefaultValue:function(){return this.model.DefaultValue},getCurrent:function(){return this.model.Current},getName:function(){return this.model.Name},getPassword:function(){return this.model.Password},getDispName:function(){return this.model.DispName?this.model.DispName:this.model.Name},getScale:function(){return this.model.Scale},getPrecision:function(){return this.model.Precision},toJSON:function(){return this.entDef.appDef.stringify(this,["entDef"])}},s.prototype={getStorageName:function(){return this.model.StorageName?this.model.StorageName:this.model.Name},getName:function(){return this.model.Name},getRefeType:function(){return this.model.Type},isFK:function(){return this.model.ForeignKey},isLT:function(){return this.model.LinkTable},isInvFK:function(){return this.model.InverseForeignKey},isAnce:function(){return this.model.Ancestry},isDesc:function(){return this.model.Descendant},isOne2:function(){return"One2One"===this.model.Type||"One2Many"===this.model.Type},is2One:function(){return"One2One"===this.model.Type||"Many2One"===this.model.Type},isMany2:function(){return"Many2One"===this.model.Type||"Many2Many"===this.model.Type},is2Many:function(){return"One2Many"===this.model.Type||"Many2Many"===this.model.Type},isBi:function(){return this.model.Bidirectional},isWeak:function(){return this.model.Weak},getForeignEnt:function(){for(var e=this.entDef.appDef.getEntities(),t=0;t<e.length;t++){var n=e[t];if(this.model.Entity===n.model.Name)return n}return null},getRefOwnerEnt:function(){return this.entDef},getInvName:function(){return this.model.InvName},getInvStorageName:function(){return this.model.InvStorageName?this.model.InvStorageName:this.model.InvName},getInvDispName:function(){return this.model.InvDisplayName?this.model.InvDisplayName:this.model.InvName},getDispName:function(){return this.model.DisplayName?this.model.DisplayName:this.model.Name},isDescDeletable:function(){var e=this.getForeignEnt().getReference();if(null!=e)for(var t=e.iterator();t.hasNext();){if(!t.next().isFK())return!1}return!0},toJSON:function(){return this.entDef.appDef.stringify(this,["entDef"])}},l.prototype={getEntityDef:function(){return this.entDef},getInverse:function(){return this.inverse},getRefeDef:function(){return this.refeDef},getPropField:function(){return this.propFields},getRefeField:function(){return this.refeFields},addPropField:function(e){this.propFields.push(e)},addRefeField:function(e){this.refeFields.push(e)},addCondition:function(e){this.conditions.push(e)},getCondition:function(){return this.conditions},getOrderField:function(){var e=[];if(this.model.OrderField)for(var t=0;t<this.model.OrderField.length;t++){var n=this.model.OrderField[t],r=new f;r.setProp(null),r.setName(n),e.push(r)}return e},getPageSize:function(){return this.pageSize},getDistinct:function(){return this.distinct},getOrderDesc:function(){return this.ordrDesc},setName:function(e){this.name=e},getName:function(){return this.name},setEntityDef:function(e){this.entDef=e},getFolderName:function(){return this.model.Folder?this.model.Folder:"Default"},getDispName:function(){return this.dispName?this.dispName:this.name},toJSON:function(){return this.appDef.stringify(this,["appDef","refeFields","propFields","conditions","conditionMap"])}},h.prototype=new g,h.prototype.constructor=h,c.prototype=new g,c.prototype.constructor=c,m.prototype=new g,m.prototype.constructor=m,t.exports={AppDef:i,EntityDef:o,PropDef:a,RefeDef:s,ActionDef:p,QueryDef:l,QueryCondition:g,QueryRefeCondition:c,QueryPropCondition:h,QueryBiCondition:m}},{"./hashmap.js":11}],11:[function(e,t,n){"use strict";t.exports=function(){this.length=0,this.items=new Array;for(var e=0;e<arguments.length;e+=2)void 0!==arguments[e+1]&&(this.items[arguments[e]]=arguments[e+1],this.length++);this.keys=function(){var e=[];for(var t in this.items)"function"!=typeof this.items[t]&&e.push(t);return e},this.vals=function(){return this.items},this.remove=function(e){if(void 0!==this.items[e]){this.length--;var t=this.items[e];delete this.items[e]}return t},this.put=function(e,t){return this.items[e]=t},this.get=function(e){return this.items[e]},this.set=function(e,t){var n;return void 0!==t&&(void 0===this.items[e]?this.length++:n=this.items[e],this.items[e]=t),n},this.containsKey=function(e){return void 0!==this.items[e]},this.clear=function(){for(var e in this.items)delete this.items[e];this.length=0}}},{}],12:[function(require,module,exports){"use strict";var insertsql=require("./appruntime_insert.js"),readsql=require("./appruntime_read.js"),updatesql=require("./appruntime_update.js"),deletesql=require("./appruntime_delete.js"),querysql=require("./appruntime_query.js"),schemasql=require("./appruntime_schema.js"),StringBuffer=require("./stringbuffer.js"),generateSchemaRuntime=function(e,t){var n=schemasql(t,e,!1);return{appDef:n.appDef,sqls:n.generateDataSchemaSQL()}},generateSQL=function generateSQL(actionDef,appModel,sqlMap){var sqls=[];if("Create"===actionDef.model.Type?sqls=insertsql(sqlMap,appModel).generateCreateObjSQL(actionDef):"Update"===actionDef.model.Type?sqls=updatesql(sqlMap,appModel).generateUpdateObjSQL(actionDef):"Delete"===actionDef.model.Type?sqls=deletesql(sqlMap,appModel).generateDeleteObjSQL(actionDef):"Read"===actionDef.model.Type?sqls=readsql(sqlMap,appModel).generateReadObjSQL(actionDef):"AddReference"===actionDef.model.Type?sqls=updatesql(sqlMap,appModel).generateAddRefeSQL(actionDef):"RemoveReference"===actionDef.model.Type?sqls=updatesql(sqlMap,appModel).generateRemoveRefeSQL(actionDef):"Query"!==actionDef.model.Type&&"QueryRef"!==actionDef.model.Type&&"QueryRefCandidate"!==actionDef.model.Type||(sqls=querysql(sqlMap,appModel).generateQueryObjSQL(actionDef)),eval(sqlMap.getKeyWord("UseNumberAsParam")))for(var i=0;i<sqls.length;i++){for(var oldsql=sqls[i].SQL,len=oldsql.length,newsql="",count=1,skip=!1,j=0;j<len;j++)"?"!=oldsql[j]||skip?"'"==oldsql[j]?(skip=!skip,newsql+=oldsql[j]):newsql+=oldsql[j]:(newsql+="$"+count,count++);sqls[i].SQL=newsql}if(sqlMap.getKeyWord("NeedSchema")){var sb=new StringBuffer;sb.append(sqlMap.getSQLChooseSchema()),sb.append(appModel.Name),sb.append(sqlMap.getSQLChooseSchemaEnd()),sb.append(";"),sb.append("\n"),sqls.splice(0,0,{SQL:sb.toString(),FUNCType:"QUERY",SQLType:"QUERY",Param:[]})}return sqls},generateSQLRuntime=function(e,t,n){for(var r=generateSQL(e,t,n),i=(e.entDef.name,e.inverse,e.type),o=[],a=0;a<r.length;a++){var s=r[a].SQL,p=r[a].FUNCType,l=r[a].SQLType,d=r[a].Param,u=r[a].Res,f=new Array,g=new Array,h={};if(o.push(h),h.cmd=s,s&&("QUERY"!=p||"Exist"!=i&&"Count"!=i)&&("QUERY"!=p||"ExistRef"!=i&&"CountRef"!=i)&&("QUERY"!=p||"ExistRefCandidate"!=i&&"CountRefCandidate"!=i)&&("QUERYCOUNT"!=p||"QueryById"!=i))if("INSERTREFMANY"==p||"DELETEREF"==p){if(null!=d){for(var c=0,m="",y=0;y<d.length;y++){var N=(I=d[y]).Idx,S=I.PropName,T=I.RefName,R=(I.RefLinkTable,I.RefInv,I.PreVal,I.PropType),L=(I.AddtionalInfo,I.UpRef);if(""==m){if(null!=(M=I.UpRefName))for(var v=0;v<M.length;v++){var C=M[v];I.UpRefInv[v];m.length>0&&(m+=","),m+=C}null!=T&&(m.length>0&&(m+=","),m+=T)}c++,f.push([N,R,S])}h.inRefKeys=m,h.inMultiple=!0,2==d.length?(h.inParam=[],h.inParam.push(f[0]),h.inParam.push(f[1]),h.inParamRefe=[!1,!0]):(h.inParam=[],h.inParam.push(-1),h.inParam.push(f[1]),h.inParam.push(f[2]),h.inParamRefe=[!1,!1,!0])}}else{if(null!=d){c=1;var D=d.length;for(y=0;y<d.length;y++){m="",N=(I=d[y]).Idx,S=I.PropName,T=I.RefName,I.RefInv,I.RefLinkTable,I.PreVal,R=I.PropType,I.AddtionalInfo;var I,M,E=I.Operator?I.Operator:"",O=I.Type,q=I.CndIdx;if(null!=(M=I.UpRefName))for(v=0;v<M.length;v++){C=M[v],I.UpRefInv[v];m.length>0&&(m+=","),m+=C}null!=T&&(m.length>0&&(m+=","),m+=T),m.length>0&&(m+=","),m+=S,"QueryRef"==i||"QueryRefCandidate"==i||"CountRef"==i||"CountRefCandidate"==i||"ExistRef"==i||"ExistRefCandidate"==i?f.push([N,R,m,E,q]):("REMOVEREF"==p&&"toBeCondition"!=O||"UPDATEREFTONULL"==p)&&c<=D/2?f.push([N,R,null,E,q]):f.push([N,R,m,E,q]),c++}}if(u&&u.length>0&&"QUERYCOUNT"!=p)for(c=0,y=0;y<u.length;y++){m="";var Q=u[y],P=(N=Q.Idx,S=Q.PropName,T=Q.RefName,Q.RefInv,Q.PreVal,R=Q.PropType,L=Q.UpRefName,Q.UpRefInv),F=Q.DisplayName||Q.PropName,A=Q.DisplayNameDefined,B=Q.aggFunc;if(null!=L)for(v=0;v<L.length;v++){C=L[v],P[v];m.length>0&&(m+=","),m+=C}null!=T&&(m.length>0&&(m+=","),m+=T),m.length>0&&(m+=","),m+=S,"INSERT"==p||"QUERY"==p||"CHECKINUSE"==p?B?g.push([N,R,m,F,A,B]):g.push([N,R,m,F,A]):"READREF"==p&&g.push([N,R,S,F,A]),c++}if("INSERT"==l)"INSERTREFONE"==p&&(h.checkExist=f[1][2]),h.inParam=f,h.outResult=g,h.outInsertId=!0;else if("QUERY"==p||"READREF"==p)h.inFrom=!0,h.inSize=!0,h.inPageSize=e.pageSize,"QueryById"==i&&"READREF"!=p?(h.inParam=f,h.outResult=g,h.outMultiple=!0):"QueryById"==i&&"READREF"==p?(h.inParam=f,h.outResult=g,h.outMultiple=!0,h.outRefName=T):(h.inParam=f,h.outResult=g,h.outMultiple=!0,h.outQuery=!0);else if("QUERYCOUNT"==p)h.inParam=f,h.outCount=!0;else if("CHECKINUSE"==p){h.inParam=f,-1!=(S=g[0][2]).indexOf(",")&&(S=S.substring(S.indexOf(",")+1)),h.outCheckInUse=!0,h.outCheckPropName=S.toUpperCase()}else"INSERTREFMANY"!=p&&"DELETEREF"!=p&&(h.inParam=f)}}return o};module.exports={defs:require("./defs.js"),generateSchemaRuntime:generateSchemaRuntime,generateSQLRuntime:generateSQLRuntime}},{"./appruntime_delete.js":3,"./appruntime_insert.js":4,"./appruntime_query.js":5,"./appruntime_read.js":6,"./appruntime_schema.js":7,"./appruntime_update.js":8,"./defs.js":10,"./stringbuffer.js":15}],13:[function(e,t,n){"use strict";function r(e){this.propDef=e,this.toBeSelected=!1,this.toBeUpdated=!1,this.toBeCondition=!1,this.toBeInserted=!1,this.val=null}function i(e){this.refeDef=e,this.parent=null,this.inverse=!1,this.toBeJoined=!1,this.toBeRestricted=!1,this.toBeDeleted=!1,this.children=[]}function o(){this.mainRefNode=null,this.nodes=[]}function a(){}function s(){a.call(this)}function p(){a.call(this)}function l(){a.call(this)}function d(){s.call(this)}function u(){a.call(this)}r.prototype={getPropDef:function(){return this.propDef},setPropDef:function(e){this.propDef=e},getValue:function(){return this.val},setValue:function(e){this.val=e}},i.prototype={add:function(e){this.children.pusn(e)},getRefeDef:function(){return this.refeDef},setRefeDef:function(e){this.refeDef=e},isInverse:function(){return this.inverse},setInverse:function(e){this.inverse=e},isOne:function(){return!this.isInverse()&&this.getRefeDef().is2One()||this.isInverse()&&this.getRefeDef().isOne2()},isMany:function(){return!this.isInverse()&&this.getRefeDef().is2Many()||this.isInverse()&&this.getRefeDef().isMany2()},isDesc:function(){return!this.isInverse()&&this.getRefeDef().isDesc()||this.isInverse()&&this.getRefeDef().isAnce()},isAnce:function(){return!this.isInverse()&&this.getRefeDef().isAnce()||this.isInverse()&&this.getRefeDef().isDesc()},isWeak:function(){return this.getRefeDef().isWeak()},getChildren:function(){return this.children},setChildren:function(e){this.children=e}},o.prototype={getMainRefNode:function(){return this.mainRefNode},setMainRefNode:function(e){this.mainRefNode=e},isReferenceBased:function(){return null!=this.mainRefNode},add:function(e){this.nodes.push(e)},addAll:function(e){this.nodes=this.nodes.concat(e)},iterator:function(){return this.nodes.iterator()}},a.prototype={requiredProp:function(e,t,n,r){return!1},requiredRefe:function(e,t,n,r,i){return!1},updatePropNode:function(e,t,n,r){},updateRefeNode:function(e,t,n,r,i){},buildNodeList:function(e,t,n){var o=t.getProperty();if(null!=o)for(var a=o.iterator();a.hasNext();){var s=a.next(),p=new r(s);this.requiredProp(e,t,s,n)&&(this.updatePropNode(e,t,p,n),e.add(p))}var l=t.getReference();if(null!=l)for(var d=l.iterator();d.hasNext();){var u=d.next();if(this.requiredRefe(e,t,u,!1,n))(p=new i(u)).setInverse(!1),this.updateRefeNode(e,t,p,!1,n),e.add(p)}var f=t.getForeignReference();if(null!=f)for(d=f.iterator();d.hasNext();){u=d.next();if(this.requiredRefe(e,t,u,!0,n))(p=new i(u)).setInverse(!0),this.updateRefeNode(e,t,p,!0,n),e.add(p)}return e}},s.prototype=new a,s.prototype.constructor=s,s.prototype.requiredProp=function(e,t,n,r,i){return!1},s.prototype.requiredRefe=function(e,t,n,r){return!1},s.prototype.updatePropNode=function(e,t,n,r,i){},s.prototype.updateRefeNode=function(e,t,n,r){},s.prototype.buildNodeList=function(e,t){var n=[],r=e.getReference();if(null!=r)for(var a=r.iterator();a.hasNext();){var s=a.next();if(this.requiredRefe(e,s,!1,t)){(d=new o).addAll(this.getPropNodes(e,s,!1,t));var p=new i(s);d.setMainRefNode(p),p.setInverse(!1),this.updateRefeNode(e,p,!1,t),d.add(p),n=n.concat(d)}}var l=e.getForeignReference();if(null!=l)for(a=l.iterator();a.hasNext();){s=a.next();if(this.requiredRefe(e,s,!0,t)){var d;(d=new o).addAll(this.getPropNodes(e,s,!0,t));p=new i(s);d.setMainRefNode(p),p.setInverse(!0),this.updateRefeNode(e,p,!0,t),d.add(p),n=n.concat(d)}}return n},s.prototype.getPropNodes=function(e,t,n,i){var o=[],a=e.getProperty();if(null!=a)for(var s=a.iterator();s.hasNext();){var p=s.next(),l=new r(p);this.requiredProp(e,p,t,n,i)&&(this.updatePropNode(e,l,t,n,i),o.push(l))}return o},p.prototype=new a,p.prototype.constructor=p,p.prototype.requiredProp=function(e,t,n){return"id"!=n.getPropType().toLowerCase()},p.prototype.requiredRefe=function(e,t,n,r){return r?n.isOne2()&&n.isInvFK():n.is2One()&&n.isFK()||n.isAnce()&&n.isWeak()},p.prototype.updatePropNode=function(e,t,n){n.toBeInserted=!0},p.prototype.updateRefeNode=function(e,t,n,r){n.toBeJoined=!0;var i=null;r?(i=n.getRefeDef().getRefOwnerEnt(),n.inverse=!0):(i=n.getRefeDef().getForeignEnt(),n.inverse=!1);var a=new o;(new l).buildNodeList(a,i),n.children=a},l.prototype=new a,l.prototype.constructor=l,l.prototype.requiredProp=function(e,t,n){return t.isPK(n)},l.prototype.updatePropNode=function(e,t,n){n.toBeInserted=!0},d.prototype=new s,d.prototype.constructor=d,d.prototype.requiredProp=function(e,t,n,r){return!!this.checkRef(n,r)&&e.isPK(t)},d.prototype.requiredRefe=function(e,t,n){return this.checkRef(t,n)},d.prototype.updatePropNode=function(e,t,n,r){t.toBeInserted=!0},d.prototype.updateRefeNode=function(e,t,n){t.toBeJoined=!0;var r=null;n?(r=t.getRefeDef().getRefOwnerEnt(),t.inverse=!0):(r=t.getRefeDef().getForeignEnt(),t.inverse=!1);var i=new o;(new u).buildNodeList(i,r),t.setChildren(i)},d.prototype.checkRef=function(e,t){if(t){if(e.isBi()){if(e.is2One()){if(e.isOne2())return e.isLT();if(e.isMany2())return e.isLT()||e.isFK()}else if(e.is2Many()){if(e.isOne2())return e.isLT();if(e.isMany2())return e.isLT()}}else if(e.isAnce()&&e.isWeak())return!0}else if(e.is2One()){if(e.isOne2())return e.isInvFK()||e.isLT();if(e.isMany2())return e.isLT()}else if(e.is2Many()){if(e.isOne2())return e.isInvFK()||e.isLT();if(e.isMany2())return e.isLT()}return!1},u.prototype=new a,u.prototype.constructor=u,u.prototype.requiredProp=function(e,t,n){return t.isPK(n)},u.prototype.updatePropNode=function(e,t,n){n.toBeInserted=!0},t.exports={PropNode:r,RefeNode:i,FieldNodeList:o,AbstractEntDefNodeListBuilder:a,AbstractRefDefNodeListBuilder:s,InsertEntNodeListBuilder:p,InsertEntJoinNodeListBuilder:l,InsertRefNodeListBuilder:d,InsertRefJoinNodeListBuilder:u}},{}],14:[function(e,t,n){"use strict";t.exports={setSQLParam:function(e,t,n,r,i,o,a,s,p){var l={};return l.RefName=null!=t?n?t.getInvName():t.getName():null,l.RefLinkTable=null!=t&&t.model.LinkTable,l.RefInv=n,l.UpRefName=r?r.join("\n").split("\n"):[],l.UpRefInv=i?i.join("\n").split("\n"):[],l.Operator=a,l.Idx=o,l.PropType=e.getPropType(),l.PropName=e.getName(),l.AddtionalInfo=p,l.CndIdx=s,l},getSQLResult:function(e,t,n,r,i,o,a,s,p){var l={};return l.RefName=null!=t?n?t.getInvName():t.getName():null,l.RefLinkTable=null!=t&&t.model.LinkTable,l.RefInv=n,l.UpRefName=r?r.clone():null,l.UpRefInv=i?i.clone():null,l.Idx=o,l.PropType=e.getPropType(),l.PropName=e.getName(),l.DisplayName=a,l.DisplayNameDefined=s,l.aggFunc=p,l},formatPropValue:function(e,t){var n=t.getPropType();return-1!=["String","Text"].indexOf(n)?e:-1!=["Integer","Long","Id"].indexOf(n)?parseInt(e):-1!=["Double","Float","Decimal"].indexOf(n)?parseFloat(e):-1!=["Boolean"].indexOf(n)?"true"==String(e)?1:0:void["Date","DateTime","Time","TimeStamp"].indexOf(n)},getPropRefOperator:function(e,t,n,r,i){var o=" "+(e?e+".":"")+n,a=i.getFunction("GetRefOperator");return a&&(o=a(e,t,n,r)),o}}},{}],15:[function(e,t,n){"use strict";function r(){this.stringarray=new Array}r.prototype={append:function(e){this.stringarray.push(e)},toString:function(){return this.stringarray.join("")},length:function(){return this.stringarray.length}},t.exports=r},{}],16:[function(e,t,n){"use strict";t.exports={genNodeCode:e("./node/index.js"),runCode:e("./util.js").runCode}},{"./node/index.js":17,"./util.js":24}],17:[function(e,t,n){"use strict";var r=e("../util.js"),i=function(t,n,i,o){var a=null;if(n.refeDef){var s=n.refeDef;a=n.inverse?s.model.Entity:s.model.OwnerEntity}return r.renderCode(e("./tpl/action.js"),{appName:t,action:n,refeEntName:a,sqlObj:i,dbAdapter:o})};t.exports=function(t,n,o){var a=o+"_adapter";"pgSQL"===o&&(a="pg_adapter");var s,p=t.Name,l=[],d=t.Runtime.schema;l.push({path:"package.json",code:(s=n,r.renderCode(e("./tpl/package.js"),{app:s})),codetype:"json"}),l.push({path:"server.js",code:function(t,n,i){return r.renderCode(e("./tpl/server.js"),{appName:t,actions:n,dbAdapter:i})}(p,t.Action,a),codetype:"js"}),l.push({path:"setup.js",code:function(t,n,i){return r.renderCode(e("./tpl/setup.js"),{appName:t,dbAdapter:i,sql:n})}(p,d,a),codetype:"js"});for(var u=0;u<t.Action.length;u++){var f=t.Action[u].Name,g=t.Runtime[f],h=t.Action[u];l.push({path:"action/act_"+f+".js",code:i(p,h,g,a),codetype:"js"})}return l.push({path:"database.js",code:function(t,n){return r.renderCode(e("./tpl/database.js"),{appName:t,dbtype:n})}(p,o),codetype:"js"}),l.push({path:"test.js",code:function(t,n,i,o){return r.renderCode(e("./tpl/test.js"),{appName:t,tests:n,actions:i,dbAdapter:o})}(p,n.test,t.Action,a),codetype:"js"}),l}},{"../util.js":24,"./tpl/action.js":18,"./tpl/database.js":19,"./tpl/package.js":20,"./tpl/server.js":21,"./tpl/setup.js":22,"./tpl/test.js":23}],18:[function(e,t,n){"use strict";t.exports=function(){return'\nconst apibaker = require(\'apibaker\');\nconst dbAdapter = apibaker.{{=it.dbAdapter}};\nconst execaction = apibaker.execaction;\nconst prepareInput = execaction.prepareInput;\nconst execAction = execaction.execAction;\n\nmodule.exports = function(param, conn, succ, err) {\n  var actionName = "{{=it.action.Name}}";\n  var actionType = "{{=it.action.Type}}";\n  var entName = "{{=it.action.Entity}}";\n  {{if(it.refeEntName){ }}\n  var refeEntName = "{{=it.refeEntName}}";\n  var input = prepareInput(param, actionType, entName, refeEntName);\n  {{ } else { }}\n  var input = prepareInput(param, actionType, entName);\n  {{ } }}\n  var dbObj = {{=JSON.stringify(it.sqlObj, null, 1)}};\n  execAction(input, dbObj, succ, err, dbAdapter, conn);\n}\n'}},{}],19:[function(e,t,n){"use strict";t.exports=function(){return"\n    module.exports = \n    {{ if(it.dbtype=='mysql') {  }}\n    {\n        connectionString : process.env.DBURI || 'mysql://root:@localhost/{{=it.appName}}?dateStrings=true'\n    }\n    {{ } else if(it.dbtype=='pgSQL') { }}\n    {\n        connectionString : process.env.DBURI || 'postgresql://postgres:@localhost/{{=it.appName}}'\n    }\n    {{ } }}\n    \n    "}},{}],20:[function(e,t,n){"use strict";t.exports=function(){return'\n    {\n        "name": "{{=it.app.name}}",\n        "version": "{{=it.app.version}}",\n        "description": "{{=it.app.description}}",\n        "main": "server.js",\n        "scripts": {\n            "start": "node server.js",\n            "test": "mocha"\n        },\n        "keywords": [\n            "apibaker",\n            "node",\n            "express"\n        ],\n        "author": "{{=(it.app.author || \'N/A\')}}",\n        "license": "{{=(it.app.license || \'MIT\')}}",\n        "homepage": "{{=(it.app.homepage || \'N/A\')}}",\n        "dependencies": {\n            "body-parser": "^1.17.2",\n            "cookie-parser": "^1.4.3",\n            "express": "^4.15.3",\n            "apibaker": "^1.0.9",\n            "mocha": "^5.0.1",\n            "mysql": "^2.15.0",\n            "pg": "^7.4.0",\n            "sql.js": "^0.4.0"\n        },\n        "devDependencies": {\n        }\n    }'}},{}],21:[function(e,t,n){"use strict";t.exports=function(){return"\n  \nconst express    = require('express');\nconst app        = express();\nconst bodyParser = require('body-parser');\nconst fs = require('fs');\n\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(bodyParser.json());\n\nconst port = process.env.PORT || 8080;\n\nconst router = express.Router();\n\nconst apibaker = require('apibaker');\nconst dbAdapter = apibaker.{{=it.dbAdapter}};\nconst database = require('./database.js');\nconst dbconn = dbAdapter.connect(\"{{=it.appName}}\", database);\n\n{{ for(var i=0;i<it.actions.length;i++){ }}\nvar {{=it.actions[i].Name}} = require(\"./action/act_{{=it.actions[i].Name}}.js\");\n{{ } }}\n\n{{ for(var i=0;i<it.actions.length;i++){ }}\nrouter.{{=it.actions[i].API.method.toLowerCase()}}('/{{=it.actions[i].API.path}}', function(req, resp) {\n    var param = {};\n    param.id = req.params.id;\n    param.obj = req.body.obj;\n    {{=it.actions[i].Name}} (param, dbconn, function(res){\n      resp.json(res);\n    }, function(error){\n      resp.status(500);\n      resp.json(error);\n    })\n});\n{{ } }}\n\napp.use('/api', router);\n\napp.listen(port);\n\n"}},{}],22:[function(e,t,n){"use strict";t.exports=function(){return'\n\nconst apibaker = require(\'apibaker\')\nconst dbAdapter = apibaker.{{=it.dbAdapter}};\n\nconst setupSchema = function(conn, succ, err) {\n  var sql = {{=JSON.stringify(it.sql, null, 1)}}\n  dbAdapter.runSql(conn, sql, succ, err)\n}\n\nconst database = require(\'./database.js\');\nconst dbconn = dbAdapter.connect("{{=it.appName}}", database);\n\nsetupSchema (dbconn, function(res){\n  console.log("database setup successfully!")\n  dbAdapter.disconnect("{{=it.appName}}", dbconn)\n}, function(error){\n  console.log(error)\n  dbAdapter.disconnect("{{=it.appName}}", dbconn)\n})\n\n\n'}},{}],23:[function(e,t,n){"use strict";t.exports=function(){return"  \nconst apibaker = require('apibaker');\nconst dbAdapter = apibaker.{{=it.dbAdapter}};\nconst database = require('./database.js');\nconst dbconn = dbAdapter.connect(\"{{=it.appName}}\", database);\nconst assert = require('assert');\n\n{{ for(var j=0;j<it.actions.length;j++){ }}\nconst {{=it.actions[j].Name}} = require(\"./action/act_{{=it.actions[j].Name}}.js\");\n{{ } }}\n\ndescribe('{{=it.appName}}', function() {\n    {{ for(var i=0;i<it.tests.length;i++){ }}\n        it('{{=it.tests[i].action}}', function(done) {\n            let param = {{=JSON.stringify(it.tests[i].in)}};\n            let expected = {{=JSON.stringify(it.tests[i].out)}};\n            {{=it.tests[i].action}} (param, dbconn, function(res){\n                assert.equal(JSON.stringify(expected) , JSON.stringify(res))\n                done()\n            }, function(error){\n                done(error)\n            })\n        });   \n    {{ } }}\n    \n        it('disconnectDB', function(done) {\n            dbAdapter.disconnect(\"{{=it.appName}}\", dbconn);\n            done()\n        })\n    });\n"}},{}],24:[function(require,module,exports){"use strict";var doT=require("dot");doT.templateSettings={evaluate:/\{\{([\s\S]+?)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,encode:/\{\{!([\s\S]+?)\}\}/g,use:/\{\{#([\s\S]+?)\}\}/g,define:/\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,conditional:/\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,iterate:/\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,varname:"it",strip:!1,append:!0,selfcontained:!1};var renderCode=function(e,t){var n=e();return doT.template(n)(t)},runCode=function runCode(code){return eval(code)};module.exports={renderCode:renderCode,runCode:runCode}},{dot:1}],25:[function(e,t,n){"use strict";var r=e("./sqlmap/index.js"),i=e("./modelconv/index.js"),o=e("./appruntime/index.js"),a=e("./codegen/index.js"),s=e("./apibaker/execaction.js"),p=r.SQLKeyWordsMap(r.sqliteMap),l=r.SQLKeyWordsMap(r.pgSQLMap),d=r.SQLKeyWordsMap(r.pgNoSQLMap),u=r.SQLKeyWordsMap(r.mysqlMap),f=function(e,t,n){var r=i.json2model(e).model,a=p;"pgSQL"===t&&(a=l),"mysql"===t?a=u:"pgNoSQL"===t?a=d:"sqlite"===t&&(a=p);var s=o.generateSchemaRuntime(r,a);r.Runtime={},r.ActDef={};var f=s.sqls.split("\n");return f.splice(f.length-1,1),r.Runtime.schema=f,s.appDef.actions.forEach(function(e){var t=o.generateSQLRuntime(e,r,a);r.Runtime[e.name]=t,n&&(r.ActDef[e.name]=e)}),r};void 0!==t&&void 0!==t.exports&&(t.exports={genAppJSON:f,genNodeCode:a.genNodeCode}),"undefined"!=typeof window&&(window.genAppJSON=f,window.genNodeCode=a.genNodeCode,window.apibakerclt=s)},{"./apibaker/execaction.js":2,"./appruntime/index.js":12,"./codegen/index.js":16,"./modelconv/index.js":26,"./sqlmap/index.js":30}],26:[function(e,t,n){"use strict";t.exports={json2model:e("./json2appmodel.js")}},{"./json2appmodel.js":27}],27:[function(require,module,exports){"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},simpleSqlParser=require("./simpleSqlParser.js");function appConv(e,t){e.reference&&e.reference.forEach(function(e){var n=e.owner;n=n.replace(".","_");var r=e.entity.split(".");e.entity=r[1],t.Entity.forEach(function(t){if(t.Name==n){var i={};refeConv(e,i,r[0]),t.Reference=t.Reference||[],t.Reference.push(i)}})}),e.action&&e.action.forEach(function(e){var n=e.namespace;e.action.forEach(function(r){var i=n+"_"+r;t.Action.forEach(function(t){t.Name==i&&(t.Field=t.Field||[],t.Field=t.Field.concat(e.field))})})})}function processNamespace(json,namespaces){return namespaces=namespaces||{},json.namespace_mapping&&json.namespace_mapping.forEach(function(e){namespaces[e.url]||(namespaces[e.url]=e.namespace)}),json.import&&json.import.forEach(function(comp){var compjson=eval("("+fs.readFileSync(comp.from,"utf8")+")");processNamespace(compjson,namespaces)}),namespaces}function compConv(e,t){e.domain&&e.domain.forEach(function(e){t.Domain=t.Domain||[],t.Domain.push(e.name),e.entity&&e.entity.forEach(function(n){entityConv(n,t,e.name)})})}function entityConv(e,t,n){var r={};return r.Name=n+"_"+e.name,r.ObjectType="Entity",r.Property=[],r.Reference=[],e.prop&&e.prop.forEach(function(e){var t={};propConv(e,t),r.Property.push(t)}),e.refe&&e.refe.forEach(function(e){var t={};refeConv(e,t,n),r.Reference.push(t)}),t.Entity.push(r),e.action&&e.action.forEach(function(r){r.entity=e.name,actionConv(r,t,n)}),r}function propConv(e,t){t.Name=e.name,typeConv(e.type,t),attrConv(e,t)}function refeConv(e,t,n){t.Name=e.name,"one2one"==e.type?t.RefeType="One2One":"one2one-s"==e.type?t.RefeType="One2One-S":"one2one-i"==e.type?t.RefeType="One2One-I":"one2one-a"==e.type?t.RefeType="One2One-A":"one2one-aw"==e.type?t.RefeType="One2One-AW":"one2one-d"==e.type?t.RefeType="One2One-D":"one2one-dw"==e.type?t.RefeType="One2One-DW":"one2many"==e.type?t.RefeType="One2Many":"one2many-s"==e.type?t.RefeType="One2Many-S":"one2many-i"==e.type?t.RefeType="One2Many-I":"one2many-d"==e.type?t.RefeType="One2Many-D":"one2many-dw"==e.type?t.RefeType="One2Many-DW":"many2one"==e.type?t.RefeType="Many2One":"many2one-s"==e.type?t.RefeType="Many2One-S":"many2one-b"==e.type?t.RefeType="Many2One-B":"many2one-a"==e.type?t.RefeType="Many2One-A":"many2one-aw"==e.type?t.RefeType="Many2One-AW":"many2many"==e.type?t.RefeType="Many2Many":"many2many-s"==e.type&&(t.RefeType="Many2Many-S"),t.Entity=n+"_"+checkAttrVal(e,"entity"),t.StorageName=e.name,t.InvName=checkAttrVal(e,"invname"),t.InvStorageName=t.InvName}function actionConv(e,t,n){var r={};if(r.Name=n+"_"+e.name,"Read"===e.type?(r.Type="Query",e.condition=n+"_"+e.entity+"Id=?"):r.Type=e.type,r.Entity=n+"_"+e.entity,r.ObjectType="Action",e.field){r.Field=[];for(var i=0;i<e.field.length;i++){var o=e.field[i];if("object"===(void 0===o?"undefined":_typeof(o))){var a="";o.prop&&(a=o.as&&""!==o.as?o.as.trim():o.opt&&""!==o.opt?o.opt+"_"+o.prop.replace(/\./g,"_"):o.prop.replace(/\./g,"_"),o.opt&&""!==o.opt?r.Field.push(o.opt+" "+o.prop+" "+a):r.Field.push(o.prop+" "+a))}else r.Field.push(o)}}r.API={path:n+""+e.path,method:e.method},r.namespace=n,r.ReturnId=e.returnid,r.Reference=e.refe,r.ReturnId&&(r.Field=r.Field||[],r.Field.push(r.Entity+"Id")),e.condition&&(r.Condition=conditionConv(e.condition)),r.GroupByField=e.groupfield,r.OrderField=e.orderfield,r.OrderDesc=e.desc?"DESC":"",r.NoCount=e.noCount,r.Raw=e,t.Action.push(r)}function typeConv(e,t){var n=e.toLowerCase();"boolean"===n?t.Type="Boolean":"short"===n?t.Type="Short":"integer"===n?t.Type="Integer":"long"===n?t.Type="Long":"float"===n?t.Type="Float":"double"===n?t.Type="Double":"decimal"===n?t.Type="Decimal":"string"===n?t.Type="String":"text"===n?t.Type="Text":"date"===n?t.Type="Date":"datetime"===n?t.Type="DateTime":"time"===n?t.Type="Time":"timestamp"===n&&(t.Type="TimeStamp")}function attrConv(e,t){t.MaxLen=checkAttrVal(e,"maxlen"),t.MinLen=checkAttrVal(e,"minlen"),t.Max=checkAttrVal(e,"max"),t.Min=checkAttrVal(e,"min"),t.RegExpr=checkAttrVal(e,"regexpr"),t.Nullable=checkAttrVal(e,"nullable"),t.DefaultValue=checkAttrVal(e,"defaultvalue"),t.Current=checkAttrVal(e,"current"),t.StorageName=checkAttrVal(e,"storagename"),t.Password=checkAttrVal(e,"password"),t.Scale=checkAttrVal(e,"scale"),t.Precision=checkAttrVal(e,"precision")}function conditionConv(e){var t=simpleSqlParser;var n={Items:[]};return n.Items.push(function e(t,n){if(n=n||{Items:[]},t.logic){n.ItemRelation=t.logic,n.Items=[];for(var r=0;r<t.terms.length;r++)n.Items.push(e(t.terms[r]))}else n.Opt=t.operator,0==t.right.indexOf("#")||"?"==t.right.trim()?n.Param=t.right:"Start-With"==n.Opt?n.Val="'"+t.right.substring(1,t.right.length-1)+"%'":"End-With"==n.Opt?n.Val="'%"+t.right.substring(1,t.right.length-1)+"'":"Contains"==n.Opt?n.Val="'%"+t.right.substring(1,t.right.length-1)+"%'":n.Val=t.right,n.Field=t.left;return n}(t.parse(e))),n}function checkAttrVal(e,t){return void 0!=_typeof(e[t])?e[t]:void 0}module.exports=exports=function(e){try{var t={};return t.Name=e.name,t.Description=e.description,t.Version=e.version,t.Entity=[],t.Action=[],compConv(e,t),{json:e,model:t}}catch(e){throw e}}},{"./simpleSqlParser.js":28}],28:[function(e,t,n){"use strict";function r(e){return"string"==typeof e?e.replace(/^\s+/g,"").replace(/\s+$/g,""):e}function i(e,t){for(var n=!1,i=0,o="",a=0;a<t.length;a++)!n&&/['"`]/.test(t[a])?n=t[a]:n&&t[a]==n?n=!1:n||"("!=t[a]?n||")"!=t[a]||i--:i++,t[a]==e&&(i>0||n)?o+="######":o+=t[a];return t=(t=(t=o).split(e)).map(function(t){return r(t.replace(new RegExp("######","g"),e))})}function o(e){for(var t="#",n=e.length,r=0;r<n;r++)t+=e[r]+"#";return t}function a(e){for(var t="",n=e.length,r=1;r<n;r+=2)t+=e[r];return t}function s(e){this.source=e,this.cursor=0,this.currentChar="",this.readNextChar()}function p(e){this.lexer=new s(e),this.currentToken="",this.readNextToken()}function l(e,t){var n="";return void 0!==e.logic?(n=(n=e.terms.map(function(e){return l(e,!0)})).join(" "+e.logic+" "),void 0!==t&&(n="("+n+")")):void 0!==e.left?(n=e.left,void 0!==e.operator&&(n+=" "+e.operator,void 0!==e.right&&("IN"===e.operator?n+=" ("+e.right+")":n+=" "+e.right))):n=e,n}n.sql2ast=function(e,t){void 0!==t&&null!==t||(t=!0);e=(e=(e=(e=e.replace(/[("'`].*;.*[)"'`]/g,function(e){return e.replace(/;/g,"###semi-colon###")})).replace(/;/g,"###EOR###")).split("###EOR###")[0]).replace(new RegExp("###semi-colon###","g"),";");var n=["SELECT","FROM","DELETE FROM","INSERT INTO","UPDATE","JOIN","LEFT JOIN","RIGHT JOIN","INNER JOIN","ORDER BY","GROUP BY","HAVING","WHERE","LIMIT","VALUES","SET"],s=n.map(function(e){return e+" "}),l=(s=(s=s.concat(n.map(function(e){return e+"("}))).concat(s.map(function(e){return e.toLowerCase()}))).map(function(e){return e.replace("(","[\\(]")});e=e.replace(/\((.+?)\)|"(.+?)"|'(.+?)'|`(.+?)`/gi,function(e){return e.replace(new RegExp(l.join("|"),"gi"),o)});var d=[];function u(e,t){return t}s.forEach(function(t){var n,r=0;do{if(-1!=(n=e.indexOf(t,r))){var i=t.replace(/^((\w|\s)+?)\s?\(?$/i,u);d[n]=i,r=n+i.length}}while(-1!=n)});var f=0;d.forEach(function(e,t){f>t?delete d[t]:(f=parseInt(t,10)+e.length,"JOIN"==e&&(d[t]="INNER JOIN"))});var g=l.slice(0);g=(g=g.map(function(e){return o(e)})).join("|");var h=e.split(new RegExp(l.join("|"),"i"));e=e.replace(/\((.+?)\)|"(.+?)"|'(.+?)'|`(.+?)`/gi,function(e){return e.replace(new RegExp(g,"gi"),a)}),h=h.map(function(e){return e.replace(/\((.+?)\)|"(.+?)"|'(.+?)'|`(.+?)`/gi,function(e){return e.replace(new RegExp(g,"gi"),a)})});var c=[];c.SELECT=function(e){var t=i(",",e);return t=t.filter(function(e){return""!==e}).map(function(e){return{name:e}})},c.SET=function(e){var t=i(",",e);return t=t.filter(function(e){return""!==e}).map(function(e){return{expression:e}})},c.FROM=c["DELETE FROM"]=c.UPDATE=function(e){var t=e.split(",");return(t=t.map(function(e){return r(e)})).forEach(function(e,n){""===e&&t.splice(n)}),t=t.map(function(e){var t=e.split(" AS "),n=t[1]||"";return 0===n.indexOf('"')&&n.lastIndexOf('"')==n.length-1&&(n=n.substring(1,n.length-1)),{table:t[0],as:n}})},c["LEFT JOIN"]=c.JOIN=c["INNER JOIN"]=c["RIGHT JOIN"]=function(e){var t=(e=e.split(" ON "))[0].split(" AS "),n={};return n.table=r(t[0]),n.as=r(t[1])||"",n.cond=r(e[1]),n},c.WHERE=function(e){return r(e)},c["ORDER BY"]=function(e){var t=[];return(e=e.split(",")).forEach(function(e,n){var i=/([A-Za-z0-9_\.]+)\s*(ASC|DESC){0,1}/gi;if(null!==(i=i.exec(e))){var o={};o.column=r(i[1]),o.order=r(i[2]),void 0===i[2]&&(o.order="ASC"),t.push(o)}}),t},c["GROUP BY"]=function(e){var t=[];return(e=e.split(",")).forEach(function(e,n){var i=/([A-Za-z0-9_\.]+)/gi;if(null!==(i=i.exec(e))){var o={};o.column=r(i[1]),t.push(o)}}),t},c.LIMIT=function(e){var t=/((\d+)\s*,\s*)?(\d+)/gi;void 0===(t=t.exec(e))[2]&&(t[2]=0);var n={};return n.nb=parseInt(r(t[3]),10),n.from=parseInt(r(t[2]),10),n},c["INSERT INTO"]=function(e){var t=/([A-Za-z0-9_\.]+)\s*(\(([A-Za-z0-9_\., ]+)\))?/gi;t=t.exec(e);var n={};return n.table=r(t[1]),void 0!==t[3]&&(n.columns=t[3].split(","),n.columns=n.columns.map(function(e){return r(e)})),n},c.VALUES=function(e){"("!=(e=r(e))[0]&&(e="("+e);var t=[];return i(",",e).forEach(function(e){e=i(",",e=e.replace(/^\(/g,"").replace(/\)$/g,"")),t.push(e)}),t};var m={},y=0;return d.forEach(function(e,t){if(e=e.toUpperCase(),y++,void 0!==c[e]){var n=c[e](h[y]);if(void 0!==m[e]){if("string"==typeof m[e]||void 0===m[e][0]){var r=m[e];m[e]=[],m[e].push(r)}m[e].push(n)}else m[e]=n}else console.log("Can't analyze statement \""+e+'"')}),void 0!==m["LEFT JOIN"]&&(void 0===m.JOIN&&(m.JOIN=[]),void 0!==m["LEFT JOIN"][0]?m["LEFT JOIN"].forEach(function(e){e.type="left",m.JOIN.push(e)}):(m["LEFT JOIN"].type="left",m.JOIN.push(m["LEFT JOIN"])),delete m["LEFT JOIN"]),void 0!==m["INNER JOIN"]&&(void 0===m.JOIN&&(m.JOIN=[]),void 0!==m["INNER JOIN"][0]?m["INNER JOIN"].forEach(function(e){e.type="inner",m.JOIN.push(e)}):(m["INNER JOIN"].type="inner",m.JOIN.push(m["INNER JOIN"])),delete m["INNER JOIN"]),void 0!==m["RIGHT JOIN"]&&(void 0===m.JOIN&&(m.JOIN=[]),void 0!==m["RIGHT JOIN"][0]?m["RIGHT JOIN"].forEach(function(e){e.type="right",m.JOIN.push(e)}):(m["RIGHT JOIN"].type="right",m.JOIN.push(m["RIGHT JOIN"])),delete m["RIGHT JOIN"]),t&&("string"==typeof m.WHERE&&(m.WHERE=p.parse(m.WHERE)),void 0!==m.JOIN&&m.JOIN.forEach(function(e,t){m.JOIN[t].cond=p.parse(e.cond)})),m},s.prototype={constructor:s,readNextChar:function(){"string"!=typeof this.source?this.currentChar="":this.currentChar=this.source[this.cursor++]||""},readNextToken:function(){return/#/.test(this.currentChar)?this.readWord():/\?/.test(this.currentChar)?this.readWord():/&/.test(this.currentChar)?this.readWord():/\|/.test(this.currentChar)?this.readWord():/\w/.test(this.currentChar)?this.readWord():/["'`]/.test(this.currentChar)?this.readString():/[()]/.test(this.currentChar)?this.readGroupSymbol():/[!=<>-]/.test(this.currentChar)?this.readOperator():""===this.currentChar?{type:"eot",value:""}:(this.readNextChar(),{type:"empty",value:""})},readWord:function(){for(var e="",t=0,n=!1;/./.test(this.currentChar);){if(!n&&/['"`]/.test(this.currentChar))n=this.currentChar;else if(n&&this.currentChar==n)n=!1;else{if(!n){if(")"==this.currentChar&&t<=0)break;if("("==this.currentChar?t++:")"==this.currentChar&&t--,/[!=<>]/.test(this.currentChar))break}if(" "==this.currentChar&&t<=0)break}e+=this.currentChar,this.readNextChar()}return/^(\&\&|\|\|)$/i.test(e)?{type:"logic",value:"&&"==e?"AND":"OR"}:/^(AND|OR)$/i.test(e)?{type:"logic",value:e}:/^(IN|IS|NOT|LIKE|Start-With|End-With|Contains|Is-Null|Is-Not-Null)$/i.test(e)?{type:"operator",value:e}:{type:"word",value:e}},readString:function(){var e="",t=this.currentChar;for(e+=this.currentChar,this.readNextChar();this.currentChar!=t&&""!==this.currentChar;)e+=this.currentChar,this.readNextChar();return e+=this.currentChar,this.readNextChar(),"."==this.currentChar?(e+=this.currentChar,this.readNextChar(),{type:"word",value:e+=this.readString().value}):{type:"string",value:e}},readGroupSymbol:function(){var e=this.currentChar;return this.readNextChar(),{type:"group",value:e}},readOperator:function(){var e=this.currentChar;return this.readNextChar(),/[=<>]/.test(this.currentChar)&&(e+=this.currentChar,this.readNextChar()),{type:"operator",value:e}}},s.tokenize=function(e){var t=new s(e),n=[];do{var r=t.readNextToken();"empty"!=r.type&&n.push(r)}while(t.currentChar);return n},p.prototype={constructor:p,readNextToken:function(){for(this.currentToken=this.lexer.readNextToken();"empty"==this.currentToken.type;)this.currentToken=this.lexer.readNextToken();return this.currentToken},parseExpressionsRecursively:function(){return this.parseLogicalExpression()},parseLogicalExpression:function(){for(var e=this.parseConditionExpression();"logic"==this.currentToken.type;){var t=this.currentToken.value;this.readNextToken();var n=this.parseConditionExpression();if(void 0!==e.logic&&e.logic==t&&void 0!==e.terms)e.terms.push(n);else e={logic:t,terms:[e,n].slice(0)}}return e},parseConditionExpression:function(){var e=this.parseBaseExpression();if("operator"==this.currentToken.type){var t=this.currentToken.value;this.readNextToken(),"operator"==this.currentToken.type&&(t+=" "+this.currentToken.value,this.readNextToken()),e={operator:t,left:e,right:this.parseBaseExpression()}}return e},parseBaseExpression:function(){var e="";return"word"==this.currentToken.type||"string"==this.currentToken.type?(e=this.currentToken.value,this.readNextToken()):"group"==this.currentToken.type&&(this.readNextToken(),e=this.parseExpressionsRecursively(),this.readNextToken()),e}},p.parse=function(e){return new p(e).parseExpressionsRecursively()},n.ast2sql=function(e){function t(e){return void 0!==e.WHERE?" WHERE "+l(e.WHERE):""}return void 0!==e.SELECT&&void 0!==e.FROM?function(e){return void 0!==e.SELECT?"SELECT "+e.SELECT.map(function(e){return e.name}).join(", "):""}(e)+function(e){if(void 0!==e.FROM){var t=" FROM ";return t+=e.FROM.map(function(e){var t=e.table;return""!==e.as&&(t+=" AS "+e.as),t}).join(", ")}return""}(e)+function(e){if(void 0!==e.JOIN){var t="";return e.JOIN.forEach(function(e){t+=" "+e.type.toUpperCase()+" JOIN "+e.table,""!==e.as&&(t+=" AS "+e.as),t+=" ON "+l(e.cond)}),t}return""}(e)+t(e)+function(e){if(void 0!==e["GROUP BY"]){var t=" GROUP BY ";return t+=e["GROUP BY"].map(function(e){return e.column}).join(", ")}return""}(e)+function(e){if(void 0!==e["ORDER BY"]){var t=" ORDER BY ";return t+=e["ORDER BY"].map(function(e){return e.column+" "+e.order}).join(", ")}return""}(e)+function(e){if(void 0!==e.LIMIT&&void 0!==e.LIMIT.nb&&parseInt(e.LIMIT.nb,10)>0){var t=" LIMIT ";return void 0!==e.LIMIT.from&&parseInt(e.LIMIT.from,10)>1&&(t+=e.LIMIT.from+","),t+=e.LIMIT.nb}return""}(e):void 0!==e["INSERT INTO"]?function(e){if(void 0!==e["INSERT INTO"]){var t="INSERT INTO "+e["INSERT INTO"].table;return void 0!==e["INSERT INTO"].columns&&(t+=" (",t+=e["INSERT INTO"].columns.join(", "),t+=")"),t}return""}(e)+function(e){if(void 0!==e.VALUES){var t=" VALUES ";return t+=e.VALUES.map(function(e){return"("+e.join(", ")+")"}).join(", ")}return""}(e):void 0!==e.UPDATE?function(e){if(void 0!==e.UPDATE){var t="UPDATE ";return t+=e.UPDATE.map(function(e){var t=e.table;return""!==e.as&&(t+=" AS "+e.as),t}).join(", ")}return""}(e)+function(e){return void 0!==e.SET?" SET "+e.SET.map(function(e){return e.expression}).join(", "):""}(e)+t(e):void 0!==e["DELETE FROM"]?function(e){if(void 0!==e["DELETE FROM"]){var t="DELETE FROM ";return t+=e["DELETE FROM"].map(function(e){var t=e.table;return""!==e.as&&(t+=" AS "+e.as),t}).join(", ")}return""}(e)+t(e):null},t.exports=n=p},{}],29:[function(require,module,exports){"use strict";var _SQLKeyWordsMap$proto;function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function SQLKeyWordsMap(keywords){var Map=function(e){this.json=e};Map.prototype={get:function get(name){return eval("this.json."+name)}},this.keywords=new Map(keywords)}module.exports=exports=function(e){return new SQLKeyWordsMap(e)},SQLKeyWordsMap.prototype=(_SQLKeyWordsMap$proto={getKeyWord:function(e){return this.keywords.get(e)},getFunction:function(e){return this.keywords.get(e)},getJDBCDriver:function(){return this.keywords.get("JDBC_Driver")},getJDBCURL:function(){return this.keywords.get("JDBC_URL")},getJDBCParams:function(){return this.keywords.get("JDBC_URL_Params")},getTypeBoolean:function(){return this.keywords.get("Type_Boolean")},getTypeDate:function(){return this.keywords.get("Type_Date")},getTypeDateTime:function(){return this.keywords.get("Type_DateTime")},getTypeDouble:function(){return this.keywords.get("Type_Double")},getTypeFloat:function(){return this.keywords.get("Type_Float")},getTypeDecimal:function(){return this.keywords.get("Type_Decimal")},getTypeInteger:function(){return this.keywords.get("Type_Integer")},getTypeId:function(){return this.keywords.get("Type_Id")},getTypeLong:function(){return this.keywords.get("Type_Long")},getTypeShort:function(){return this.keywords.get("Type_Short")},getTypeString:function(){return this.keywords.get("Type_String")},getTypeText:function(){return this.keywords.get("Type_Text")},getTypeTime:function(){return this.keywords.get("Type_Time")},getTypeTimeStamp:function(){return this.keywords.get("Type_TimeStamp")},getTypeJSON:function(){return this.keywords.get("Type_JSON")},getSQLCreateTable:function(){return this.keywords.get("CreateTable")},getSQLCreateIndex:function(){return this.keywords.get("CreateIndex")},getSQLAlterTable:function(){return this.keywords.get("AlterTable")},getSQLAdd:function(){return this.keywords.get("Add")},getSQLConstraint:function(){return this.keywords.get("Constraint")},getSQLPK:function(){return" PK"},getSQLFK:function(){return" FK"},getSQLIndex:function(){return" IDX"},getSQLPrimaryKey:function(){return this.keywords.get("PrimaryKey")},getSQLForeignKey:function(){return this.keywords.get("ForeignKey")},getSQLReferences:function(){return this.keywords.get("References")},getSQLUnique:function(){return this.keywords.get("Unique")},getSQLCreateTableColumnsBlockStart:function(){return this.keywords.get("ColumnsBlockStart")},getSQLCreateTableColumnsBlockEnd:function(){return this.keywords.get("ColumnsBlockEnd")},getSQLOnDelete:function(){return this.keywords.get("OnDelete")},getSQLOnUpdate:function(){return this.keywords.get("OnUpdate")},getSQLNoAction:function(){return this.keywords.get("NoAction")},getSQLRestrict:function(){return this.keywords.get("Restrict")},getSQLSetNull:function(){return this.keywords.get("SetNull")},getSQLCascade:function(){return this.keywords.get("Cascade")},getSQLDefault:function(){return this.keywords.get("Default")},getSQLNotNull:function(){return this.keywords.get("NotNull")},getNullableConstraint:function(e,t){return t.getNullable()&&!e.isPK(t)?"":this.getSQLNotNull()},getIdentityColumnIncrement:function(e){return this.keywords.get("PrimaryKeyIncrement")},getCurrentDate:function(){return this.keywords.get("CurrentDate")},getCurrentTime:function(){return this.keywords.get("CurrentTime")},getCurrentTimeStamp:function(){return this.keywords.get("CurrentTimeStamp")},getDateTime:function(){return this.keywords.get("DateTime")},getSQLInsert:function(){return this.keywords.get("Insert")},getSQLUpdate:function(){return this.keywords.get("Update")},getSQLDelete:function(){return this.keywords.get("Delete")},getSQLValues:function(){return this.keywords.get("Values")},getSQLSet:function(){return this.keywords.get("Set")},getSQLSelect:function(){return this.keywords.get("Select")},getSQLCount:function(){return this.keywords.get("Count")},getSQLFrom:function(){return this.keywords.get("From")},getSQLAs:function(){return this.keywords.get("As")},getSQLLeftOuterJoin:function(){return this.keywords.get("LeftJoin")},getSQLInnerJoin:function(){return this.keywords.get("InnerJoin")},getSQLWhere:function(){return this.keywords.get("Where")},getSQLOrderBy:function(){return this.keywords.get("OrderBy")},getSQLOrderByASC:function(){return this.keywords.get("Asc")},getSQLOrderByDESC:function(){return this.keywords.get("Desc")},getSQLOn:function(){return this.keywords.get("On")},getSQLAnd:function(){return this.keywords.get("And")},getSQLOr:function(){return this.keywords.get("Or")},getSQLNotIn:function(){return this.keywords.get("Not")},getSQLIn:function(){return this.keywords.get("In")},getSQLDistinct:function(){return this.keywords.get("Distinct")},getSelectColumnSep:function(){return this.keywords.get("ColumnSeperator")},getIsNull:function(){return this.keywords.get("IsNull")},getIsNotNull:function(){return this.keywords.get("IsNotNull")},getRowLimitHeader:function(){return this.keywords.get("RowLimitHeader")},getRowLimitTail:function(){return this.keywords.get("RowLimitTail")},getSupportForeignKey:function getSupportForeignKey(){return eval(this.keywords.get("Support_ForeignKey"))},getSupportConstraintName:function getSupportConstraintName(){return eval(this.keywords.get("Support_ConstraintName"))},getTablePrefix:function(){return"T"},getLocaleTablePrefix:function(){return"LT"}},_defineProperty(_SQLKeyWordsMap$proto,"getLocaleTablePrefix",function(e){return"LT"+this.getLevelMark()+e.toUpperCase()}),_defineProperty(_SQLKeyWordsMap$proto,"getLocaleTablePrefix",function(e,t){return"LT"+this.getLevelMark()+t+this.getLevelMark()+e.toUpperCase()}),_defineProperty(_SQLKeyWordsMap$proto,"getRefTablePrefix",function(){return"RT"}),_defineProperty(_SQLKeyWordsMap$proto,"getInvRefTablePrefix",function(){return"IT"}),_defineProperty(_SQLKeyWordsMap$proto,"getRefTablePostfix",function(){return"_REF"}),_defineProperty(_SQLKeyWordsMap$proto,"getLevelMark",function(){return"_"}),_defineProperty(_SQLKeyWordsMap$proto,"getReferenceModelName",function(e,t){return t?e.getInvStorageName().toUpperCase():e.getStorageName().toUpperCase()}),_defineProperty(_SQLKeyWordsMap$proto,"getPropertyModelName",function(e){return e.getStorageName().toUpperCase()}),_defineProperty(_SQLKeyWordsMap$proto,"getTableName",function(e){return e.getStorageName().toUpperCase()}),_defineProperty(_SQLKeyWordsMap$proto,"getTableName2",function(e,t){return e.getStorageName()+this.getSQLAs()+t}),_defineProperty(_SQLKeyWordsMap$proto,"getFKColumnName",function(e,t,n,r){var i=this.getFunction("GetFKColumnName");if(i){var o=i(e,t,n,r,this);if(o)return o}return this.getReferenceModelName(e)+"_"+this.getTableName(t)+"_"+this.getPropertyModelName(n)}),_defineProperty(_SQLKeyWordsMap$proto,"getFKValue",function(e,t){var n=this.getFunction("GetFKValue");if(n){var r=n(e,t);if(r)return r}return e}),_defineProperty(_SQLKeyWordsMap$proto,"getFKColumnName2",function(e,t,n,r){var i=this.getFunction("GetFKColumnName2");if(i){var o=i(e,t,n,r,this);if(o)return o}return n?this.getReferenceModelName(e)+"_"+e.getRefOwnerEnt().getStorageName()+"_"+this.getPropertyModelName(t):this.getReferenceModelName(e)+"_"+e.getForeignEnt().getStorageName()+"_"+this.getPropertyModelName(t)}),_defineProperty(_SQLKeyWordsMap$proto,"getFKValue2",function(e,t){var n=this.getFunction("GetFKValue2");if(n){var r=n(e,t);if(r)return r}return e}),_defineProperty(_SQLKeyWordsMap$proto,"getCastForAggr",function(e,t){var n=this.getFunction("GetCastForAggr");if(n){var r=n(e,t);if(r)return r}return e}),_defineProperty(_SQLKeyWordsMap$proto,"getCastValue",function getCastValue(type,value,defVal){var f=this.getFunction("GetCastValue");if(f){var v=f(type,value,defVal);return v}return"Integer"==type||"Short"==type||"Id"==type||"Long"==type||"Decimal"==type||"Float"==type||"Double"==type?value:"Boolean"==type?"?"==value?"?":eval(value)?this.getTrueValue():this.getFalseValue():"?"==value?"?":"'"+value+"'"}),_defineProperty(_SQLKeyWordsMap$proto,"getInvFKColumnName",function(e,t,n){return this.getReferenceModelName(e)+"_"+this.getTableName(t)+"_"+this.getPropertyModelName(n)}),_defineProperty(_SQLKeyWordsMap$proto,"getLTTableName",function(e){return this.getTableName(e.getRefOwnerEnt())+"_"+this.getReferenceModelName(e)+"_"+this.getReferenceLinkTablePostix()}),_defineProperty(_SQLKeyWordsMap$proto,"getReferenceLinkTablePostix",function(){return"REF"}),_defineProperty(_SQLKeyWordsMap$proto,"getReferenceLinkTablePrimaryKey",function(){return"SID"}),_defineProperty(_SQLKeyWordsMap$proto,"getLocaleTablePostix",function(){return"LOC"}),_defineProperty(_SQLKeyWordsMap$proto,"getFKName",function(e,t){return"FK_"+this.getTableName(e)+"_"+this.getReferenceModelName(t)}),_defineProperty(_SQLKeyWordsMap$proto,"getFKName2",function(e,t,n){return"FK_"+this.getTableName(t)+"_"+this.getTableName(e)+"_"+this.getReferenceModelName(n)}),_defineProperty(_SQLKeyWordsMap$proto,"getLTColumnName",function(e,t){return this.getTableName(e)+"_"+this.getPropertyModelName(t)}),_defineProperty(_SQLKeyWordsMap$proto,"getPropertyColumnNameAs",function(e,t,n){return n+"."+e.getStorageName()+this.getSQLAs()+n+this.getLevelMark()+e.getStorageName()}),_defineProperty(_SQLKeyWordsMap$proto,"getPropertyColumnNameParam",function(e,t,n){return n+"."+e.getStorageName()+"=?"}),_defineProperty(_SQLKeyWordsMap$proto,"toTableShortNameByCount",function(e){return this.getTablePrefix()+this.getLevelMark()+e}),_defineProperty(_SQLKeyWordsMap$proto,"toRefTableShortNameByCount",function(e){return this.getRefTablePrefix()+this.getLevelMark()+e}),_defineProperty(_SQLKeyWordsMap$proto,"toInvRefTableShortNameByCount",function(e){return this.getInvRefTablePrefix()+this.getLevelMark()+e}),_defineProperty(_SQLKeyWordsMap$proto,"getRowNumColumn",function(){return this.keywords.get("RowNumColumn")}),_defineProperty(_SQLKeyWordsMap$proto,"getPagingSQLHeader",function(){return this.keywords.get("PagingSQLHeader")}),_defineProperty(_SQLKeyWordsMap$proto,"getPagingSQLTail",function(){return this.keywords.get("PagingSQLTail")}),_defineProperty(_SQLKeyWordsMap$proto,"getSQLDropTable",function(){return this.keywords.get("DropTable")}),_defineProperty(_SQLKeyWordsMap$proto,"getSQLDropIndex",function(){return this.keywords.get("DropIndex")}),_defineProperty(_SQLKeyWordsMap$proto,"getSQLIfExists",function(){return this.keywords.get("IfExists")}),_defineProperty(_SQLKeyWordsMap$proto,"getSQLGroupby",function(){return this.keywords.get("Groupby")}),_defineProperty(_SQLKeyWordsMap$proto,"getTrueValue",function(){return this.keywords.get("TrueValue")}),_defineProperty(_SQLKeyWordsMap$proto,"getFalseValue",function(){return this.keywords.get("FalseValue")}),_defineProperty(_SQLKeyWordsMap$proto,"getSQLCreateSchema",function(){return this.keywords.get("CreateSchema")}),_defineProperty(_SQLKeyWordsMap$proto,"getSQLChooseSchema",function(){return this.keywords.get("ChooseSchema")}),_defineProperty(_SQLKeyWordsMap$proto,"getSQLChooseSchemaEnd",function(){return this.keywords.get("ChooseSchemaEnd")}),_SQLKeyWordsMap$proto)},{}],30:[function(e,t,n){"use strict";t.exports={sqliteMap:e("./sqliteMap.js"),pgSQLMap:e("./pgSQLMap.js"),pgNoSQLMap:e("./pgNoSQLMap.js"),mysqlMap:e("./mysqlMap.js"),SQLKeyWordsMap:e("./SQLKeyWordsMap.js")}},{"./SQLKeyWordsMap.js":29,"./mysqlMap.js":31,"./pgNoSQLMap.js":32,"./pgSQLMap.js":33,"./sqliteMap.js":34}],31:[function(e,t,n){"use strict";t.exports={NodeJS_Module_Name:"mysql",JDBC_Driver:"com.mysql.jdbc.Driver",JDBC_URL:"jdbc:mysql://localhost:3306/",JDBC_URL_Params:"createDatabaseIfNotExist=true",Support_ForeignKey:"true",Type_Boolean:" SMALLINT",Type_Date:" DATE",Type_DateTime:" DateTime",Type_Double:" DOUBLE",Type_Float:" FLOAT",Type_Decimal:" DECIMAL",Type_Integer:" INT",Type_Id:" BIGINT",Type_FKId:" BIGINT",Type_Long:" BIGINT",Type_Short:" SMALLINT",Type_String:" VARCHAR",Type_Text:" LONG VARCHAR",Type_Time:" TIME",Type_TimeStamp:" TIMESTAMP",CreateTable:"CREATE TABLE ",CreateIndex:"CREATE INDEX ",AlterTable:"ALTER TABLE ",Add:" ADD ",Constraint:" CONSTRAINT ",PrimaryKey:" PRIMARY KEY ",ForeignKey:" FOREIGN KEY ",References:" REFERENCES ",Unique:" UNIQUE",ColumnsBlockStart:"(",ColumnsBlockEnd:") ENGINE=InnoDB ",OnDelete:" ON DELETE",OnUpdate:" ON UPDATE",NoAction:" NO ACTION ",Restrict:" RESTRICT ",SetNull:" SET NULL ",Cascade:" CASCADE ",Default:" DEFAULT ",NotNull:" NOT NULL",Increment:" AUTO_INCREMENT ",PrimaryKeyIncrement:" AUTO_INCREMENT ",CurrentDate:" CURRENT_DATE ",CurrentTime:" CURRENT_TIME ",CurrentTimeStamp:" CURRENT_TIMESTAMP ",DateTime:" DATETIME ",Insert:"INSERT INTO ",Update:"UPDATE ",Delete:"DELETE FROM ",Values:"VALUES ",Set:" SET ",Select:"SELECT ",Count:"COUNT",From:" FROM ",As:" AS ",LeftJoin:" LEFT OUTER JOIN ",InnerJoin:" INNER JOIN ",Where:" WHERE ",OrderBy:" ORDER BY ",Asc:" ASC ",Desc:" DESC ",On:" ON ",And:" AND ",Or:" OR ",Not:" NOT IN ",In:" IN ",Distinct:" DISTINCT ",ColumnSeperator:",",IsNull:" IS NULL ",IsNotNull:" IS NOT NULL ",RowNumColumn:"",PagingSQLHeader:"",PagingSQLTail:" LIMIT %SIZE% OFFSET %FROM%",DropTable:"drop table ",DropIndex:"drop index ",IfExists:" if exists ",FK_Check:!0,Enable_FK_Check:"SET foreign_key_checks = 1",Disable_FK_Check:"SET foreign_key_checks = 0",NeedSchema:!0,CreateSchema:"CREATE SCHEMA IF NOT EXISTS  ",ChooseSchema:"USE  ",ChooseSchemaEnd:" ",Groupby:" GROUP BY "}},{}],32:[function(require,module,exports){"use strict";module.exports={Language:["JSP"],NodeJS_Module_Name:"",JDBC_Driver:"org.postgresql.Driver",JDBC_URL:"jdbc:postgresql://localhost:5432/",JDBC_URL_Params:"createDatabaseIfNotExist=true",Support_ForeignKey:"false",Support_ConstraintName:"true",Type_Boolean:" BOOLEAN",Type_Date:" DATE",Type_DateTime:" TIMESTAMP",Type_Double:" DOUBLE PRECISION",Type_Float:" FLOAT",Type_Decimal:" DECIMAL",Type_Integer:" INT",Type_Id:" BIGSERIAL",Type_FKId:" BIGINT",Type_Long:" BIGINT",Type_Short:" SMALLINT",Type_String:" VARCHAR",Type_Text:" TEXT",Type_Time:" TIME",Type_TimeStamp:" TIMESTAMP",Type_JSON:" JSON",CreateTable:"CREATE TABLE IF NOT EXISTS ",CreateIndex:"CREATE INDEX ",AlterTable:"ALTER TABLE ",Add:" ADD ",Constraint:" CONSTRAINT ",PrimaryKey:" PRIMARY KEY ",ForeignKey:" FOREIGN KEY ",References:" REFERENCES ",Unique:" UNIQUE",ColumnsBlockStart:"(",ColumnsBlockEnd:")  ",OnDelete:" ON DELETE",OnUpdate:" ON UPDATE",NoAction:" NO ACTION ",Restrict:" RESTRICT ",SetNull:" SET NULL ",Cascade:" CASCADE ",Default:" DEFAULT ",NotNull:" NOT NULL",Increment:"",PrimaryKeyIncrement:" ",CurrentDate:" CURRENT_DATE ",CurrentTime:" CURRENT_TIME ",CurrentTimeStamp:" CURRENT_TIMESTAMP ",DateTime:" DATETIME ",Insert:"INSERT INTO ",Update:"UPDATE ",Delete:"DELETE FROM ",Values:"VALUES ",Set:" SET ",Select:"SELECT ",Count:"COUNT",From:" FROM ",As:" AS ",LeftJoin:" LEFT OUTER JOIN ",InnerJoin:" INNER JOIN ",Where:" WHERE ",OrderBy:" ORDER BY ",Asc:" ASC ",Desc:" DESC ",On:" ON ",And:" AND ",Or:" OR ",Not:" NOT IN ",In:" IN ",Distinct:" DISTINCT ",ColumnSeperator:",",IsNull:" IS NULL ",IsNotNull:" IS NOT NULL ",RowNumColumn:"",PagingSQLHeader:"",PagingSQLTail:" LIMIT %SIZE% OFFSET %FROM%",DropTable:"drop table ",DropIndex:"drop index ",IfExists:" if exists ",FK_Check:!1,Enable_FK_Check:"",Disable_FK_Check:"",DROP_CASCADE:" CASCADE",Groupby:" GROUP BY ",NotAllowTextDefaultValue:!0,TrueValue:"TRUE",FalseValue:"FALSE",DatabaeInit:["CREATE EXTENSION IF NOT EXISTS HSTORE;"],NoSQL:"true",NoSQL_DataType:"HSTORE",NeedSchema:!0,CreateSchema:"CREATE SCHEMA IF NOT EXISTS  ",ChooseSchema:"SET SEARCH_PATH TO  ",ChooseSchemaEnd:" ,public ",UseNumberAsParam:"true",NoSQL_ColumnName:"DT",NoSQL_TextColumnName:"TextDT",GenerateInsertCommand:function(e,t,n,r,i,o){if(!o){for(var a=t.split(","),s=n.split(","),p=[],l=0;l<a.length;l++)p.push("'"+a[l].toUpperCase()+"',"+s[l]);var d=[];if(r.length>0){var u=r.split(","),f=i.split(",");for(l=0;l<u.length;l++)d.push("'"+u[l].toUpperCase()+"',"+f[l])}if(0==r.length)return"INSERT INTO "+e+" (DT) VALUES (HSTORE(ARRAY["+p.join(",")+"])) RETURNING "+e+"Id ";if(0==t.length&&0!=r.length)return"INSERT INTO "+e+" (TextDT) VALUES (HSTORE(ARRAY["+d.join(",")+"])) RETURNING "+e+"Id ";if(0!=t.length&&0!=r.length)return"INSERT INTO "+e+" (DT, TextDT) VALUES (HSTORE(ARRAY["+p.join(",")+"]), HSTORE(ARRAY["+d.join(",")+"])) RETURNING "+e+"Id "}return!1},GenerateUpdateCommand:function(e,t,n,r){var i=[],o=null;if(t&&t.length>0){o=t.split(",");for(var a=0;a<o.length;a++){var s=o[a].split("=");i.push("'"+s[0].trim().toUpperCase()+"',CAST("+s[1].trim()+" as TEXT)")}}if(r&&0!=r.length){var p=r.split(","),l=[];for(a=0;a<p.length;a++){s=p[a].split("=");l.push("'"+s[0].trim().toUpperCase()+"',CAST("+s[1].trim()+" as TEXT)")}return t&&0!=t.length?"UPDATE "+e+" SET DT = DT || HSTORE(ARRAY["+i.join(",")+"]), TextDT = TextDT || HSTORE(ARRAY["+l.join(",")+"])  "+n:"UPDATE "+e+" SET TextDT = TextDT || HSTORE(ARRAY["+l.join(",")+"]) "+n}return"UPDATE "+e+" SET DT = DT || HSTORE(ARRAY["+i.join(",")+"]) "+n},GetRefOperator:function(e,t,n,r){return tableName=e?e+".":"",t?"Id"==t.getPropType()?"("+(tableName+n).toUpperCase()+")::BIGINT":r?"Long"==t.getPropType()?"("+tableName+"DT->'"+n.toUpperCase()+"')::BIGINT":"Integer"==t.getPropType()?"("+tableName+"DT->'"+n.toUpperCase()+"')::INT":"Text"==t.getPropType()?"("+tableName+"TextDT->'"+n.toUpperCase()+"')":tableName+"DT->'"+n.toUpperCase()+"'":"Text"==t.getPropType()?tableName+"TextDT->'"+n.toUpperCase()+"'":tableName+"DT->'"+n.toUpperCase()+"'":tableName+"DT->'"+n.toUpperCase()+"'"},GetFKColumnName:function(e,t,n,r,i){return 0!=r&&"DT->'"+(i.getReferenceModelName(e)+"_"+i.getTableName(t)+"_"+i.getPropertyModelName(n)).toUpperCase()+"'"},GetFKValue:function(e,t){return!1},GetFKColumnName2:function(e,t,n,r,i){return 0!=r&&(n?"DT->'"+(i.getReferenceModelName(e)+"_"+e.getRefOwnerEnt().getStorageName()+"_"+i.getPropertyModelName(t)).toUpperCase()+"'":"DT->'"+(i.getReferenceModelName(e)+"_"+e.getForeignEnt().getStorageName()+"_"+i.getPropertyModelName(t)).toUpperCase()+"'")},GetFKValue2:function(e,t){return!1},GetCastForAggr:function(e,t){return"Id"==t?("("+e+")::BIGINT").toUpperCase():"String"==t?("("+e+")::TEXT").toUpperCase():("("+e+")::"+t).toUpperCase()},GetCastValue:function GetCastValue(type,value,defVal){return"Integer"==type||"Short"==type||"Long"==type||"Decimal"==type||"Float"==type||"Double"==type?"CAST("+value+" as TEXT)":"Id"==type?value:"Boolean"==type?defVal?"CAST("+(eval(value)?"TRUE":"FALSE")+" as TEXT)":"CAST("+value+" as TEXT)":"Date"==type||"DateTime"==type||"Time"==type||"TimeStamp"==type?defVal?"CAST('"+value+"' as TEXT)":"CAST("+value+" as TEXT)":defVal?"'"+value+"'":"CAST("+value+" as TEXT)"},CreateNoSQLIndex:function(e,t){return["CREATE INDEX "+e+"_DT_Idx ON "+e+" USING gin(DT);"]}}},{}],33:[function(e,t,n){"use strict";t.exports={Language:["JSP"],NodeJS_Module_Name:"",JDBC_Driver:"org.postgresql.Driver",JDBC_URL:"jdbc:postgresql://localhost:5432/",JDBC_URL_Params:"createDatabaseIfNotExist=true",Support_ForeignKey:"true",Support_ConstraintName:"true",Type_Boolean:" BOOLEAN",Type_Date:" DATE",Type_DateTime:" TIMESTAMP without time zone",Type_Double:" DOUBLE PRECISION",Type_Float:" FLOAT",Type_Decimal:" DECIMAL",Type_Integer:" INT",Type_Id:" BIGSERIAL",Type_FKId:" BIGINT",Type_Long:" BIGINT",Type_Short:" SMALLINT",Type_String:" VARCHAR",Type_Text:" TEXT",Type_Time:" TIME",Type_TimeStamp:" TIMESTAMP",Type_JSON:" JSON",CreateTable:"CREATE TABLE IF NOT EXISTS ",CreateIndex:"CREATE INDEX ",AlterTable:"ALTER TABLE ",Add:" ADD ",Constraint:" CONSTRAINT ",PrimaryKey:" PRIMARY KEY ",ForeignKey:" FOREIGN KEY ",References:" REFERENCES ",Unique:" UNIQUE",ColumnsBlockStart:"(",ColumnsBlockEnd:")  ",OnDelete:" ON DELETE",OnUpdate:" ON UPDATE",NoAction:" NO ACTION ",Restrict:" RESTRICT ",SetNull:" SET NULL ",Cascade:" CASCADE ",Default:" DEFAULT ",NotNull:" NOT NULL",Increment:"",PrimaryKeyIncrement:" ",CurrentDate:" CURRENT_DATE ",CurrentTime:" CURRENT_TIME ",CurrentTimeStamp:" CURRENT_TIMESTAMP ",DateTime:" DATETIME ",Insert:"INSERT INTO ",Update:"UPDATE ",Delete:"DELETE FROM ",Values:"VALUES ",Set:" SET ",Select:"SELECT ",Count:"COUNT",From:" FROM ",As:" AS ",LeftJoin:" LEFT OUTER JOIN ",InnerJoin:" INNER JOIN ",Where:" WHERE ",OrderBy:" ORDER BY ",Asc:" ASC ",Desc:" DESC ",On:" ON ",And:" AND ",Or:" OR ",Not:" NOT IN ",In:" IN ",Distinct:" DISTINCT ",ColumnSeperator:",",IsNull:" IS NULL ",IsNotNull:" IS NOT NULL ",RowNumColumn:"",PagingSQLHeader:"",PagingSQLTail:" LIMIT %SIZE% OFFSET %FROM%",DropTable:"drop table ",DropIndex:"drop index ",IfExists:" if exists ",FK_Check:!1,Enable_FK_Check:"",Disable_FK_Check:"",DROP_CASCADE:" CASCADE",Groupby:" GROUP BY ",NotAllowTextDefaultValue:!0,TrueValue:"TRUE",FalseValue:"FALSE",NeedSchema:!0,CreateSchema:"CREATE SCHEMA IF NOT EXISTS  ",ChooseSchema:"SET SEARCH_PATH TO  ",ChooseSchemaEnd:" ,public ",UseNumberAsParam:"true",GenerateInsertCommand:function(e,t,n,r,i,o,a){return!o&&a+" RETURNING "+e+"Id "}}},{}],34:[function(e,t,n){"use strict";t.exports={NodeJS_Module_Name:"_CP_WEBSQL",Support_ForeignKey:"false",Support_ConstraintName:"true",Type_Boolean:" SMALLINT",Type_Date:" DATE",Type_DateTime:" DateTime",Type_Double:" DOUBLE",Type_Float:" FLOAT",Type_Decimal:" DECIMAL",Type_Integer:" INT",Type_Id:" INTEGER",Type_FKId:" INTEGER",Type_Long:" BIGINT",Type_Short:" SMALLINT",Type_String:" VARCHAR",Type_Text:" LONG VARCHAR",Type_Time:" TIME",Type_TimeStamp:" TIMESTAMP",CreateTable:"CREATE TABLE ",CreateIndex:"CREATE INDEX ",AlterTable:"ALTER TABLE ",Add:" ADD ",Constraint:" CONSTRAINT ",PrimaryKey:"",ForeignKey:" FOREIGN KEY ",References:" REFERENCES ",Unique:" UNIQUE",ColumnsBlockStart:"(",ColumnsBlockEnd:") ",OnDelete:" ON DELETE",OnUpdate:" ON UPDATE",NoAction:" NO ACTION ",Restrict:" RESTRICT ",SetNull:" SET NULL ",Cascade:" CASCADE ",Default:" DEFAULT ",NotNull:" NOT NULL",Increment:" AUTOINCREMENT ",PrimaryKeyIncrement:" PRIMARY KEY AUTOINCREMENT ",CurrentDate:" CURRENT_DATE ",CurrentTime:" CURRENT_TIME ",CurrentTimeStamp:" CURRENT_TIMESTAMP ",DateTime:" DATETIME ",Insert:"INSERT INTO ",Update:"UPDATE ",Delete:"DELETE FROM ",Values:"VALUES ",Set:" SET ",Select:"SELECT ",Count:"COUNT",From:" FROM ",As:" AS ",LeftJoin:" LEFT OUTER JOIN ",InnerJoin:" INNER JOIN ",Where:" WHERE ",OrderBy:" ORDER BY ",Asc:" ASC ",Desc:" DESC ",On:" ON ",And:" AND ",Or:" OR ",Not:" NOT IN ",In:" IN ",Distinct:" DISTINCT ",ColumnSeperator:",",IsNull:" IS NULL ",IsNotNull:" IS NOT NULL ",RowNumColumn:"",PagingSQLHeader:"",PagingSQLTail:" LIMIT %SIZE% OFFSET %FROM%",DropTable:"drop table ",DropIndex:"drop index ",IfExists:" if exists ",FK_Check:!1,Enable_FK_Check:"",Disable_FK_Check:"",DROP_CASCADE:"",Groupby:" GROUP BY ",TrueValue:"1",FalseValue:"0",UseNumberAsParam:"false"}},{}]},{},[25]);